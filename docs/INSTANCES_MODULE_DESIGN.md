# å®ä¾‹ç®¡ç†æ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£

> **æ¨¡å—åç§°**: Instances Management
> **ä¼˜å…ˆçº§**: P0 (æœ€é«˜)
> **å¼€å‘å‘¨æœŸ**: Phase 2 (ç¬¬3-4å‘¨)
> **è´Ÿè´£äºº**: å¾…åˆ†é…

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ•°æ®åº“å®ä¾‹ç®¡ç†](#æ•°æ®åº“å®ä¾‹ç®¡ç†)
3. [AIæœåŠ¡å®ä¾‹ç®¡ç†](#aiæœåŠ¡å®ä¾‹ç®¡ç†)
4. [APIè®¾è®¡](#apiè®¾è®¡)
5. [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
6. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

### æ ¸å¿ƒéœ€æ±‚

å°†æ•°æ®åº“é…ç½®å’ŒAIé…ç½®è§†ä¸º**"èµ„æºå®ä¾‹"**ç»Ÿä¸€ç®¡ç†ï¼Œé‡‡ç”¨**"å…ˆæµ‹è¯•åä¿å­˜"**çš„äº¤äº’é€»è¾‘ï¼Œç¡®ä¿æ‰€æœ‰é…ç½®éƒ½æ˜¯å¯ç”¨çš„ã€‚

### å…³é”®ç‰¹æ€§

1. **å…ˆæµ‹è¯•åä¿å­˜**: åªæœ‰æµ‹è¯•è¿æ¥é€šè¿‡åï¼Œæ‰èƒ½ä¿å­˜å®ä¾‹
2. **å¯è§†åŒ–å¡ç‰‡**: ä½¿ç”¨å¡ç‰‡è€Œéè¡¨æ ¼å±•ç¤ºï¼Œæ›´ç›´è§‚
3. **å®æ—¶çŠ¶æ€**: æ˜¾ç¤ºå®ä¾‹çš„åœ¨çº¿/ç¦»çº¿çŠ¶æ€
4. **å¿«é€Ÿæ“ä½œ**: æ”¯æŒå¯ç”¨/ç¦ç”¨ã€ç¼–è¾‘ã€åˆ é™¤ç­‰æ“ä½œ

---

## ğŸ—„ï¸ æ•°æ®åº“å®ä¾‹ç®¡ç†

### 1. é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¢åŒ…å±‘: é¦–é¡µ > å®ä¾‹ç®¡ç† > æ•°æ®åº“å®ä¾‹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é¡µé¢æ ‡é¢˜                                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  ğŸ”Œ æ•°æ®åº“å®ä¾‹ç®¡ç†                                             â”‚
â”‚  ç»Ÿä¸€ç®¡ç† MySQL æ•°æ®åº“è¿æ¥ï¼Œæµ‹è¯•é€šè¿‡åå³å¯ç”¨äºç›‘æ§             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [+ æ–°å¢æ•°æ®åº“å®ä¾‹]         [ğŸ” æœç´¢å®ä¾‹åç§°ã€åœ°å€...]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ç”Ÿäº§ç¯å¢ƒä¸»åº“  â”‚  â”‚ æµ‹è¯•ç¯å¢ƒåº“   â”‚  â”‚ å¼€å‘ç¯å¢ƒåº“   â”‚        â”‚
â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚ â”â”â”â”â”â”â”â”â”â”  â”‚        â”‚
â”‚  â”‚ ğŸŸ¢ åœ¨çº¿     â”‚  â”‚ ğŸŸ¢ åœ¨çº¿     â”‚  â”‚ ğŸ”´ ç¦»çº¿     â”‚        â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚        â”‚
â”‚  â”‚ åœ°å€:        â”‚  â”‚ åœ°å€:        â”‚  â”‚ åœ°å€:        â”‚        â”‚
â”‚  â”‚ 192.168.1.100â”‚  â”‚ 192.168.1.101â”‚  â”‚ 192.168.1.102â”‚        â”‚
â”‚  â”‚ ç”¨æˆ·: root   â”‚  â”‚ ç”¨æˆ·: admin  â”‚  â”‚ ç”¨æˆ·: dev    â”‚        â”‚
â”‚  â”‚ ç¯å¢ƒ: ç”Ÿäº§   â”‚  â”‚ ç¯å¢ƒ: æµ‹è¯•   â”‚  â”‚ ç¯å¢ƒ: å¼€å‘   â”‚        â”‚
â”‚  â”‚ æœ€åéªŒè¯:    â”‚  â”‚ æœ€åéªŒè¯:    â”‚  â”‚ æœ€åéªŒè¯:    â”‚        â”‚
â”‚  â”‚ 2åˆ†é’Ÿå‰      â”‚  â”‚ 1å°æ—¶å‰      â”‚  â”‚ 3å¤©å‰        â”‚        â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚        â”‚
â”‚  â”‚ [ç¼–è¾‘] [åˆ é™¤]â”‚  â”‚ [ç¼–è¾‘] [åˆ é™¤]â”‚  â”‚ [ç¼–è¾‘] [åˆ é™¤]â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç»„ä»¶ç»“æ„

```
DatabaseInstances (é¡µé¢)
â”œâ”€ PageHeader (é¡µé¢å¤´éƒ¨)
â”œâ”€ ActionBar (æ“ä½œæ )
â”‚  â”œâ”€ PrimaryButton (æ–°å¢æŒ‰é’®)
â”‚  â””â”€ SearchInput (æœç´¢æ¡†)
â”œâ”€ InstanceGrid (å®ä¾‹ç½‘æ ¼)
â”‚  â””â”€ DatabaseInstanceCard (å®ä¾‹å¡ç‰‡) Ã— N
â”‚     â”œâ”€ CardHeader (å¡ç‰‡å¤´éƒ¨)
â”‚     â”‚  â”œâ”€ InstanceIcon (å®ä¾‹å›¾æ ‡)
â”‚     â”‚  â”œâ”€ InstanceName (å®ä¾‹åç§°)
â”‚     â”‚  â”œâ”€ StatusBadge (çŠ¶æ€å¾½ç« )
â”‚     â”‚  â””â”€ ToggleSwitch (å¯ç”¨/ç¦ç”¨å¼€å…³)
â”‚     â”œâ”€ CardBody (å¡ç‰‡å†…å®¹)
â”‚     â”‚  â”œâ”€ InfoRow (ä¿¡æ¯è¡Œ) Ã— N
â”‚     â”‚  â””â”€ LastValidated (æœ€åéªŒè¯æ—¶é—´)
â”‚     â””â”€ CardFooter (å¡ç‰‡åº•éƒ¨)
â”‚        â”œâ”€ EditButton (ç¼–è¾‘æŒ‰é’®)
â”‚        â””â”€ DeleteButton (åˆ é™¤æŒ‰é’®)
â””â”€ DatabaseInstanceDialog (æ–°å¢/ç¼–è¾‘å¯¹è¯æ¡†)
   â”œâ”€ InstanceForm (è¡¨å•)
   â”‚  â”œâ”€ NameInput (åç§°è¾“å…¥)
   â”‚  â”œâ”€ HostInput (ä¸»æœºè¾“å…¥)
   â”‚  â”œâ”€ PortInput (ç«¯å£è¾“å…¥)
   â”‚  â”œâ”€ UsernameInput (ç”¨æˆ·åè¾“å…¥)
   â”‚  â”œâ”€ PasswordInput (å¯†ç è¾“å…¥)
   â”‚  â””â”€ EnvironmentSelect (ç¯å¢ƒé€‰æ‹©)
   â”œâ”€ TestResult (æµ‹è¯•ç»“æœæ˜¾ç¤º)
   â””â”€ ActionButtons (æ“ä½œæŒ‰é’®)
      â”œâ”€ CancelButton (å–æ¶ˆæŒ‰é’®)
      â”œâ”€ TestButton (æµ‹è¯•æŒ‰é’®)
      â””â”€ SaveButton (ä¿å­˜æŒ‰é’® - é»˜è®¤ç¦ç”¨)
```

### 3. æ ¸å¿ƒäº¤äº’ï¼šå…ˆæµ‹è¯•åä¿å­˜

#### 3.1 äº¤äº’æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‚¹å‡»"æ–°å¢"  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰“å¼€è¡¨å•å¯¹è¯æ¡†          â”‚
â”‚  "ä¿å­˜"æŒ‰é’®ç½®ç°          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·å¡«å†™è¡¨å•            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‚¹å‡»"æµ‹è¯•è¿æ¥"          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµ‹è¯•æˆåŠŸ                â”‚  YES  â”‚ æ˜¾ç¤ºç»¿è‰²âœ“        â”‚
â”‚  (è¿æ¥é€šè¿‡)              â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚ å»¶è¿Ÿ: 1.2s       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ "ä¿å­˜"æŒ‰é’®é«˜äº®   â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  ç‚¹å‡»"ä¿å­˜"       â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  ä¿å­˜åˆ°æ•°æ®åº“     â”‚
                                 â”‚  åˆ·æ–°åˆ—è¡¨         â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµ‹è¯•å¤±è´¥                â”‚  NO   â”‚ æ˜¾ç¤ºçº¢è‰²âœ—        â”‚
â”‚  (è¿æ¥æ‹’ç»/è¶…æ—¶)         â”‚â”€â”€â”€â”€â”€â”€â–ºâ”‚ é”™è¯¯ä¿¡æ¯         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ "ä¿å­˜"æŒ‰é’®ä¿æŒ   â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2 çŠ¶æ€æœº

```typescript
type TestState = 'none' | 'testing' | 'success' | 'fail'

interface TestStateMachine {
  // åˆå§‹çŠ¶æ€
  none: {
    onTest: () => 'testing'
  }

  // æµ‹è¯•ä¸­
  testing: {
    onSuccess: () => 'success'
    onFail: () => 'fail'
  }

  // æµ‹è¯•æˆåŠŸ
  success: {
    onFormChange: () => 'none'  // è¡¨å•å˜åŒ–æ—¶é‡ç½®
    canSave: true
  }

  // æµ‹è¯•å¤±è´¥
  fail: {
    onTest: () => 'testing'     // å¯ä»¥é‡è¯•
    onFormChange: () => 'none'  // è¡¨å•å˜åŒ–æ—¶é‡ç½®
    canSave: false
  }
}
```

#### 3.3 ä»£ç å®ç°

```typescript
// src/composables/useDatabaseForm.ts
import { ref, reactive, watch } from 'vue'
import { ElMessage } from 'element-plus'
import { testConnection, saveInstance } from '@/api/instances'

export function useDatabaseForm(initialData?: DatabaseInstance) {
  // è¡¨å•æ•°æ®
  const form = reactive<DatabaseInstanceForm>({
    id: initialData?.id || '',
    name: initialData?.name || '',
    host: initialData?.host || 'localhost',
    port: initialData?.port || 3306,
    username: initialData?.username || '',
    password: initialData?.password || '',
    environment: initialData?.environment || 'development'
  })

  // æµ‹è¯•çŠ¶æ€
  const testState = ref<TestState>('none')
  const testLatency = ref(0)
  const testError = ref('')

  // æ˜¯å¦å¯ä»¥ä¿å­˜
  const canSave = computed(() => testState.value === 'success')

  // ç›‘å¬è¡¨å•å˜åŒ–ï¼Œé‡ç½®æµ‹è¯•çŠ¶æ€
  watch(
    () => [form.name, form.host, form.port, form.username, form.password],
    () => {
      if (testState.value === 'success' || testState.value === 'fail') {
        testState.value = 'none'
        testError.value = ''
      }
    },
    { deep: true }
  )

  // æµ‹è¯•è¿æ¥
  async function handleTest(): Promise<boolean> {
    // éªŒè¯è¡¨å•
    const valid = await validateForm(form)
    if (!valid) return false

    testState.value = 'testing'
    const startTime = Date.now()

    try {
      await testConnection({
        host: form.host,
        port: form.port,
        username: form.username,
        password: form.password
      })

      testLatency.value = Date.now() - startTime
      testState.value = 'success'
      ElMessage.success(`è¿æ¥æˆåŠŸï¼å»¶è¿Ÿ ${testLatency.value}ms`)
      return true
    } catch (error: any) {
      testState.value = 'fail'
      testError.value = error.message || 'è¿æ¥å¤±è´¥'
      ElMessage.error(testError.value)
      return false
    }
  }

  // ä¿å­˜å®ä¾‹
  async function handleSave(): Promise<void> {
    if (!canSave.value) {
      ElMessage.warning('è¯·å…ˆæµ‹è¯•è¿æ¥é€šè¿‡åå†ä¿å­˜')
      return
    }

    try {
      await saveInstance(form)
      ElMessage.success('ä¿å­˜æˆåŠŸ')
      return true
    } catch (error: any) {
      ElMessage.error('ä¿å­˜å¤±è´¥ï¼š' + error.message)
      return false
    }
  }

  return {
    form,
    testState,
    testLatency,
    testError,
    canSave,
    handleTest,
    handleSave
  }
}
```

### 4. ç»„ä»¶è¯¦ç»†è®¾è®¡

#### 4.1 DatabaseInstanceCard

```vue
<template>
  <div
    class="database-instance-card modern-card"
    :class="{ 'is-disabled': !instance.isEnabled }"
  >
    <!-- å¡ç‰‡å¤´éƒ¨ - æ¸å˜èƒŒæ™¯ -->
    <div class="card-header gradient-primary">
      <div class="header-left">
        <el-icon class="instance-icon" :size="32">
          <Database />
        </el-icon>
        <div class="instance-info">
          <h3 class="instance-name">{{ instance.name }}</h3>
          <div class="instance-meta">
            <el-tag
              :type="instance.isEnabled ? 'success' : 'info'"
              size="small"
              effect="dark"
            >
              {{ instance.isEnabled ? 'åœ¨çº¿' : 'ç¦»çº¿' }}
            </el-tag>
            <el-tag
              v-if="instance.isDefault"
              type="warning"
              size="small"
              effect="dark"
            >
              é»˜è®¤
            </el-tag>
            <el-tag
              :type="getEnvironmentTagType(instance.environment)"
              size="small"
            >
              {{ getEnvironmentLabel(instance.environment) }}
            </el-tag>
          </div>
        </div>
      </div>
      <div class="header-right">
        <el-switch
          v-model="instance.isEnabled"
          :loading="instance._toggling"
          @change="handleToggle"
        />
      </div>
    </div>

    <!-- å¡ç‰‡å†…å®¹ -->
    <div class="card-body">
      <div class="info-row">
        <el-icon class="row-icon"><Link /></el-icon>
        <span class="row-label">åœ°å€:</span>
        <span class="row-value">{{ instance.host }}:{{ instance.port }}</span>
      </div>
      <div class="info-row">
        <el-icon class="row-icon"><User /></el-icon>
        <span class="row-label">ç”¨æˆ·:</span>
        <span class="row-value">{{ instance.username }}</span>
      </div>
      <div class="info-row" v-if="instance.database">
        <el-icon class="row-icon"><Files /></el-icon>
        <span class="row-label">æ•°æ®åº“:</span>
        <span class="row-value">{{ instance.database }}</span>
      </div>

      <!-- éªŒè¯çŠ¶æ€ -->
      <div class="validation-status">
        <el-icon
          v-if="instance.lastValidatedAt"
          :color="isValidated ? '#10B981' : '#9CA3AF'"
          :size="16"
        >
          <CircleCheck v-if="isValidated" />
          <Clock v-else />
        </el-icon>
        <span class="validate-text">
          {{ validationText }}
        </span>
      </div>
    </div>

    <!-- å¡ç‰‡åº•éƒ¨ -->
    <div class="card-footer">
      <el-button
        link
        type="primary"
        @click="handleEdit"
        :icon="Edit"
      >
        ç¼–è¾‘
      </el-button>
      <el-button
        link
        type="danger"
        @click="handleDelete"
        :icon="Delete"
      >
        åˆ é™¤
      </el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import {
  Database,
  Link,
  User,
  Files,
  CircleCheck,
  Clock,
  Edit,
  Delete
} from '@element-plus/icons-vue'
import { formatDistanceToNow } from '@/utils/date'

interface DatabaseInstance {
  id: string
  name: string
  host: string
  port: number
  username: string
  password: string
  database?: string
  environment: 'production' | 'testing' | 'development'
  isEnabled: boolean
  isDefault: boolean
  lastValidatedAt?: Date
  _toggling?: boolean
}

const props = defineProps<{
  instance: DatabaseInstance
}>()

const emit = defineEmits<{
  edit: [instance: DatabaseInstance]
  delete: [instance: DatabaseInstance]
  toggle: [instance: DatabaseInstance, value: boolean]
}>()

// è®¡ç®—éªŒè¯æ–‡æœ¬
const validationText = computed(() => {
  if (!props.instance.lastValidatedAt) {
    return 'æœªéªŒè¯'
  }
  return `æœ€åéªŒè¯: ${formatDistanceToNow(props.instance.lastValidatedAt)}`
})

// è®¡ç®—æ˜¯å¦å·²éªŒè¯ï¼ˆ24å°æ—¶å†…ï¼‰
const isValidated = computed(() => {
  if (!props.instance.lastValidatedAt) return false
  const hoursSinceValidation =
    (Date.now() - new Date(props.instance.lastValidatedAt).getTime()) /
    (1000 * 60 * 60)
  return hoursSinceValidation < 24
})

// ç¯å¢ƒæ ‡ç­¾ç±»å‹
function getEnvironmentTagType(env: string) {
  const map = {
    production: 'danger',
    testing: 'warning',
    development: 'success'
  }
  return map[env] || 'info'
}

// ç¯å¢ƒæ ‡ç­¾æ–‡æœ¬
function getEnvironmentLabel(env: string) {
  const map = {
    production: 'ç”Ÿäº§',
    testing: 'æµ‹è¯•',
    development: 'å¼€å‘'
  }
  return map[env] || env
}

// å¤„ç†ç¼–è¾‘
function handleEdit() {
  emit('edit', props.instance)
}

// å¤„ç†åˆ é™¤
function handleDelete() {
  emit('delete', props.instance)
}

// å¤„ç†å¯ç”¨/ç¦ç”¨
function handleToggle(value: boolean) {
  emit('toggle', props.instance, value)
}
</script>

<style scoped>
.database-instance-card {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.database-instance-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.database-instance-card.is-disabled {
  opacity: 0.6;
}

.card-header {
  padding: var(--spacing-lg);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.header-left {
  display: flex;
  gap: var(--spacing-md);
}

.instance-icon {
  flex-shrink: 0;
}

.instance-info {
  flex: 1;
}

.instance-name {
  font-size: var(--font-size-lg);
  font-weight: 600;
  margin: 0 0 var(--spacing-xs) 0;
}

.instance-meta {
  display: flex;
  gap: var(--spacing-xs);
  flex-wrap: wrap;
}

.card-body {
  padding: var(--spacing-lg);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.info-row {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: var(--font-size-sm);
}

.row-icon {
  color: var(--color-text-muted);
  flex-shrink: 0;
}

.row-label {
  color: var(--color-text-secondary);
  flex-shrink: 0;
}

.row-value {
  color: var(--color-text-primary);
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.validation-status {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-sm);
  padding-top: var(--spacing-sm);
  border-top: 1px solid var(--color-border-light);
}

.validate-text {
  font-size: var(--font-size-xs);
  color: var(--color-text-muted);
}

.card-footer {
  padding: var(--spacing-md) var(--spacing-lg);
  border-top: 1px solid var(--color-border-light);
  display: flex;
  justify-content: space-around;
}
</style>
```

#### 4.2 DatabaseInstanceDialog

```vue
<template>
  <el-dialog
    v-model="visible"
    :title="isEdit ? 'ç¼–è¾‘æ•°æ®åº“å®ä¾‹' : 'æ–°å¢æ•°æ®åº“å®ä¾‹'"
    width="600px"
    :close-on-click-modal="false"
    @close="handleClose"
  >
    <el-form
      ref="formRef"
      :model="form"
      :rules="rules"
      label-position="top"
      label-width="100px"
    >
      <el-form-item label="å®ä¾‹åç§°" prop="name">
        <el-input
          v-model="form.name"
          placeholder="ä¾‹å¦‚ï¼šç”Ÿäº§ç¯å¢ƒä¸»åº“"
          clearable
        >
          <template #prefix>
            <el-icon><Database /></el-icon>
          </template>
        </el-input>
      </el-form-item>

      <el-row :gutter="16">
        <el-col :span="16">
          <el-form-item label="ä¸»æœºåœ°å€" prop="host">
            <el-input
              v-model="form.host"
              placeholder="localhost æˆ– IP åœ°å€"
              clearable
            >
              <template #prefix>
                <el-icon><Connection /></el-icon>
              </template>
            </el-input>
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="ç«¯å£" prop="port">
            <el-input-number
              v-model="form.port"
              :min="1"
              :max="65535"
              class="w-full"
              controls-position="right"
            />
          </el-form-item>
        </el-col>
      </el-row>

      <el-form-item label="ç”¨æˆ·å" prop="username">
        <el-input
          v-model="form.username"
          placeholder="MySQL ç”¨æˆ·å"
          clearable
        >
          <template #prefix>
            <el-icon><User /></el-icon>
          </template>
        </el-input>
      </el-form-item>

      <el-form-item label="å¯†ç " prop="password">
        <el-input
          v-model="form.password"
          type="password"
          show-password
          placeholder="MySQL å¯†ç "
        >
          <template #prefix>
            <el-icon><Lock /></el-icon>
          </template>
        </el-input>
      </el-form-item>

      <el-form-item label="é»˜è®¤æ•°æ®åº“">
        <el-input
          v-model="form.database"
          placeholder="information_schema"
          clearable
        >
          <template #prefix>
            <el-icon><Files /></el-icon>
          </template>
        </el-input>
      </el-form-item>

      <el-form-item label="ç¯å¢ƒç±»å‹" prop="environment">
        <el-select
          v-model="form.environment"
          placeholder="é€‰æ‹©ç¯å¢ƒ"
          class="w-full"
        >
          <el-option
            label="ç”Ÿäº§ç¯å¢ƒ"
            value="production"
          >
            <div class="env-option">
              <el-icon color="#EF4444"><CircleFilled /></el-icon>
              <span>ç”Ÿäº§ç¯å¢ƒ</span>
            </div>
          </el-option>
          <el-option
            label="æµ‹è¯•ç¯å¢ƒ"
            value="testing"
          >
            <div class="env-option">
              <el-icon color="#F59E0B"><WarningFilled /></el-icon>
              <span>æµ‹è¯•ç¯å¢ƒ</span>
            </div>
          </el-option>
          <el-option
            label="å¼€å‘ç¯å¢ƒ"
            value="development"
          >
            <div class="env-option">
              <el-icon color="#10B981"><CircleCheckFilled /></el-icon>
              <span>å¼€å‘ç¯å¢ƒ</span>
            </div>
          </el-option>
        </el-select>
      </el-form-item>

      <el-form-item>
        <el-checkbox v-model="form.isDefault">
          è®¾ä¸ºé»˜è®¤å®ä¾‹
        </el-checkbox>
      </el-form-item>
    </el-form>

    <template #footer>
      <div class="dialog-footer-content">
        <!-- æµ‹è¯•ç»“æœæç¤º -->
        <div class="test-result-panel">
          <!-- æµ‹è¯•æˆåŠŸ -->
          <transition name="fade">
            <div
              v-if="testState === 'success'"
              class="result-item result-success"
            >
              <el-icon :size="20"><CircleCheckFilled /></el-icon>
              <div class="result-text">
                <div class="result-title">è¿æ¥æˆåŠŸ</div>
                <div class="result-detail">å»¶è¿Ÿ {{ testLatency }}ms</div>
              </div>
            </div>
          </transition>

          <!-- æµ‹è¯•å¤±è´¥ -->
          <transition name="fade">
            <div
              v-if="testState === 'fail'"
              class="result-item result-fail"
            >
              <el-icon :size="20"><CircleCloseFilled /></el-icon>
              <div class="result-text">
                <div class="result-title">è¿æ¥å¤±è´¥</div>
                <div class="result-detail">{{ testError }}</div>
              </div>
            </div>
          </transition>

          <!-- æµ‹è¯•ä¸­ -->
          <transition name="fade">
            <div
              v-if="testState === 'testing'"
              class="result-item result-testing"
            >
              <el-icon :size="20" class="rotating"><Loading /></el-icon>
              <div class="result-text">
                <div class="result-title">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>
              </div>
            </div>
          </transition>
        </div>

        <!-- æŒ‰é’®ç»„ -->
        <div class="dialog-actions">
          <el-button @click="handleClose">å–æ¶ˆ</el-button>
          <el-button
            type="info"
            plain
            :loading="testState === 'testing'"
            :disabled="testState === 'testing'"
            @click="handleTest"
          >
            <el-icon><Connection /></el-icon>
            æµ‹è¯•è¿æ¥
          </el-button>
          <el-button
            type="primary"
            :disabled="!canSave"
            :loading="saving"
            @click="handleSave"
          >
            <el-icon><Check /></el-icon>
            ä¿å­˜å®ä¾‹
          </el-button>
        </div>
      </div>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, reactive, computed } from 'vue'
import { ElMessage, ElMessageBox, type FormInstance } from 'element-plus'
import {
  Database,
  Connection,
  User,
  Lock,
  Files,
  CircleCheckFilled,
  CircleCloseFilled,
  Loading,
  Check,
  CircleFilled,
  WarningFilled
} from '@element-plus/icons-vue'
import { testDatabaseConnection, saveDatabaseInstance } from '@/api/instances'
import { useDatabaseForm } from '@/composables/useDatabaseForm'

interface Props {
  visible: boolean
  instance?: DatabaseInstance | null
}

const props = defineProps<Props>()
const emit = defineEmits<{
  'update:visible': [value: boolean]
  saved: []
}>()

const formRef = ref<FormInstance>()
const saving = ref(false)

const isEdit = computed(() => !!props.instance?.id)

// åˆå§‹åŒ–è¡¨å•
const {
  form,
  testState,
  testLatency,
  testError,
  canSave,
  handleTest,
  handleSave: saveInstance
} = useDatabaseForm(props.instance || undefined)

// æµ‹è¯•è¿æ¥
async function handleTest() {
  const valid = await formRef.value?.validate().catch(() => false)
  if (!valid) return

  const success = await handleTest()
  if (!success) {
    // æµ‹è¯•å¤±è´¥ï¼Œä¸å…è®¸ä¿å­˜
  }
}

// ä¿å­˜å®ä¾‹
async function handleSave() {
  if (!canSave.value) {
    ElMessage.warning('è¯·å…ˆæµ‹è¯•è¿æ¥é€šè¿‡åå†ä¿å­˜')
    return
  }

  const valid = await formRef.value?.validate().catch(() => false)
  if (!valid) return

  saving.value = true
  try {
    await saveInstance()
    ElMessage.success(isEdit.value ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ')
    emit('update:visible', false)
    emit('saved')
  } catch (error: any) {
    ElMessage.error('ä¿å­˜å¤±è´¥ï¼š' + error.message)
  } finally {
    saving.value = false
  }
}

// å…³é—­å¯¹è¯æ¡†
async function handleClose() {
  // å¦‚æœæœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œæç¤ºç”¨æˆ·
  if (canSave.value) {
    try {
      await ElMessageBox.confirm(
        'è¿æ¥æµ‹è¯•å·²é€šè¿‡ï¼Œç¡®å®šè¦æ”¾å¼ƒä¿å­˜å—ï¼Ÿ',
        'æç¤º',
        {
          type: 'warning',
          confirmButtonText: 'ç¡®å®šæ”¾å¼ƒ',
          cancelButtonText: 'ç»§ç»­ç¼–è¾‘'
        }
      )
    } catch {
      return
    }
  }

  emit('update:visible', false)
}

// è¡¨å•éªŒè¯è§„åˆ™
const rules = {
  name: [
    { required: true, message: 'è¯·è¾“å…¥å®ä¾‹åç§°', trigger: 'blur' },
    { min: 2, max: 50, message: 'é•¿åº¦åœ¨ 2 åˆ° 50 ä¸ªå­—ç¬¦', trigger: 'blur' }
  ],
  host: [
    { required: true, message: 'è¯·è¾“å…¥ä¸»æœºåœ°å€', trigger: 'blur' }
  ],
  port: [
    { required: true, message: 'è¯·è¾“å…¥ç«¯å£', trigger: 'blur' }
  ],
  username: [
    { required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å', trigger: 'blur' }
  ],
  password: [
    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' }
  ],
  environment: [
    { required: true, message: 'è¯·é€‰æ‹©ç¯å¢ƒç±»å‹', trigger: 'change' }
  ]
}
</script>

<style scoped>
.dialog-footer-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--spacing-lg);
}

.test-result-panel {
  flex: 1;
  min-width: 200px;
}

.result-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--radius-sm);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.result-success {
  background: #D1FAE5;
  color: #065F46;
}

.result-fail {
  background: #FEE2E2;
  color: #991B1B;
}

.result-testing {
  background: #DBEAFE;
  color: #1E40AF;
}

.result-text {
  flex: 1;
}

.result-title {
  font-weight: 600;
  font-size: var(--font-size-sm);
}

.result-detail {
  font-size: var(--font-size-xs);
  opacity: 0.8;
}

.dialog-actions {
  display: flex;
  gap: var(--spacing-sm);
  flex-shrink: 0;
}

.env-option {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.rotating {
  animation: rotate 1s linear infinite;
}

@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* è¿‡æ¸¡åŠ¨ç”» */
.fade-enter-active,
.fade-leave-active {
  transition: all 0.3s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
  transform: translateY(-10px);
}
</style>
```

---

## ğŸ¤– AIæœåŠ¡å®ä¾‹ç®¡ç†

### 1. é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¢åŒ…å±‘: é¦–é¡µ > å®ä¾‹ç®¡ç† > AI æœåŠ¡å®ä¾‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é¡µé¢æ ‡é¢˜                                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  ğŸ¤– AI æœåŠ¡å®ä¾‹ç®¡ç†                                           â”‚
â”‚  ä¸ºä¸‰ä¸ª AI Agent é…ç½®ç®—åŠ›æœåŠ¡ï¼Œæ”¯æŒ OpenAIã€Ollamaã€DeepSeek   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ©º ä¸»æ²»åŒ»ç”Ÿ (Diagnosis Agent)                         â”‚  â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚
â”‚  â”‚  æä¾›å•†: OpenAI                    [ğŸŸ¢ å·²é…ç½®]          â”‚  â”‚
â”‚  â”‚  æ¨¡å‹: gpt-4-turbo                                      â”‚  â”‚
â”‚  â”‚  Base URL: https://api.openai.com/v1                   â”‚  â”‚
â”‚  â”‚  æœ€åéªŒè¯: 5åˆ†é’Ÿå‰ (å»¶è¿Ÿ 1.2s)                          â”‚  â”‚
â”‚  â”‚                                   [é…ç½®] [æµ‹è¯•] [ç¼–è¾‘]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ§  æ¨ç†ä¸“å®¶ (Reasoning Agent)                         â”‚  â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚
â”‚  â”‚  æä¾›å•†: DeepSeek                    [ğŸŸ¢ å·²é…ç½®]        â”‚  â”‚
â”‚  â”‚  æ¨¡å‹: deepseek-chat                                   â”‚  â”‚
â”‚  â”‚  Base URL: https://api.deepseek.com                    â”‚  â”‚
â”‚  â”‚  æœ€åéªŒè¯: 1å°æ—¶å‰ (å»¶è¿Ÿ 0.8s)                          â”‚  â”‚
â”‚  â”‚                                   [é…ç½®] [æµ‹è¯•] [ç¼–è¾‘]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ’» ç¼–ç ä¸“å®¶ (Coding Agent)                            â”‚  â”‚
â”‚  â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚  â”‚
â”‚  â”‚  âšª æœªé…ç½®                                              â”‚  â”‚
â”‚  â”‚                                   [é…ç½®]               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç»„ä»¶ç»“æ„

```
AiServiceInstances (é¡µé¢)
â”œâ”€ PageHeader
â””â”€ AgentGrid
   â””â”€ AgentCard Ã— 3
      â”œâ”€ AgentHeader
      â”‚  â”œâ”€ AgentIcon (ğŸ©º/ğŸ§ /ğŸ’»)
      â”‚  â”œâ”€ AgentName
      â”‚  â”œâ”€ AgentDescription
      â”‚  â””â”€ StatusBadge
      â”œâ”€ AgentBody
      â”‚  â”œâ”€ ProviderInfo (æä¾›å•†ä¿¡æ¯)
      â”‚  â”œâ”€ ModelInfo (æ¨¡å‹ä¿¡æ¯)
      â”‚  â””â”€ ValidationInfo (éªŒè¯ä¿¡æ¯)
      â””â”€ AgentFooter
         â””â”€ ActionButtons (é…ç½®/æµ‹è¯•/ç¼–è¾‘)
```

### 3. æ ¸å¿ƒäº¤äº’

#### 3.1 é…ç½®æµç¨‹

```
ç‚¹å‡»"é…ç½®"
   â”‚
   â–¼
æ‰“å¼€é…ç½®æŠ½å±‰ï¼ˆDrawerï¼‰
   â”‚
   â”œâ”€ é€‰æ‹©æä¾›å•†ï¼ˆOpenAI/Ollama/DeepSeek/Anthropic/Azureï¼‰
   â”‚
   â”œâ”€ å¡«å†™é…ç½®ä¿¡æ¯
   â”‚  â”œâ”€ Base URL
   â”‚  â”œâ”€ API Key
   â”‚  â”œâ”€ Model Name
   â”‚  â””â”€ Temperature
   â”‚
   â”œâ”€ ç‚¹å‡»"æµ‹è¯•è¿æ¥"
   â”‚  â”‚
   â”‚  â–¼
   â”‚  åç«¯å‘é€æµ‹è¯•è¯·æ±‚åˆ° AI æœåŠ¡
   â”‚  â”‚
   â”‚  â–¼
   â”‚  æ˜¾ç¤ºç»“æœ
   â”‚  â”œâ”€ âœ… æˆåŠŸ: æ˜¾ç¤ºå»¶è¿Ÿ â†’ "ä¿å­˜"æŒ‰é’®é«˜äº®
   â”‚  â””â”€ âŒ å¤±è´¥: æ˜¾ç¤ºé”™è¯¯ â†’ "ä¿å­˜"æŒ‰é’®ç¦ç”¨
   â”‚
   â””â”€ ç‚¹å‡»"ä¿å­˜"
      â”‚
      â–¼
   ä¿å­˜åˆ°æ•°æ®åº“ï¼Œåˆ·æ–°å¡ç‰‡
```

#### 3.2 ä»£ç å®ç°

```typescript
// src/composables/useAiServiceForm.ts
export function useAiServiceForm(agentType: AgentType) {
  const form = reactive<AiServiceForm>({
    provider: 'openai',
    baseUrl: '',
    apiKey: '',
    model: '',
    temperature: 0.7,
    maxTokens: 2000
  })

  const testState = ref<TestState>('none')
  const testLatency = ref(0)
  const testResponse = ref('')

  // æ ¹æ®æä¾›å•†è®¾ç½®é»˜è®¤å€¼
  function setDefaultsByProvider(provider: string) {
    const defaults = {
      openai: {
        baseUrl: 'https://api.openai.com/v1',
        model: 'gpt-4-turbo'
      },
      ollama: {
        baseUrl: 'http://localhost:11434',
        model: 'llama2'
      },
      deepseek: {
        baseUrl: 'https://api.deepseek.com',
        model: 'deepseek-chat'
      }
    }

    if (defaults[provider]) {
      form.baseUrl = defaults[provider].baseUrl
      form.model = defaults[provider].model
    }
  }

  // æµ‹è¯•è¿æ¥
  async function handleTest(): Promise<boolean> {
    testState.value = 'testing'
    const startTime = Date.now()

    try {
      const response = await testAiService({
        provider: form.provider,
        baseUrl: form.baseUrl,
        apiKey: form.apiKey,
        model: form.model
      })

      testLatency.value = Date.now() - startTime
      testResponse.value = response.message || 'è¿æ¥æˆåŠŸ'
      testState.value = 'success'
      ElMessage.success(`è¿æ¥æˆåŠŸï¼å»¶è¿Ÿ ${testLatency.value}ms`)
      return true
    } catch (error: any) {
      testState.value = 'fail'
      testResponse.value = error.message || 'è¿æ¥å¤±è´¥'
      ElMessage.error(testResponse.value)
      return false
    }
  }

  return {
    form,
    testState,
    testLatency,
    testResponse,
    setDefaultsByProvider,
    handleTest
  }
}
```

---

## ğŸ”Œ APIè®¾è®¡

### 1. æ•°æ®åº“å®ä¾‹ API

#### 1.1 è·å–å®ä¾‹åˆ—è¡¨

```typescript
GET /api/instances/database

Response:
{
  "success": true,
  "data": [
    {
      "id": "1",
      "name": "ç”Ÿäº§ç¯å¢ƒä¸»åº“",
      "host": "192.168.1.100",
      "port": 3306,
      "username": "root",
      "database": "information_schema",
      "environment": "production",
      "isEnabled": true,
      "isDefault": true,
      "lastValidatedAt": "2024-02-04T10:30:00Z",
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ]
}
```

#### 1.2 æµ‹è¯•è¿æ¥

```typescript
POST /api/instances/database/test

Request:
{
  "host": "192.168.1.100",
  "port": 3306,
  "username": "root",
  "password": "encrypted_password",
  "database": "information_schema"
}

Response:
{
  "success": true,
  "data": {
    "connected": true,
    "latency": 120,
    "version": "8.0.32",
    "database": "information_schema"
  }
}

Error Response:
{
  "success": false,
  "error": "Connection refused: connect"
}
```

#### 1.3 ä¿å­˜å®ä¾‹

```typescript
POST /api/instances/database
PUT /api/instances/database/:id

Request:
{
  "name": "ç”Ÿäº§ç¯å¢ƒä¸»åº“",
  "host": "192.168.1.100",
  "port": 3306,
  "username": "root",
  "password": "encrypted_password",
  "database": "information_schema",
  "environment": "production",
  "isDefault": true
}

Response:
{
  "success": true,
  "data": {
    "id": "1",
    "name": "ç”Ÿäº§ç¯å¢ƒä¸»åº“",
    ...
  }
}
```

### 2. AI æœåŠ¡å®ä¾‹ API

#### 2.1 è·å– AI æœåŠ¡é…ç½®

```typescript
GET /api/instances/ai-service

Response:
{
  "success": true,
  "data": {
    "diagnosis": {
      "agentType": "diagnosis",
      "provider": "openai",
      "baseUrl": "https://api.openai.com/v1",
      "model": "gpt-4-turbo",
      "temperature": 0.7,
      "isEnabled": true,
      "lastValidatedAt": "2024-02-04T10:30:00Z"
    },
    "reasoning": { ... },
    "coding": { ... }
  }
}
```

#### 2.2 æµ‹è¯• AI æœåŠ¡

```typescript
POST /api/instances/ai-service/test

Request:
{
  "agentType": "diagnosis",
  "provider": "openai",
  "baseUrl": "https://api.openai.com/v1",
  "apiKey": "sk-xxx",
  "model": "gpt-4-turbo"
}

Response:
{
  "success": true,
  "data": {
    "connected": true,
    "latency": 1200,
    "response": "Hello! I'm ready to help."
  }
}
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### DatabaseInstance

```typescript
interface DatabaseInstance {
  // åŸºæœ¬ä¿¡æ¯
  id: string
  name: string
  host: string
  port: number
  username: string
  password: string  // åŠ å¯†å­˜å‚¨
  database?: string

  // é…ç½®
  environment: 'production' | 'testing' | 'development'
  isEnabled: boolean
  isDefault: boolean

  // éªŒè¯ä¿¡æ¯
  lastValidatedAt?: Date

  // å…ƒæ•°æ®
  createdAt: Date
  updatedAt: Date
}
```

### AiServiceInstance

```typescript
interface AiServiceInstance {
  // åŸºæœ¬ä¿¡æ¯
  id: string
  agentType: 'diagnosis' | 'reasoning' | 'coding'
  provider: 'openai' | 'ollama' | 'deepseek' | 'anthropic' | 'azure'

  // é…ç½®
  baseUrl: string
  apiKey: string  // åŠ å¯†å­˜å‚¨
  model: string
  temperature?: number
  maxTokens?: number

  // çŠ¶æ€
  isEnabled: boolean

  // éªŒè¯ä¿¡æ¯
  lastValidatedAt?: Date

  // å…ƒæ•°æ®
  createdAt: Date
  updatedAt: Date
}
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### å•å…ƒæµ‹è¯•

```typescript
// DatabaseInstanceCard.spec.ts
describe('DatabaseInstanceCard', () => {
  it('should display instance information correctly', () => {
    // ...
  })

  it('should show online status when enabled', () => {
    // ...
  })

  it('should emit edit event when edit button clicked', () => {
    // ...
  })

  it('should emit delete event when delete button clicked', () => {
    // ...
  })

  it('should emit toggle event when switch changed', () => {
    // ...
  })
})

// DatabaseInstanceDialog.spec.ts
describe('DatabaseInstanceDialog', () => {
  it('should disable save button initially', () => {
    // ...
  })

  it('should keep save button disabled after test fails', () => {
    // ...
  })

  it('should enable save button after test succeeds', () => {
    // ...
  })

  it('should reset test state when form changes', () => {
    // ...
  })

  it('should validate form before test', () => {
    // ...
  })

  it('should save instance after successful test', () => {
    // ...
  })
})
```

### é›†æˆæµ‹è¯•

```typescript
// DatabaseInstances.spec.ts
describe('DatabaseInstances Page Integration', () => {
  it('should create new instance after test passes', async () => {
    // 1. æ‰“å¼€é¡µé¢
    // 2. ç‚¹å‡»"æ–°å¢"
    // 3. å¡«å†™è¡¨å•
    // 4. ç‚¹å‡»"æµ‹è¯•è¿æ¥"
    // 5. éªŒè¯æµ‹è¯•æˆåŠŸ
    // 6. éªŒè¯"ä¿å­˜"æŒ‰é’®å¯ç”¨
    // 7. ç‚¹å‡»"ä¿å­˜"
    // 8. éªŒè¯å®ä¾‹å‡ºç°åœ¨åˆ—è¡¨ä¸­
  })

  it('should not save instance if test fails', async () => {
    // ...
  })

  it('should edit existing instance', async () => {
    // ...
  })

  it('should delete instance after confirmation', async () => {
    // ...
  })
})
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] èƒ½å¤Ÿæ–°å¢æ•°æ®åº“å®ä¾‹
- [ ] åªæœ‰æµ‹è¯•è¿æ¥é€šè¿‡åæ‰èƒ½ä¿å­˜å®ä¾‹
- [ ] èƒ½å¤Ÿç¼–è¾‘å’Œåˆ é™¤å®ä¾‹
- [ ] èƒ½å¤Ÿå¯ç”¨/ç¦ç”¨å®ä¾‹
- [ ] æœç´¢åŠŸèƒ½æ­£å¸¸
- [ ] èƒ½å¤Ÿé…ç½®ä¸‰ä¸ª AI Agent
- [ ] æ‰€æœ‰è¡¨å•éªŒè¯æ­£ç¡®

### UI/UX éªŒæ”¶

- [ ] å¡ç‰‡æ‚¬åœæœ‰æŠ¬å‡æ•ˆæœ
- [ ] æµ‹è¯•ç»“æœæœ‰åŠ¨ç”»æ˜¾ç¤º
- [ ] æŒ‰é’®çŠ¶æ€æ­£ç¡®ï¼ˆç¦ç”¨/å¯ç”¨ï¼‰
- [ ] å“åº”å¼å¸ƒå±€é€‚é…
- [ ] åŠ è½½çŠ¶æ€æ­£ç¡®æ˜¾ç¤º

### æ€§èƒ½éªŒæ”¶

- [ ] é¡µé¢åŠ è½½æ—¶é—´ < 1s
- [ ] æµ‹è¯•è¿æ¥å“åº”æ—¶é—´ < 3s
- [ ] åˆ—è¡¨æ¸²æŸ“æµç•…ï¼ˆ100+ å®ä¾‹ï¼‰

### æµ‹è¯•éªŒæ”¶

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ— æ§åˆ¶å°é”™è¯¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2026-02-04
