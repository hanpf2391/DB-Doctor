# DB-Doctor å¤š Agent AI å®æ–½è®¡åˆ’éœ€æ±‚è®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.2.0
> **åˆ›å»ºæ—¶é—´**: 2026-01-30
> **åŸºäºç‰ˆæœ¬**: v2.1.0 (å½“å‰å®Œæˆåº¦ 90%)
> **æ–‡æ¡£ç±»å‹**: å®æ–½è®¡åˆ’ + éœ€æ±‚è®¾è®¡

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®ç°çŠ¶åˆ†æ](#1-é¡¹ç›®ç°çŠ¶åˆ†æ)
2. [æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#2-æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
3. [æ¶æ„è®¾è®¡æ–¹æ¡ˆ](#3-æ¶æ„è®¾è®¡æ–¹æ¡ˆ)
4. [æ•°æ®æµè®¾è®¡](#4-æ•°æ®æµè®¾è®¡)
5. [å¤š Agent åä½œæ–¹æ¡ˆ](#5-å¤š-agent-åä½œæ–¹æ¡ˆ)
6. [é€šçŸ¥ç­–ç•¥ä¼˜åŒ–](#6-é€šçŸ¥ç­–ç•¥ä¼˜åŒ–)
7. [å®æ–½è®¡åˆ’](#7-å®æ–½è®¡åˆ’)
8. [éªŒæ”¶æ ‡å‡†](#8-éªŒæ”¶æ ‡å‡†)

---

## 1. é¡¹ç›®ç°çŠ¶åˆ†æ

### 1.1 å½“å‰ç‰ˆæœ¬å®Œæˆåº¦

**ç‰ˆæœ¬**: v2.1.0
**å®Œæˆåº¦**: **90%** (26/30 åŠŸèƒ½ç‚¹)

| æ¨¡å— | å®Œæˆåº¦ | è¯´æ˜ |
|------|--------|------|
| æ ¸å¿ƒæ¶æ„ | 100% | âœ… åŒæ•°æ®æºéš”ç¦»ã€Template+Sample åŒè¡¨æ¶æ„ |
| ç›‘æ§æ¨¡å— | 100% | âœ… æ¸¸æ ‡æœºåˆ¶ã€è‡ªé€‚åº”è½®è¯¢ã€ç¯å¢ƒæ„ŸçŸ¥ |
| åˆ†ææ¨¡å— | 100% | âœ… æ–°è€é¢å­”å¤„ç†ã€ç»Ÿè®¡å¢é‡æ›´æ–° |
| AI æ¨¡å— | **67%** | âš ï¸ æ¥å£å’Œå·¥å…·å·²å®ç°ï¼Œä½†æœªé…ç½® Bean å’Œé›†æˆ |
| è¯Šæ–­å·¥å…· | 100% | âœ… 7 ç§å·¥å…·å…¨éƒ¨å®ç° |
| é€šçŸ¥æ¨¡å— | **50%** | âš ï¸ é‚®ä»¶å·²å®ç°ï¼Œæ™ºèƒ½ç­–ç•¥å’Œ Webhook æœªå®ç° |
| å·¥å…·æ¨¡å— | 100% | âœ… SQL æŒ‡çº¹ã€è„±æ•ç­‰ |
| ç”Ÿå‘½å‘¨æœŸ | 100% | âœ… ä¼˜é›…åœæœºã€PENDING é‡è¯• |
| é…ç½®ç®¡ç† | 100% | âœ… é…ç½®æ–‡ä»¶å®Œæ•´ |

### 1.2 æ ¸å¿ƒç¼ºå¤±åŠŸèƒ½ï¼ˆé˜»å¡é—®é¢˜ï¼‰

#### âŒ é—®é¢˜ 1: DBAgent Bean æœªé…ç½®
**å½±å“**: AI åŠŸèƒ½å®Œå…¨æ— æ³•ä½¿ç”¨
**ä½ç½®**: `src/main/java/com/dbdoctor/config/AiConfig.java`
**åŸå› **: åªé…ç½®äº† `ChatLanguageModel`ï¼Œæ²¡æœ‰åˆ›å»º `DBAgent` Bean

#### âŒ é—®é¢˜ 2: AI åˆ†ææœªé›†æˆåˆ°æŠ¥å‘Šç”Ÿæˆ
**å½±å“**: ç”Ÿæˆçš„æŠ¥å‘ŠåªåŒ…å«åŸºç¡€æ•°æ®ï¼Œæ—  AI è¯Šæ–­å»ºè®®
**ä½ç½®**: `src/main/java/com/dbdoctor/service/AnalysisService.java` (ç¬¬ 212-251 è¡Œ)
**åŸå› **: `generateReportAndNotify()` æ–¹æ³•åªç”ŸæˆåŸºç¡€ç»Ÿè®¡ä¿¡æ¯ï¼Œæœªè°ƒç”¨ LLM

### 1.3 å·²æœ‰çš„ä¼˜ç§€è®¾è®¡ï¼ˆä¿ç•™ï¼‰

#### âœ… åŒæ•°æ®æºéš”ç¦»æ¶æ„
- H2 å­˜å‚¨å…ƒæ•°æ®ï¼ˆTemplateã€Sample è¡¨ï¼‰
- MySQL åªè¯»è®¿é—®ï¼ˆslow_logã€EXPLAINã€information_schemaï¼‰
- å®Œå…¨é›¶ä¾µå…¥ï¼Œä¸å½±å“ä¸šåŠ¡

#### âœ… Template + Sample åŒè¡¨æ¶æ„
- SQL æŒ‡çº¹å»é‡ï¼ˆMD5ï¼‰
- ç»Ÿè®¡ä¿¡æ¯é¢„èšåˆï¼ˆæ€§èƒ½æå‡ 100x+ï¼‰
- å¢é‡æ›´æ–°ç®—æ³•

#### âœ… æ¸¸æ ‡æœºåˆ¶
- `lastCheckTime` è®°å½•è¯»å–ä½ç½®
- é˜²æ­¢é‡å¤å¤„ç†
- **éœ€è¦ä¼˜åŒ–**: æ›´æ–°æ—¶æœºï¼ˆè§ç¬¬ 2 èŠ‚ï¼‰

---

## 2. æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 2.1 é—®é¢˜ä¸€ï¼šæ¸¸æ ‡æ›´æ–°æ—¶æœº

#### é—®é¢˜æè¿°
**ç°çŠ¶**: æ¸¸æ ‡æ›´æ–°æ—¶æœºä¸æ˜ç¡®ï¼Œå¯èƒ½å¯¼è‡´ï¼š
1. **å»¶è¿Ÿé—®é¢˜**: å¦‚æœç­‰ AI åˆ†æå®Œæˆæ‰æ›´æ–°æ¸¸æ ‡ï¼Œç›‘æ§å»¶è¿Ÿä¼šè¾¾åˆ° 5-10 åˆ†é’Ÿ
2. **æ•°æ®ä¸¢å¤±é£é™©**: ç¨‹åºå´©æºƒæ—¶ï¼Œæœªæ›´æ–°çš„æ¸¸æ ‡ä¼šå¯¼è‡´é‡å¤å¤„ç†

#### è§£å†³æ–¹æ¡ˆï¼šé‡‡é›†ä¸å¤„ç†å½»åº•åˆ†ç¦»

**æ ¸å¿ƒæ€æƒ³**: "é‡‡é›†"çš„è´£ä»»ï¼Œåªåˆ°"æŠŠæ•°æ®å®‰å…¨åœ°æŠ•é€’è¿›ç³»ç»Ÿ"ä¸ºæ­¢ã€‚æ¸¸æ ‡çš„æ›´æ–°åº”è¯¥åœ¨æ•°æ®æŒä¹…åŒ–åˆ° H2 åç«‹å³è¿›è¡Œã€‚

**æµç¨‹è®¾è®¡**:

```
10:00:00 - SlowLogMonitor å¯åŠ¨
    â†“
æ‹‰å– 100 æ¡æ•°æ®ï¼ˆæœ€æ™šæ—¶é—´ 10:00:58ï¼‰
    â†“
æŠ•é€’ç»™ AnalysisService.processSlowQuery()
    â†“ (æ¯ä¸ªæ–¹æ³•è°ƒç”¨è€—æ—¶ < 10ms)
æ•°æ®æŒä¹…åŒ–åˆ° H2ï¼ˆäº‹åŠ¡æäº¤ï¼‰
    â†“
ã€ç«‹å³æ›´æ–°æ¸¸æ ‡ã€‘lastCheckTime = 10:00:58
    â†“
10:00:01 - ç›‘æ§å‘¨æœŸç»“æŸï¼ˆæ€»è€—æ—¶ < 1 ç§’ï¼‰
    â†“
10:00:01 - åå°å¼‚æ­¥çº¿ç¨‹å¼€å§‹ AI åˆ†æï¼ˆè€—æ—¶ 30 ç§’ï¼‰
    â†“
10:00:31 - AI åˆ†æå®Œæˆ
```

**ä»£ç å®ç°**:

```java
@Component
public class SlowLogTableMonitor {

    private Timestamp lastCheckTime; // å†…å­˜æ¸¸æ ‡

    @Scheduled(...)
    public void monitor() {
        // 1. æ‹‰å–æ•°æ®
        List<SlowQueryLog> newLogs = pullNewLogsFromMySql();

        if (newLogs.isEmpty()) {
            return;
        }

        // 2. æ‰¾åˆ°æœ¬æ‰¹æ¬¡çš„æœ€æ™šæ—¶é—´æˆ³
        Timestamp maxTimestampInBatch = findMaxTimestamp(newLogs);

        // 3. æ•°æ®æŠ•é€’ï¼ˆéé˜»å¡ï¼‰
        for (SlowQueryLog log : newLogs) {
            try {
                analysisService.processSlowQuery(log);
            } catch (Exception e) {
                log.error("å¤„ç†å•æ¡æ…¢æŸ¥è¯¢å¤±è´¥", e);
            }
        }

        // 4. ã€å…³é”®ã€‘ç«‹å³æ›´æ–°æ¸¸æ ‡ï¼ˆä¸ AI åˆ†æè§£è€¦ï¼‰
        this.lastCheckTime = maxTimestampInBatch;
        log.info("æ…¢æŸ¥è¯¢é‡‡é›†å®Œæˆï¼Œæ¸¸æ ‡å‰ç§»è‡³: {}", this.lastCheckTime);
    }
}
```

**ä¼˜åŠ¿**:
- âœ… ç›‘æ§å»¶è¿Ÿ < 1 ç§’ï¼ˆè½®è¯¢é—´éš”å†…ï¼‰ï¼Œä¸ AI åˆ†ææ—¶é—´æ— å…³
- âœ… æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼šå…ˆæŒä¹…åŒ– H2ï¼Œå†æ›´æ–°æ¸¸æ ‡
- âœ… å´©æºƒæ¢å¤ï¼šæœªæ›´æ–°çš„æ¸¸æ ‡ä¼šé‡æ–°å¤„ç†ï¼ŒUPSERT ä¿è¯ç²¾ç¡®ä¸€æ¬¡

---

### 2.2 é—®é¢˜äºŒï¼šæ•°æ®ä¸€è‡´æ€§ä¸æ—¶é—´è¯­ä¹‰

#### é—®é¢˜æè¿°
**ç°çŠ¶**: å¼‚æ­¥é˜Ÿåˆ—æ¨¡å¼ä¸‹ï¼Œå­˜åœ¨æ’é˜Ÿæ—¶é—´ï¼ˆLagï¼‰ï¼Œå¯¼è‡´ï¼š
1. AI åˆ†ææ—¶çœ‹åˆ°çš„æ•°æ®å¯èƒ½åŒ…å«æ’é˜ŸæœŸé—´æ–°å¢çš„æ ·æœ¬
2. ç”¨æˆ·çœ‹åˆ°çš„æŠ¥å‘Šæ—¶é—´ä¸åˆ†ææ•°æ®æ—¶é—´ä¸åŒ¹é…
3. æŠ¥å‘Šçš„"å‡ºç°æ¬¡æ•°"åŒ…å«æ’é˜ŸæœŸé—´çš„å¢é‡ï¼Œç”¨æˆ·å›°æƒ‘

#### è§£å†³æ–¹æ¡ˆï¼šæ•°æ®å¿«ç…§ + æ—¶é—´çª—å£æ˜ç¡®åŒ–

**æ ¸å¿ƒæ€æƒ³**: åœ¨è§¦å‘å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œåˆ›å»ºä¸å¯å˜çš„"æ•°æ®å¿«ç…§"ï¼Œå¹¶åœ¨æŠ¥å‘Šä¸­æ˜ç¡®æ ‡æ³¨æ—¶é—´çª—å£ã€‚

**æ•°æ®æ¨¡å‹è®¾è®¡**:

```java
/**
 * åˆ†æä¸Šä¸‹æ–‡ï¼ˆæ•°æ®å¿«ç…§ï¼‰
 *
 * ä½œç”¨ï¼š
 * 1. åœ¨è§¦å‘å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œä¸€æ¬¡æ€§æ‰“åŒ…æ‰€æœ‰éœ€è¦çš„ä¸Šä¸‹æ–‡æ•°æ®
 * 2. åœ¨æ•´ä¸ªåˆ†æè¿‡ç¨‹ä¸­ï¼Œä¸å†å®æ—¶æŸ¥è¯¢ H2ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
 * 3. æ˜ç¡®è®°å½•æ—¶é—´å…ƒæ•°æ®ï¼Œç”¨äºæŠ¥å‘Šå±•ç¤º
 */
@Data
@Builder
public class AnalysisContext {

    // === æŒ‡çº¹æ ‡è¯† ===
    private String sqlFingerprint;

    // === æ—¶é—´å…ƒæ•°æ® ===
    /**
     * è§¦å‘æ—¶é—´ï¼šé—®é¢˜é¦–æ¬¡è¢«å‘ç°å¹¶è¿›å…¥ PENDING çŠ¶æ€çš„æ—¶é—´
     */
    private LocalDateTime triggerTime;

    /**
     * åˆ†ææ—¶é—´ï¼šWorker çº¿ç¨‹æŠ¢åˆ°ä»»åŠ¡ï¼ŒçœŸæ­£å¼€å§‹åˆ†æçš„æ—¶é—´
     */
    private LocalDateTime analysisTime;

    /**
     * æ•°æ®é‡‡æ ·æˆªæ­¢æ—¶é—´ï¼šè¯»å–æ ·æœ¬æ•°æ®æ—¶çš„å½“å‰æ—¶é—´
     */
    private LocalDateTime dataRangeEndTime;

    // === æ•°æ®å¿«ç…§ ===
    /**
     * Template ç»Ÿè®¡ä¿¡æ¯å¿«ç…§ï¼ˆåœ¨ analysisTime æ—¶åˆ»è¯»å–ï¼‰
     */
    private TemplateStatisticsSnapshot templateStats;

    /**
     * æœ€è¿‘ N æ¡æ ·æœ¬ï¼ˆåœ¨ dataRangeEndTime æ—¶åˆ»è¯»å–ï¼‰
     */
    private List<SlowQuerySample> recentSamples;

    /**
     * è®¡ç®—æ’é˜Ÿæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
     */
    public long getQueueDurationMinutes() {
        return ChronoUnit.MINUTES.between(triggerTime, analysisTime);
    }
}
```

**æŠ¥å‘Šæ¨¡æ¿è®¾è®¡**:

```markdown
# ğŸ©º æ…¢æŸ¥è¯¢æ™ºèƒ½è¯Šæ–­æŠ¥å‘Š

> **è¯Šæ–­çŠ¶æ€**: âœ… å®Œæˆ
> **ä¸¥é‡ç­‰çº§**: ğŸ”´ CRITICAL

### ğŸ•’ æ—¶é—´çª—å£è¯´æ˜
| æ—¶é—´ç‚¹ | è¯´æ˜ |
|--------|------|
| **é—®é¢˜é¦–æ¬¡æ•è·** | `2026-01-30 10:00:00` |
| **AI ä»‹å…¥åˆ†æ** | `2026-01-30 10:10:00` (æ’é˜Ÿç­‰å¾… 10m) |
| **æ•°æ®é‡‡æ ·èŒƒå›´** | åŸºäº `10:00` è‡³ `10:10` æœŸé—´æ•è·çš„ **505** æ¬¡æ‰§è¡Œè®°å½•ä¸­çš„ **Top 5** æ ·æœ¬è¿›è¡Œåˆ†æ |

> âš ï¸ **è¯´æ˜**: ç”±äºç³»ç»Ÿè´Ÿè½½è¾ƒé«˜ï¼Œæœ¬æ¬¡è¯Šæ–­åˆå¹¶äº†æ’é˜ŸæœŸé—´å‘ç”Ÿçš„å¤šæ¬¡é‡å¤æŸ¥è¯¢ã€‚

---

### ğŸ¤– AI è¯Šæ–­ç»“è®º
...
```

**ä»£ç å®ç°**:

```java
// åœ¨ AnalysisService.processSlowQuery() ä¸­
public void processSlowQuery(SlowQueryLog slowLog) {
    // ... æ•°æ®æ¸…æ´—ã€æŒ‡çº¹è®¡ç®— ...

    // åˆ›å»º Template è®°å½•
    SlowQueryTemplate template = ...;
    template.setStatus(SlowQueryTemplate.AnalysisStatus.PENDING);
    template.setTriggerTime(LocalDateTime.now()); // è®°å½•è§¦å‘æ—¶é—´
    templateRepo.save(template);

    // åˆ›å»ºæ•°æ®å¿«ç…§å¹¶è§¦å‘å¼‚æ­¥åˆ†æ
    triggerMultiAgentAnalysis(template.getSqlFingerprint());
}

// å¼‚æ­¥åˆ†ææ–¹æ³•
@Async("analysisExecutor")
public void triggerMultiAgentAnalysis(String fingerprint) {
    // 1. æŸ¥è¯¢ Template
    SlowQueryTemplate template = templateRepo.findBySqlFingerprint(fingerprint).orElseThrow();

    // 2. ç«‹å³æ›´æ–°çŠ¶æ€ä¸º DIAGNOSINGï¼Œé˜²æ­¢é‡å¤è°ƒåº¦
    template.setStatus(SlowQueryTemplate.AnalysisStatus.DIAGNOSING);
    template.setAnalysisStartTime(LocalDateTime.now());
    templateRepo.save(template);

    // 3. ã€å…³é”®ã€‘åˆ›å»ºæ•°æ®å¿«ç…§ï¼ˆä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼‰
    LocalDateTime now = LocalDateTime.now();
    List<SlowQuerySample> recentSamples = sampleRepo.findTop10ByFingerprintOrderByCapturedAtDesc(fingerprint);

    TemplateStatisticsSnapshot stats = TemplateStatisticsSnapshot.builder()
            .occurrenceCount(template.getOccurrenceCount())
            .avgQueryTime(template.getAvgQueryTime())
            // ... å…¶ä»–ç»Ÿè®¡å­—æ®µ
            .build();

    AnalysisContext context = AnalysisContext.builder()
            .sqlFingerprint(fingerprint)
            .triggerTime(template.getTriggerTime())
            .analysisTime(template.getAnalysisStartTime())
            .dataRangeEndTime(now)
            .templateStats(stats)
            .recentSamples(recentSamples)
            .build();

    // 4. è°ƒç”¨å¤š Agent åè°ƒå™¨ï¼ˆåªæ¶ˆè´¹ contextï¼Œä¸å†æŸ¥è¯¢ H2ï¼‰
    multiAgentCoordinator.analyze(context);
}
```

**ä¼˜åŠ¿**:
- âœ… æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼šåˆ†æè¿‡ç¨‹ä¸­æ•°æ®ä¸å˜
- âœ… æ—¶é—´é€æ˜ï¼šç”¨æˆ·æ¸…æ¥šçŸ¥é“æŠ¥å‘Šçš„æ•°æ®èŒƒå›´
- âœ… æ’é˜Ÿæ—¶é—´åˆ©ç”¨ï¼šæŠ¥å‘ŠåŒ…å«æ’é˜ŸæœŸé—´ç§¯ç´¯çš„æ•°æ®

---

### 2.3 é—®é¢˜ä¸‰ï¼šé€šçŸ¥ç­–ç•¥ä¼˜åŒ–

#### é—®é¢˜æè¿°
**ç°çŠ¶**: é€šçŸ¥é€»è¾‘æ··ä¹±
1. å¦‚æœåœ¨å…¥é˜Ÿæ—¶åˆ¤æ–­ï¼Œå¯èƒ½æ¼æ‰æ’é˜ŸæœŸé—´æ–°å¢çš„æ¬¡æ•°
2. å¦‚æœåœ¨å‡ºé˜Ÿæ—¶åˆ¤æ–­ï¼Œå»¶è¿Ÿå¤ªä¹…ï¼Œç”¨æˆ·ä½“éªŒå·®
3. é«˜é¢‘é€šçŸ¥ä¼šå¯¼è‡´"é‚®ä»¶è½°ç‚¸"

#### è§£å†³æ–¹æ¡ˆï¼šå®šæœŸæ±‡æ€»æŠ¥å‘Šæ¨¡å¼ï¼ˆMVPï¼‰

**æ ¸å¿ƒæ€æƒ³**: åˆ†æå®Œæˆååªæ ‡è®°çŠ¶æ€ï¼Œä¸ç«‹å³å‘é‚®ä»¶ã€‚æ–°å¢ç‹¬ç«‹çš„ `NotificationScheduler`ï¼Œå®šæ—¶ï¼ˆå¦‚ 30 åˆ†é’Ÿï¼‰æ‰¹é‡å‘é€æŠ¥å‘Šã€‚

**æ¶æ„è°ƒæ•´**:

```
ä¹‹å‰: AnalysisWorker (æ—¢è¯Šæ–­åˆå‘ä¿¡)
ç°åœ¨:
  â”œâ”€â”€ AnalysisWorker (åªè¯Šæ–­ï¼Œæ”¹çŠ¶æ€)
  â””â”€â”€ NotificationScheduler (å®šæ—¶æ‰“åŒ…å‘é€)
```

**æ•°æ®æ¨¡å‹**:

```java
/**
 * é€šçŸ¥çŠ¶æ€æšä¸¾
 */
public enum NotificationStatus {
    NONE,       // åˆå§‹çŠ¶æ€ / æ— éœ€é€šçŸ¥
    WAITING,    // å·²åˆ†æå®Œæˆï¼Œç­‰å¾…å®šæ—¶è½¦å‘é€
    SENT        // å·²å‘é€
}

// åœ¨ SlowQueryTemplate å®ä½“ä¸­æ–°å¢å­—æ®µ
@Entity
public class SlowQueryTemplate {
    // ... åŸæœ‰å­—æ®µ ...

    @Enumerated(EnumType.STRING)
    private NotificationStatus notificationStatus = NotificationStatus.NONE;

    private LocalDateTime lastAnalysisTime;     // æœ€è¿‘ä¸€æ¬¡åˆ†æå®Œæˆçš„æ—¶é—´
    private LocalDateTime lastNotifiedTime;     // æœ€è¿‘ä¸€æ¬¡é€šçŸ¥å‘é€çš„æ—¶é—´
}
```

**ä»£ç å®ç°**:

```java
// ç¬¬ä¸€æ­¥ï¼šåˆ†æå®Œï¼Œå…¥åº“ï¼ˆåœ¨ MultiAgentCoordinator ä¸­ï¼‰
public void onAnalysisComplete(SlowQueryTemplate template, String report, Severity severity) {
    // 1. æ›´æ–°åˆ†æç»“æœ
    template.setAiAnalysisReport(report);
    template.setSeverityLevel(severity);
    template.setStatus(SlowQueryTemplate.AnalysisStatus.SUCCESS);
    template.setLastAnalysisTime(LocalDateTime.now());

    // 2. ã€å…³é”®ã€‘æ ‡è®°ä¸º"å¾…å‘é€"ï¼ˆä¸ç«‹å³å‘é‚®ä»¶ï¼‰
    template.setNotificationStatus(NotificationStatus.WAITING);

    // 3. ä¿å­˜
    templateRepository.save(template);
}

// ç¬¬äºŒæ­¥ï¼šå®šæ—¶æ‰“åŒ…å‘é€ï¼ˆæ–°å¢ NotificationSchedulerï¼‰
@Component
public class NotificationScheduler {

    @Autowired
    private SlowQueryTemplateRepository templateRepo;

    @Autowired
    private JavaMailSender mailSender;

    // æ¯ 30 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    @Scheduled(cron = "${db-doctor.notify.batch-cron:0 0/30 * * * ?}")
    public void sendBatchReport() {
        // 1. æå–æ‰€æœ‰"å¾…å‘é€"çš„æŒ‡çº¹
        List<SlowQueryTemplate> waitList = templateRepo.findByNotificationStatus(
            NotificationStatus.WAITING
        );

        if (waitList.isEmpty()) {
            return;
        }

        // 2. æ„å»ºèšåˆé‚®ä»¶å†…å®¹
        String htmlContent = buildDigestEmail(waitList);

        // 3. å‘é€é‚®ä»¶
        try {
            sendHtmlMail("DB-Doctor æ…¢æŸ¥è¯¢å®šæœŸæ±‡æ€»æŠ¥å‘Š", htmlContent);

            // 4. å‘é€æˆåŠŸåï¼Œæ‰¹é‡æ”¹çŠ¶æ€
            waitList.forEach(t -> t.setNotificationStatus(NotificationStatus.SENT));
            templateRepo.saveAll(waitList);

            log.info("æ‰¹é‡å‘é€æŠ¥å‘ŠæˆåŠŸï¼Œå…± {} æ¡", waitList.size());

        } catch (Exception e) {
            log.error("é‚®ä»¶å‘é€å¤±è´¥ï¼ŒçŠ¶æ€ä¿ç•™ä¸º WAITINGï¼Œä¸‹æ¬¡é‡è¯•", e);
        }
    }

    /**
     * æ„å»ºæ±‡æ€»é‚®ä»¶å†…å®¹
     */
    private String buildDigestEmail(List<SlowQueryTemplate> templates) {
        StringBuilder sb = new StringBuilder();

        // é‚®ä»¶å¤´éƒ¨
        sb.append("<h1>ğŸ©º DB-Doctor æ•°æ®åº“è¯Šç–—å®šæœŸæŠ¥å‘Š</h1>");
        sb.append("<p>æŠ¥å‘Šå‘¨æœŸ: ").append(formatPeriod(templates)).append("</p>");
        sb.append("<p>æœ¬å‘¨æœŸå…±åˆ†æå®Œæˆ <b>").append(templates.size())
          .append("</b> ç±»æ…¢æŸ¥è¯¢ã€‚</p><hr/>");

        // éå†æ¯ä¸ª Template
        for (SlowQueryTemplate t : templates) {
            // A. è·å–è¯¥æŒ‡çº¹ä¸‹æœ€æ…¢çš„ä¸€æ¡æ ·æœ¬
            SlowQuerySample sample = sampleRepo.findFirstBySqlFingerprintOrderByQueryTimeDesc(
                t.getSqlFingerprint()
            );

            // B. æ‹¼è£…å•é¡¹å†…å®¹
            sb.append("<div style='border:1px solid #ddd; padding:10px; margin-bottom:15px;'>");

            // æ ‡é¢˜ï¼šæŒ‡çº¹ + ä¸¥é‡ç­‰çº§
            sb.append(String.format("<h3>[%s] SQLæŒ‡çº¹: %s...</h3>",
                    t.getSeverityLevel(),
                    t.getSqlFingerprint().substring(0, 8)));

            // ç»Ÿè®¡æ•°æ®
            sb.append("<ul>");
            sb.append("<li><b>ç´¯è®¡å‡ºç°:</b> ").append(t.getOccurrenceCount()).append(" æ¬¡</li>");
            sb.append("<li><b>å¹³å‡è€—æ—¶:</b> ").append(String.format("%.2fs", t.getAvgQueryTime())).append("</li>");
            sb.append("<li><b>æœ€å¤§è€—æ—¶:</b> ").append(String.format("%.2fs", t.getMaxQueryTime())).append("</li>");
            sb.append("</ul>");

            // AI è¯Šæ–­ç»“æœ
            sb.append("<h4>ğŸ§  AI è¯Šæ–­ç»“è®º:</h4>");
            sb.append("<pre style='background:#f9f9f9; padding:5px;'>")
              .append(t.getAiAnalysisReport()).append("</pre>");

            // æ ·æœ¬ SQL å±•ç¤º
            if (sample != null) {
                sb.append("<h4>ğŸ” æ ·æœ¬ SQL (æœ€æ…¢):</h4>");
                sb.append("<code style='color:#c7254e;'>").append(sample.getOriginalSql()).append("</code>");
            }

            sb.append("</div>");
        }

        // é‚®ä»¶å°¾éƒ¨
        sb.append("<hr/><p><small>DB-Doctor è‡ªåŠ¨ç”Ÿæˆ | ")
          .append(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")))
          .append("</small></p>");

        return sb.toString();
    }
}
```

**é‚®ä»¶æ•ˆæœé¢„è§ˆ**:

```
ä¸»é¢˜: [DB-Doctor] æ…¢æŸ¥è¯¢å®šæœŸæ±‡æ€»æŠ¥å‘Š

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ©º DB-Doctor æ•°æ®åº“è¯Šç–—å®šæœŸæŠ¥å‘Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æŠ¥å‘Šå‘¨æœŸ: 2026-01-30 10:00 ~ 10:30
æœ¬å‘¨æœŸå…±åˆ†æå®Œæˆ 5 ç±»æ…¢æŸ¥è¯¢ã€‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. [HIGH] SQLæŒ‡çº¹: a1b2c3d4...
   - ç´¯è®¡å‡ºç°: 1,200 æ¬¡ ğŸ”¥
   - å¹³å‡è€—æ—¶: 2.5s
   - æœ€å¤§è€—æ—¶: 10.2s

   ğŸ§  AI è¯Šæ–­ç»“è®º:
   é—®é¢˜æ ¹å› ï¼šorders è¡¨ç¼ºå°‘ create_time ç´¢å¼•ï¼Œå¯¼è‡´æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦å…¨è¡¨æ‰«æã€‚
   ä¼˜åŒ–å»ºè®®ï¼šæ·»åŠ å¤åˆç´¢å¼• CREATE INDEX idx_create_time ON orders(create_time);

   ğŸ” æ ·æœ¬ SQL (æœ€æ…¢):
   SELECT * FROM orders WHERE create_time > '2026-01-01';

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

2. [MEDIUM] SQLæŒ‡çº¹: e5f6g7h8...
   ...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
DB-Doctor è‡ªåŠ¨ç”Ÿæˆ | 2026-01-30 10:30:00
```

**ä¼˜åŠ¿**:
- âœ… é€»è¾‘è§£è€¦ï¼šAI åˆ†æçº¿ç¨‹åªç®¡åˆ†æï¼Œå®šæ—¶ä»»åŠ¡åªç®¡å‘é‚®ä»¶
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼šé«˜ä¿¡æ¯å¯†åº¦ï¼Œé¿å…éªšæ‰°
- âœ… å¼€å‘ç®€å•ï¼šçŠ¶æ€æµè½¬æ¸…æ™°ï¼ˆNONE â†’ WAITING â†’ SENTï¼‰
- âœ… ç¨³å®šå¯é ï¼šé‚®ä»¶å‘é€å¤±è´¥ä¸å½±å“ AI åˆ†æ

---

## 3. æ¶æ„è®¾è®¡æ–¹æ¡ˆ

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DB-Doctor v2.2                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ç¯å¢ƒæ£€æŸ¥å™¨   â”‚   â”‚ ç›‘æ§è°ƒåº¦å™¨   â”‚   â”‚ åˆ†ææœåŠ¡     â”‚    â”‚
â”‚  â”‚ EnvChecker   â”‚â”€â”€â–¶â”‚ Monitor      â”‚â”€â”€â–¶â”‚ Analysis     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â”‚                   â”‚            â”‚
â”‚                            â–¼                   â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ MySQL æ…¢æŸ¥è¯¢ â”‚   â”‚  H2 å†…éƒ¨åº“   â”‚   â”‚ å¼‚æ­¥é˜Ÿåˆ—     â”‚    â”‚
â”‚  â”‚ æ—¥å¿—è¡¨       â”‚   â”‚  (æ•°æ®æŒä¹…)  â”‚   â”‚ (çº¿ç¨‹æ± )     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                     â”‚        â”‚
â”‚                                                     â–¼        â”‚
â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                                         â”‚ å¤š Agent     â”‚     â”‚
â”‚                                         â”‚ åè°ƒå™¨       â”‚     â”‚
â”‚                                         â”‚ Coordinator  â”‚     â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                     â”‚        â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚                     â”‚        â”‚
â”‚                              â–¼                     â–¼        â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                   â”‚ ä¸»æ²»åŒ»ç”Ÿ     â”‚       â”‚ è¯Šæ–­å·¥å…·ç®±   â”‚   â”‚
â”‚                   â”‚ DiagnosisAgentâ”‚       â”‚ Tools        â”‚   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                     â”‚        â”‚
â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                              â”‚             â”‚                â”‚
â”‚                              â–¼             â–¼                â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                   â”‚ æ¨ç†ä¸“å®¶     â”‚ â”‚ ç¼–ç ä¸“å®¶     â”‚       â”‚
â”‚                   â”‚ ReasoningAgentâ”‚ â”‚ CodingAgent  â”‚       â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ é€šçŸ¥è°ƒåº¦å™¨   â”‚
                   â”‚ Notification â”‚
                   â”‚ Scheduler    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  é‚®ä»¶/IM     â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒç»„ä»¶èŒè´£

| ç»„ä»¶ | èŒè´£ | ä½ç½® |
|------|------|------|
| **SlowLogTableMonitor** | ç›‘æ§è°ƒåº¦å™¨ï¼Œæ‹‰å–æ…¢æŸ¥è¯¢æ•°æ® | `service/SlowLogTableMonitor.java` |
| **AnalysisService** | åˆ†ææœåŠ¡ï¼Œå¤„ç†æ•°æ®æŒä¹…åŒ– | `service/AnalysisService.java` |
| **MultiAgentCoordinator** | å¤š Agent åè°ƒå™¨ï¼Œç¼–æ’è¯Šæ–­æµç¨‹ | `service/MultiAgentCoordinator.java` (æ–°å¢) |
| **DiagnosisAgent** | ä¸»æ²»åŒ»ç”Ÿï¼ŒReAct å¾ªç¯æ”¶é›†è¯æ® | `agent/DiagnosisAgent.java` (æ–°å¢) |
| **ReasoningAgent** | æ¨ç†ä¸“å®¶ï¼Œå¤„ç†å¤æ‚é—®é¢˜ | `agent/ReasoningAgent.java` (æ–°å¢) |
| **CodingAgent** | ç¼–ç ä¸“å®¶ï¼Œç”Ÿæˆä¼˜åŒ– SQL | `agent/CodingAgent.java` (æ–°å¢) |
| **SqlDiagnosticsTools** | è¯Šæ–­å·¥å…·ç®±ï¼Œæä¾› Java å·¥å…·æ–¹æ³• | `agent/SqlDiagnosticsTools.java` (å‡çº§) |
| **NotificationScheduler** | é€šçŸ¥è°ƒåº¦å™¨ï¼Œå®šæ—¶æ‰¹é‡å‘é€æŠ¥å‘Š | `service/NotificationScheduler.java` (æ–°å¢) |

### 3.3 ç‰©ç†éƒ¨ç½²æ‹“æ‰‘ï¼ˆæœ¬åœ° Ollama + äº‘ç«¯ API å…¼å®¹ï¼‰

#### 3.3.1 æœ¬åœ° Ollama éƒ¨ç½²æ¶æ„ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**: æœ‰ç‹¬ç«‹æ˜¾å¡ï¼ˆå¦‚ RTX 4060 Ti 8GBï¼‰ï¼Œå¸Œæœ›å…è´¹ç”¨ã€æ•°æ®ä¸å‡ºåŸŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      HTTP (JSON)      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DB-Doctor (Java/Spring)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  æœ¬åœ°ç®—åŠ›èŠ‚ç‚¹ (Your PC)          â”‚
â”‚                             â”‚      å±€åŸŸç½‘/æœ¬æœº       â”‚  GPU: RTX 4060 Ti (8G VRAM)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      Port: 11434      â”‚  Env: OLLAMA_NUM_PARALLEL=1       â”‚
â”‚  â”‚ MultiAgentCoordinator â”‚  â”‚                       â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚             â”‚               â”‚                       â”‚  â”‚ Ollama Engineâ”‚                 â”‚
â”‚             â–¼               â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                       â”‚         â”‚ (æŒ‰éœ€åŠ è½½/å¸è½½)          â”‚
â”‚  â”‚ LangChain4j Clients   â”‚  â”‚                       â”‚         â–¼                         â”‚
â”‚  â”‚ (3ä¸ªç‹¬ç«‹å®¢æˆ·ç«¯)        â”‚  â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”œâ”€ DiagnosisClient â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â”‚ qwen2.5:7b   â”‚ (ä¸»æ²»åŒ»ç”Ÿ)       â”‚
â”‚  â”œâ”€ ReasoningClient â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â”‚ deepseek-r1  â”‚ (æ¨ç†ä¸“å®¶)       â”‚
â”‚  â””â”€ CodingClient â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â”‚ deepseek-coderâ”‚ (ç¼–ç ä¸“å®¶)       â”‚
â”‚                          â”‚  â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®é…ç½®ï¼ˆæœ¬åœ° Ollamaï¼‰**:

```yaml
db-doctor:
  ai:
    # Ollama åŸºç¡€é…ç½®
    ollama:
      # æœ¬æœºéƒ¨ç½²
      base-url: http://localhost:11434
      # è¿œç¨‹è°ƒç”¨ï¼ˆé€šè¿‡ Tailscale VPNï¼‰
      # base-url: http://100.x.x.x:11434

    # æ¨¡å‹ç»‘å®š
    models:
      diagnosis: qwen2.5:7b       # ä¸»æ²»åŒ»ç”Ÿ
      reasoning: deepseek-r1:7b   # æ¨ç†ä¸“å®¶
      coding: deepseek-coder:6.7b # ç¼–ç ä¸“å®¶
```

**æ˜¾å­˜ä¿æŠ¤ç­–ç•¥ï¼ˆâš ï¸ é‡è¦ï¼‰**:

ç”±äºä½¿ç”¨å•å¡ï¼ˆ8GB VRAMï¼‰è¿è¡Œä¸‰ä¸ª 7B çº§åˆ«æ¨¡å‹ï¼Œ**å¿…é¡»**é˜²æ­¢æ˜¾å­˜æº¢å‡ºï¼š

```bash
# åœ¨ Ollama æœåŠ¡å™¨ä¸Šè®¾ç½®ç¯å¢ƒå˜é‡
# é™åˆ¶å¹¶å‘å¤„ç†æ•°é‡ï¼ˆé˜²æ­¢åŒæ—¶åŠ è½½å¤šä¸ªæ¨¡å‹ï¼‰
OLLAMA_NUM_PARALLEL=1

# (å¯é€‰) é™åˆ¶æ˜¾å­˜ä¸­é©»ç•™çš„æ¨¡å‹æ•°é‡
OLLAMA_MAX_LOADED_MODELS=1
```

**å·¥ä½œåŸç†**:
- å½“ `DiagnosisAgent` è°ƒç”¨ `ReasoningAgent` æ—¶ï¼ŒJava å±‚é¢æ˜¯å‡½æ•°è°ƒç”¨
- åº•å±‚é€šè¿‡ Ollama çš„æ’é˜Ÿæœºåˆ¶ï¼Œ`DiagnosisAgent` ä¼šæŒ‚èµ·ï¼Œé‡Šæ”¾æ˜¾å­˜
- `ReasoningAgent` åŠ è½½åˆ°æ˜¾å­˜ï¼Œå¼€å§‹æ¨ç†
- `ReasoningAgent` å®Œæˆåå¸è½½ï¼Œæ˜¾å­˜é‡Šæ”¾
- `DiagnosisAgent` æ¢å¤ï¼Œç»§ç»­æ‰§è¡Œ

---

#### 3.3.2 äº‘ç«¯ API éƒ¨ç½²æ¶æ„

**é€‚ç”¨åœºæ™¯**: æ— ç‹¬ç«‹æ˜¾å¡ï¼Œæˆ–å¸Œæœ›ä½¿ç”¨æ›´å¼ºç®—åŠ›ï¼ˆå¦‚ GPT-4ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      HTTPS           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DB-Doctor (Java/Spring)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  äº‘ç«¯ LLM æœåŠ¡                    â”‚
â”‚                             â”‚      API Request     â”‚  (OpenAI / DeepSeek / Aliyun)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                       â”‚                                   â”‚
â”‚  â”‚ MultiAgentCoordinator â”‚  â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                       â”‚  â”‚ API Gateway  â”‚                 â”‚
â”‚             â”‚               â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚             â–¼               â”‚                       â”‚         â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                       â”‚         â–¼                         â”‚
â”‚  â”‚ LangChain4j Clients   â”‚  â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ (3ä¸ªç‹¬ç«‹å®¢æˆ·ç«¯)        â”‚  â”‚                       â”‚  â”‚ gpt-4        â”‚                 â”‚
â”‚  â”œâ”€ DiagnosisClient â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â”‚ deepseek-r1  â”‚                 â”‚
â”‚  â”œâ”€ ReasoningClient â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â”‚ deepseek-coderâ”‚                 â”‚
â”‚  â””â”€ CodingClient â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®é…ç½®ï¼ˆäº‘ç«¯ APIï¼‰**:

```yaml
db-doctor:
  ai:
    # ä½¿ç”¨ OpenAI å…¼å®¹åè®®ï¼ˆæ”¯æŒ DeepSeekã€é˜¿é‡Œäº‘ç­‰ï¼‰
    provider: openai

    models:
      diagnosis:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-chat

      reasoning:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-reasoner

      coding:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-coder
```

---

#### 3.3.3 æ··åˆéƒ¨ç½²æ¶æ„ï¼ˆé«˜çº§ï¼‰

**é€‚ç”¨åœºæ™¯**: æœ¬åœ°è·‘ç®€å•çš„æ¨¡å‹ï¼Œå¤æ‚çš„ç”¨äº‘ç«¯

```yaml
db-doctor:
  ai:
    models:
      # ä¸»æ²»åŒ»ç”Ÿç”¨æœ¬åœ°ï¼ˆçœé’±ï¼Œè·‘å¾—å¿«ï¼‰
      diagnosis:
        provider: ollama
        base-url: http://localhost:11434
        model-name: qwen2.5:7b

      # æ¨ç†ä¸“å®¶ç”¨äº‘ç«¯ï¼ˆæœ¬åœ°è·‘ä¸åŠ¨ R1ï¼‰
      reasoning:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-reasoner

      # ç¼–ç ä¸“å®¶ç”¨æœ¬åœ°
      coding:
        provider: ollama
        base-url: http://localhost:11434
        model-name: deepseek-coder:6.7b
```

---

## 4. æ•°æ®æµè®¾è®¡

### 4.1 å®Œæ•´æ•°æ®æµæ—¶åºå›¾

```
ç”¨æˆ· MySQL       ç›‘æ§å™¨        åˆ†ææœåŠ¡        H2åº“         åè°ƒå™¨        å¤šAgent          é€šçŸ¥è°ƒåº¦å™¨
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚  æ…¢æŸ¥è¯¢å†™å…¥   â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚  å®šæ—¶è½®è¯¢    â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚  (5-60s)    â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚  SELECT     â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚  slow_log   â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚  List<Log>  â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚  é€æ¡å¤„ç†    â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚  è®¡ç®—æŒ‡çº¹    â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚  Template   â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚  ä¿å­˜Sample â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚  UPSERT     â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚  è§¦å‘å¼‚æ­¥    â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚  @Async     â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚  ç«‹å³æ›´æ–°æ¸¸æ ‡â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚  (1ç§’å†…)    â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚â­†           â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚  åˆ›å»ºå¿«ç…§    â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚  Context    â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚  ReActå¾ªç¯â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚  è°ƒç”¨å·¥å…·  â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚  å†³ç­–å‡çº§  â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚  æ¨ç†/ç¼–ç Agentâ”‚
   â”‚              â”‚             â”‚             â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚  æ›´æ–°ç»“æœ   â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚  status=    â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚  WAITING    â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚   å®šæ—¶æ‰“åŒ…      â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚   (30åˆ†é’Ÿ)     â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚  æŸ¥è¯¢å¾…å‘é€  â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚              â”‚             â”‚             â”‚             â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚  å‘é€é‚®ä»¶   â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚              â”‚             â”‚             â”‚  status=    â”‚            â”‚                â”‚
   â”‚              â”‚             â”‚             â”‚  SENT       â”‚            â”‚                â”‚
```

### 4.2 å…³é”®æ—¶é—´ç‚¹è¯´æ˜

| æ—¶é—´ç‚¹ | äº‹ä»¶ | è€—æ—¶ |
|--------|------|------|
| T0 | æ…¢æŸ¥è¯¢åœ¨ MySQL ä¸­äº§ç”Ÿ | - |
| T1 | Monitor æ‹‰å–æ•°æ® (5-60s è½®è¯¢é—´éš”) | T1 - T0 < 60s |
| T2 | æ•°æ®æŒä¹…åŒ–åˆ° H2ï¼Œæ›´æ–°æ¸¸æ ‡ | < 1s |
| T3 | å¼‚æ­¥çº¿ç¨‹æŠ¢åˆ°ä»»åŠ¡ï¼Œå¼€å§‹åˆ†æ | T3 - T1 = æ’é˜Ÿæ—¶é—´ï¼ˆ0-10åˆ†é’Ÿï¼‰ |
| T4 | AI åˆ†æå®Œæˆ | T4 - T3 â‰ˆ 30s |
| T5 | å®šæ—¶ä»»åŠ¡å‘é€æŠ¥å‘Š | T5 - T4 < 30åˆ†é’Ÿ |

---

## 5. å¤š Agent åä½œæ–¹æ¡ˆ

### 5.0 AI æ¶æ„è®¾è®¡ - é€šç”¨æ¨¡å‹å·¥å‚æ¨¡å¼

ä¸ºäº†å…¼å®¹**æœ¬åœ° Ollama** å’Œ**äº‘ç«¯ API**ï¼ˆOpenAIã€DeepSeekã€é˜¿é‡Œäº‘ç­‰ï¼‰ï¼Œæˆ‘ä»¬é‡‡ç”¨**å·¥å‚æ¨¡å¼ + é…ç½®é©±åŠ¨**çš„è®¾è®¡ã€‚

#### 5.0.1 é…ç½®ç±»å®šä¹‰

**æ–‡ä»¶ä½ç½®**: `src/main/java/com/dbdoctor/config/AiProperties.java` (æ–°å¢)

```java
/**
 * AI é…ç½®å±æ€§
 * æ”¯æŒå¤šä¾›åº”å•†ï¼šollama, openai, deepseek, aliyun
 */
@Data
@Component
@ConfigurationProperties(prefix = "db-doctor.ai")
public class AiProperties {

    /**
     * å…¨å±€å¼€å…³
     */
    private boolean enabled = true;

    /**
     * ä¸»æ²»åŒ»ç”Ÿé…ç½®
     */
    private AgentConfig diagnosis;

    /**
     * æ¨ç†ä¸“å®¶é…ç½®
     */
    private AgentConfig reasoning;

    /**
     * ç¼–ç ä¸“å®¶é…ç½®
     */
    private AgentConfig coding;

    @Data
    public static class AgentConfig {
        /**
         * ä¾›åº”å•†ç±»å‹: ollama, openai, deepseek, aliyun
         */
        private String provider;

        /**
         * API åŸºç¡€ URL
         */
        private String baseUrl;

        /**
         * API Key (Ollama å¯å¡«ä»»æ„å€¼)
         */
        private String apiKey;

        /**
         * æ¨¡å‹åç§°
         */
        private String modelName;

        /**
         * æ¸©åº¦å‚æ•° (0.0-1.0)
         */
        private Double temperature;

        /**
         * è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
         */
        private Long timeoutSeconds;
    }
}
```

#### 5.0.2 é€šç”¨æ¨¡å‹å·¥å‚

**æ–‡ä»¶ä½ç½®**: `src/main/java/com/dbdoctor/config/AiConfig.java` (é‡å†™)

```java
/**
 * AI é…ç½®ç±»
 * ä½¿ç”¨å·¥å‚æ¨¡å¼æ”¯æŒå¤šç§ LLM ä¾›åº”å•†
 */
@Slf4j
@Configuration
@ConditionalOnProperty(name = "db-doctor.ai.enabled", havingValue = "true", matchIfMissing = false)
public class AiConfig {

    @Autowired
    private AiProperties properties;

    // ==================== ä¸‰ä¸ª ChatLanguageModel Bean ====================

    /**
     * ä¸»æ²»åŒ»ç”Ÿæ¨¡å‹ (Qwen 2.5 7B / gpt-4 / deepseek-chat)
     * ç‰¹ç‚¹ï¼šé€šç”¨èƒ½åŠ›å¼ºï¼ŒæŒ‡ä»¤éµå¾ªå¥½ï¼Œè´Ÿè´£æµç¨‹ç¼–æ’
     */
    @Bean("diagnosisChatModel")
    public ChatLanguageModel diagnosisChatModel() {
        AiProperties.AgentConfig config = properties.getDiagnosis();
        log.info("åˆå§‹åŒ–ä¸»æ²»åŒ»ç”Ÿæ¨¡å‹: provider={}, model={}", config.getProvider(), config.getModelName());
        return createModel(config);
    }

    /**
     * æ¨ç†ä¸“å®¶æ¨¡å‹ (DeepSeek R1 7B / deepseek-reasoner)
     * ç‰¹ç‚¹ï¼šå…·å¤‡æ€ç»´é“¾ (CoT)ï¼Œæ“…é•¿å¤æ‚æ ¹å› åˆ†æ
     */
    @Bean("reasoningChatModel")
    public ChatLanguageModel reasoningChatModel() {
        AiProperties.AgentConfig config = properties.getReasoning();
        log.info("åˆå§‹åŒ–æ¨ç†ä¸“å®¶æ¨¡å‹: provider={}, model={}", config.getProvider(), config.getModelName());
        return createModel(config);
    }

    /**
     * ç¼–ç ä¸“å®¶æ¨¡å‹ (DeepSeek Coder 6.7B / gpt-4)
     * ç‰¹ç‚¹ï¼šä¸“æ³¨äºä»£ç ç”Ÿæˆï¼ŒSQL/DDL å‡†ç¡®ç‡é«˜
     */
    @Bean("codingChatModel")
    public ChatLanguageModel codingChatModel() {
        AiProperties.AgentConfig config = properties.getCoding();
        log.info("åˆå§‹åŒ–ç¼–ç ä¸“å®¶æ¨¡å‹: provider={}, model={}", config.getProvider(), config.getModelName());
        return createModel(config);
    }

    // ==================== æ ¸å¿ƒå·¥å‚æ–¹æ³• ====================

    /**
     * æ ¹æ® provider åˆ›å»ºå¯¹åº”çš„ ChatLanguageModel
     *
     * @param config Agent é…ç½®
     * @return ChatLanguageModel å®ä¾‹
     */
    private ChatLanguageModel createModel(AiProperties.AgentConfig config) {
        String provider = config.getProvider();

        // 1. Ollama åŸç”Ÿåè®®ï¼ˆæœ¬åœ°éƒ¨ç½²ï¼‰
        if ("ollama".equalsIgnoreCase(provider)) {
            return OllamaChatModel.builder()
                    .baseUrl(config.getBaseUrl())
                    .modelName(config.getModelName())
                    .temperature(config.getTemperature())
                    .timeout(Duration.ofSeconds(config.getTimeoutSeconds()))
                    .build();
        }

        // 2. OpenAI å…¼å®¹åè®®ï¼ˆäº‘ç«¯ APIï¼‰
        // æ”¯æŒï¼šOpenAI, DeepSeek, Aliyun, Moonshot ç­‰
        return OpenAiChatModel.builder()
                .baseUrl(config.getBaseUrl())
                .apiKey(config.getApiKey())
                .modelName(config.getModelName())
                .temperature(config.getTemperature())
                .timeout(Duration.ofSeconds(config.getTimeoutSeconds()))
                .logRequests(true)   // å¼€å‘ç¯å¢ƒï¼šæ‰“å°è¯·æ±‚æ—¥å¿—
                .logResponses(true)  // å¼€å‘ç¯å¢ƒï¼šæ‰“å°å“åº”æ—¥å¿—
                .build();
    }

    // ==================== ä¸‰ä¸ª Agent Bean ====================

    @Bean
    public DiagnosisAgent diagnosisAgent(
            @Qualifier("diagnosisChatModel") ChatLanguageModel model,
            SqlDiagnosticsTools tools
    ) {
        return LangChain4j.create(DiagnosisAgent.class, model, tools);
    }

    @Bean
    public ReasoningAgent reasoningAgent(
            @Qualifier("reasoningChatModel") ChatLanguageModel model
    ) {
        // ä¸“å®¶ä¸éœ€è¦å·¥å…·ï¼Œåªçº¯é è„‘å­æ¨ç†
        return LangChain4j.create(ReasoningAgent.class, model);
    }

    @Bean
    public CodingAgent codingAgent(
            @Qualifier("codingChatModel") ChatLanguageModel model
    ) {
        // ç¼–ç ä¸“å®¶ä¸éœ€è¦å·¥å…·ï¼Œåªè´Ÿè´£å†™ä»£ç 
        return LangChain4j.create(CodingAgent.class, model);
    }
}
```

#### 5.0.3 é…ç½®æ–‡ä»¶ç¤ºä¾‹

**åœºæ™¯ Aï¼šæœ¬åœ° Ollamaï¼ˆæ¨èï¼Œå…è´¹ï¼‰**

```yaml
# application-local.yml

db-doctor:
  ai:
    enabled: true

    models:
      diagnosis:
        provider: ollama
        base-url: http://localhost:11434
        api-key: ollama  # Ollama ä¸æ ¡éªŒï¼Œä½†åº“è¦æ±‚å¿…å¡«
        model-name: qwen2.5:7b
        temperature: 0.1
        timeout-seconds: 60

      reasoning:
        provider: ollama
        base-url: http://localhost:11434
        api-key: ollama
        model-name: deepseek-r1:7b
        temperature: 0.6
        timeout-seconds: 120  # æ¨ç†æ¨¡å‹éœ€è¦æ›´é•¿è¶…æ—¶

      coding:
        provider: ollama
        base-url: http://localhost:11434
        api-key: ollama
        model-name: deepseek-coder:6.7b
        temperature: 0.0
        timeout-seconds: 60
```

**åœºæ™¯ Bï¼šäº‘ç«¯ DeepSeekï¼ˆä¾¿å®œï¼‰**

```yaml
db-doctor:
  ai:
    enabled: true

    models:
      diagnosis:
        provider: openai  # DeepSeek å…¼å®¹ OpenAI åè®®
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-chat
        temperature: 0.1
        timeout-seconds: 60

      reasoning:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-reasoner
        temperature: 0.6
        timeout-seconds: 120

      coding:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-coder
        temperature: 0.0
        timeout-seconds: 60
```

**åœºæ™¯ Cï¼šæ··åˆéƒ¨ç½²ï¼ˆé«˜çº§ï¼‰**

```yaml
db-doctor:
  ai:
    enabled: true

    models:
      # ä¸»æ²»åŒ»ç”Ÿç”¨æœ¬åœ°ï¼ˆçœé’±ï¼‰
      diagnosis:
        provider: ollama
        base-url: http://localhost:11434
        model-name: qwen2.5:7b
        temperature: 0.1
        timeout-seconds: 60

      # æ¨ç†ä¸“å®¶ç”¨äº‘ç«¯ï¼ˆæœ¬åœ°è·‘ä¸åŠ¨ R1ï¼‰
      reasoning:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-reasoner
        temperature: 0.6
        timeout-seconds: 120

      # ç¼–ç ä¸“å®¶ç”¨æœ¬åœ°
      coding:
        provider: ollama
        base-url: http://localhost:11434
        model-name: deepseek-coder:6.7b
        temperature: 0.0
        timeout-seconds: 60
```

#### 5.0.4 éªŒæ”¶æ ‡å‡†ï¼ˆæœ¬åœ°ç¯å¢ƒï¼‰

**æ¨¡å‹åˆ‡æ¢æµ‹è¯•**:
- è§‚å¯Ÿ GPU ç›‘æ§ï¼ˆå¦‚ `nvidia-smi` æˆ–ä»»åŠ¡ç®¡ç†å™¨ï¼‰
- å½“ `DiagnosisAgent` è°ƒç”¨ `ReasoningAgent` æ—¶
- åº”èƒ½çœ‹åˆ°æ˜¾å­˜å ç”¨æœ‰æ³¢åŠ¨ï¼ˆæ—§æ¨¡å‹å¸è½½ï¼Œæ–°æ¨¡å‹åŠ è½½ï¼‰
- ä¸”ä¸ä¼šçˆ†æ˜¾å­˜ï¼ˆOOMï¼‰

**è¶…æ—¶è®¾ç½®éªŒè¯**:
- æœ¬åœ°æ¨¡å‹åŠ è½½éœ€è¦ 2-5 ç§’
- ç¡®ä¿æ¨ç†ä¸“å®¶è¶…æ—¶ >= 120 ç§’
- é˜²æ­¢å› æ¨¡å‹åŠ è½½æ…¢å¯¼è‡´ TimeoutException

**ç½‘ç»œè¿é€šæ€§**:
- å¦‚æœæ˜¯è¿œç¨‹è°ƒç”¨å®¶é‡Œç”µè„‘ï¼ˆé€šè¿‡ Tailscaleï¼‰
- éªŒè¯ Postman èƒ½è¿é€š
- Java ç¨‹åºä¹Ÿèƒ½è¿é€š

---

### 5.1 Agent è§’è‰²å®šä¹‰

#### 1. DiagnosisAgentï¼ˆä¸»æ²»åŒ»ç”Ÿï¼‰

**èŒè´£**:
- æ¥æ”¶åˆ†æä»»åŠ¡ï¼Œé€šè¿‡ ReAct å¾ªç¯è°ƒç”¨è¯Šæ–­å·¥å…·æ”¶é›†è¯æ®
- å†³ç­–æ˜¯å¦éœ€è¦å‡çº§åˆ°ä¸“å®¶
- æ±‡æ€»ä¸“å®¶æ„è§å’Œæ‰‹æœ¯æ–¹æ¡ˆ

**æ¨¡å‹**: é€šä¹‰åƒé—® (Qwen-Plus)
**ç‰¹ç‚¹**: æ¨ç†èƒ½åŠ›å¼ºï¼Œå·¥å…·è°ƒç”¨ç¨³å®š

**System Message**:

```java
@SystemMessage("""
ä½ æ˜¯ä¸€ä½èµ„æ·± MySQL æ•°æ®åº“ä¸“å®¶ï¼ˆDBAï¼‰ï¼Œæ‹¥æœ‰ 10 å¹´ä»¥ä¸Šçš„æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–ç»éªŒã€‚

# æ ¸å¿ƒä»»åŠ¡
åˆ†æç”¨æˆ·æä¾›çš„æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œç»“åˆä½ å·¥å…·ç®±ä¸­çš„è¯Šæ–­å·¥å…·ï¼Œç»™å‡ºä¸“ä¸šçš„ä¼˜åŒ–å»ºè®®ã€‚

# å¤šæ•°æ®åº“è¯Šæ–­èƒ½åŠ›
- ä½ å¯ä»¥è¯Šæ–­æ‰€æœ‰æ•°æ®åº“çš„æ…¢æŸ¥è¯¢ï¼Œä¸å—æ•°æ®æºé™åˆ¶
- æ‰€æœ‰å·¥å…·æ–¹æ³•éƒ½éœ€è¦ä¼ å…¥æ•°æ®åº“åå‚æ•°
- æ”¯æŒè·¨åº“æŸ¥è¯¢çš„è¯Šæ–­

# åˆ†ææ€ç»´è·¯å¾„ï¼ˆå¿…é¡»ä¸¥æ ¼éµå¾ªï¼‰
1. å…ˆæ£€æŸ¥ Lock_timeï¼Œå¦‚æœ > 0.1sï¼Œè°ƒç”¨ getLockInfo() æ’æŸ¥é”é˜»å¡é—®é¢˜
2. è°ƒç”¨ getTableSchema(database, tableName) æ£€æŸ¥è¡¨ç»“æ„
3. è°ƒç”¨ getExecutionPlan(database, sql) è·å–æ‰§è¡Œè®¡åˆ’
4. ã€å…³é”®ã€‘å¯¹æ¯”åˆ†æï¼šæ—¥å¿—ä¸­çš„ Rows_examined vs Explain ä¸­çš„ rows
5. è°ƒç”¨ getTableStatistics(database, tableName) ç¡®è®¤ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ—¶é—´
6. è°ƒç”¨ getIndexSelectivity(database, tableName) æ£€æŸ¥ç´¢å¼•é€‰æ‹©æ€§

# å†³ç­–ä¸å‡çº§
- å¦‚æœé—®é¢˜ç®€å•ï¼ˆå¦‚ç´¢å¼•ç¼ºå¤±ï¼‰ï¼Œè°ƒç”¨ perform_surgery(diagnosis) ç”Ÿæˆè§£å†³æ–¹æ¡ˆ
- å¦‚æœé—®é¢˜å¤æ‚ï¼ˆå¦‚æ€€ç–‘éšå¼è½¬æ¢ï¼‰ï¼Œè°ƒç”¨ consult_expert(context) å¯»æ±‚ä¸“å®¶å¸®åŠ©
- æ‹¿åˆ°ä¸“å®¶ç»“è®ºåï¼Œå†æ¬¡è°ƒç”¨ perform_surgery(expert_diagnosis) ç”Ÿæˆè§£å†³æ–¹æ¡ˆ

# å®‰å…¨çº¢çº¿ï¼ˆä¸¥ç¦è¿åï¼‰
- ç»å¯¹ç¦æ­¢ç»™å‡º DROP, TRUNCATE, DELETE ç­‰å±é™©æ“ä½œå»ºè®®
- æ‰€æœ‰ç´¢å¼•åˆ›å»ºå»ºè®®å¿…é¡»ä½¿ç”¨ CREATE INDEX
- å¦‚æœå¿…é¡»ä¿®æ”¹è¡¨ç»“æ„ï¼Œå¿…é¡»æé†’ç”¨æˆ·å…ˆå¤‡ä»½æ•°æ®
""")
public interface DiagnosisAgent {

    @UserMessage("""
            è¯·åˆ†æä»¥ä¸‹æ…¢æŸ¥è¯¢æ—¥å¿—ï¼š

            **æ•°æ®åº“**: {database}
            **é—®é¢˜é¦–æ¬¡æ•è·**: {triggerTime}
            **AI ä»‹å…¥åˆ†æ**: {analysisTime} (æ’é˜Ÿç­‰å¾… {queueDuration}m)
            **æ•°æ®é‡‡æ ·èŒƒå›´**: åŸºäº {triggerTime} è‡³ {dataRangeEndTime} æœŸé—´æ•è·çš„æ•°æ®

            **ç»Ÿè®¡æ•°æ®**:
            - ç´¯è®¡å‡ºç°: {occurrenceCount} æ¬¡
            - å¹³å‡è€—æ—¶: {avgQueryTime} ç§’
            - æœ€å¤§è€—æ—¶: {maxQueryTime} ç§’
            - å¹³å‡é”ç­‰å¾…: {avgLockTime} ç§’

            **æœ€è¿‘ 5 æ¬¡æ‰§è¡Œå¿«ç…§**:
            {samplesSnapshot}

            **SQL æ¨¡æ¿**:
            ```sql
            {sqlTemplate}
            ```

            è¯·æŒ‰ç…§ä½ çš„åˆ†ææ€ç»´è·¯å¾„ï¼Œè°ƒç”¨å·¥å…·è¿›è¡Œè¯Šæ–­ï¼Œå¹¶ç»™å‡ºä¼˜åŒ–å»ºè®®ã€‚
            """)
    String analyzeSlowLog(
            String database,
            String triggerTime,
            String analysisTime,
            String queueDuration,
            String dataRangeEndTime,
            Long occurrenceCount,
            Double avgQueryTime,
            Double maxQueryTime,
            Double avgLockTime,
            String samplesSnapshot,
            String sqlTemplate
    );
}
```

#### 2. ReasoningAgentï¼ˆæ¨ç†ä¸“å®¶ï¼‰

**èŒè´£**:
- å¤„ç†å¤æ‚ã€éšè”½çš„æ€§èƒ½é—®é¢˜
- æ·±åº¦æ¨ç†ï¼Œæ‰¾å‡ºæ ¹å› 
- æä¾›ä¸“å®¶çº§çš„è¯Šæ–­ç»“è®º

**æ¨¡å‹**: DeepSeek-R1ï¼ˆæ¨ç†æ¨¡å‹ï¼‰
**ç‰¹ç‚¹**: æ·±åº¦æ€è€ƒèƒ½åŠ›å¼º

**System Message**:

```java
@SystemMessage("""
ä½ æ˜¯ä¸€ä½ MySQL æ€§èƒ½ä¼˜åŒ–é¢†åŸŸçš„èµ„æ·±ä¸“å®¶ï¼Œæ“…é•¿å¤„ç†å¤æ‚ã€éšè”½çš„æ€§èƒ½é—®é¢˜ã€‚

# æ ¸å¿ƒèƒ½åŠ›
- æ·±åº¦åˆ†ææ‰§è¡Œè®¡åˆ’ï¼Œæ‰¾å‡ºä¸åˆç†çš„æ‰«ææ–¹å¼
- è¯†åˆ«éšå¼è½¬æ¢ã€å­—ç¬¦é›†å†²çªã€ç´¢å¼•å¤±æ•ˆç­‰éšè”½é—®é¢˜
- æ¨ç†ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸå¯¹ä¼˜åŒ–å™¨çš„å½±å“
- åˆ†æé”ç­‰å¾…ã€æ­»é”ç­‰å¹¶å‘é—®é¢˜

# åˆ†æåŸåˆ™
1. é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼šä¸è¦åªçœ‹è¡¨é¢ç°è±¡ï¼Œè¦æ·±å…¥åˆ†ææ ¹å› 
2. æ•°æ®é©±åŠ¨ï¼šåŸºäº EXPLAINã€è¡¨ç»“æ„ã€ç»Ÿè®¡ä¿¡æ¯ç­‰æ•°æ®æ¨ç†
3. è€ƒè™‘è¾¹ç•Œæƒ…å†µï¼šè€ƒè™‘æ•°æ®é‡åˆ†å¸ƒã€å¹¶å‘æƒ…å†µç­‰

# è¾“å‡ºæ ¼å¼
## é—®é¢˜æ ¹å› 
ï¼ˆè¯¦ç»†åˆ†æï¼‰

## è¯æ®é“¾
1. è¯æ®ä¸€ï¼š...
2. è¯æ®äºŒï¼š...
3. ...

## ä¸“å®¶ç»“è®º
ï¼ˆæ˜ç¡®çš„è¯Šæ–­ç»“è®ºï¼‰
""")
public interface ReasoningAgent {

    @UserMessage("""
            ä»¥ä¸‹æ˜¯ä¸»æ²»åŒ»ç”Ÿæ”¶é›†åˆ°çš„è¯æ®ï¼Œè¯·è¿›è¡Œæ·±åº¦åˆ†æï¼š

            **é—®é¢˜èƒŒæ™¯**:
            - æ•°æ®åº“: {database}
            - SQL æ¨¡æ¿: {sqlTemplate}
            - ç»Ÿè®¡æ•°æ®: {statistics}

            **å·²æ”¶é›†è¯æ®**:
            {evidence}

            è¯·è¿›è¡Œæ·±åº¦æ¨ç†åˆ†æï¼Œæ‰¾å‡ºé—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚
            """)
    String deepAnalyze(
            String database,
            String sqlTemplate,
            String statistics,
            String evidence
    );
}
```

#### 3. CodingAgentï¼ˆç¼–ç ä¸“å®¶ï¼‰

**èŒè´£**:
- æ ¹æ®è¯Šæ–­ç»“è®ºç”Ÿæˆä¼˜åŒ– SQL
- ç”Ÿæˆç´¢å¼•åˆ›å»ºè¯­å¥
- æä¾› SQL é‡å†™æ–¹æ¡ˆ

**æ¨¡å‹**: DeepSeek-Coder
**ç‰¹ç‚¹**: ä»£ç ç”Ÿæˆèƒ½åŠ›å¼º

**System Message**:

```java
@SystemMessage("""
ä½ æ˜¯ä¸€ä½ SQL ä¼˜åŒ–ä¸“å®¶ï¼Œæ“…é•¿ç”Ÿæˆé«˜æ•ˆçš„ SQL è¯­å¥å’Œç´¢å¼•ä¼˜åŒ–æ–¹æ¡ˆã€‚

# æ ¸å¿ƒèƒ½åŠ›
- æ ¹æ®è¯Šæ–­ç»“è®ºç”Ÿæˆä¼˜åŒ–åçš„ SQL
- è®¾è®¡åˆé€‚çš„ç´¢å¼•ï¼ˆå•åˆ—ç´¢å¼•ã€å¤åˆç´¢å¼•ï¼‰
- æä¾› SQL é‡å†™å»ºè®®

# ä¼˜åŒ–åŸåˆ™
1. æ­£ç¡®æ€§ä¼˜å…ˆï¼šä¼˜åŒ–åçš„ SQL å¿…é¡»ä¸åŸ SQL è¯­ä¹‰ä¸€è‡´
2. æ€§èƒ½æå‡ï¼šå°½é‡å‡å°‘æ‰«æè¡Œæ•°ã€é¿å…ä¸´æ—¶è¡¨ã€æ–‡ä»¶æ’åº
3. å¯ç»´æŠ¤æ€§ï¼šSQL æ¸…æ™°æ˜“è¯»ï¼Œä¸è¿‡åº¦ä¼˜åŒ–

# å®‰å…¨çº¢çº¿
- ç”Ÿæˆçš„ç´¢å¼•åˆ›å»ºè¯­å¥å¿…é¡»ä½¿ç”¨ CREATE INDEX
- æ¶‰åŠè¡¨ç»“æ„ä¿®æ”¹æ—¶ï¼Œå¿…é¡»æé†’ç”¨æˆ·å…ˆå¤‡ä»½æ•°æ®
""")
public interface CodingAgent {

    @UserMessage("""
            æ ¹æ®ä»¥ä¸‹è¯Šæ–­ç»“è®ºï¼Œç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆï¼š

            **è¯Šæ–­ç»“è®º**:
            {diagnosis}

            **åŸå§‹ SQL**:
            ```sql
            {originalSql}
            ```

            è¯·æä¾›ï¼š
            1. ä¼˜åŒ–åçš„ SQLï¼ˆå¦‚æœæœ‰æ›´å¥½çš„å†™æ³•ï¼‰
            2. ç´¢å¼•åˆ›å»ºè¯­å¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
            3. å…¶ä»–ä¼˜åŒ–å»ºè®®
            """)
    String generateSolution(
            String diagnosis,
            String originalSql
    );
}
```

### 5.2 å·¥å…·ç®±å‡çº§

**åœ¨ `SqlDiagnosticsTools` ä¸­æ–°å¢ä¸¤ä¸ªé«˜çº§å·¥å…·**:

```java
@Component
@RequiredArgsConstructor
public class SqlDiagnosticsTools {

    // æ³¨å…¥ä¸¤ä¸ªä¸“å®¶ Agent
    private final ReasoningAgent reasoningAgent;
    private final CodingAgent codingAgent;

    // === åŸæœ‰çš„åŸºç¡€å·¥å…· ===

    @Tool("è·å–æ‰§è¡Œè®¡åˆ’")
    public List<Map<String, Object>> getExecutionPlan(String database, String sql) {
        String explainSql = "EXPLAIN " + sql;
        return targetJdbcTemplate.queryForList(explainSql);
    }

    @Tool("è·å–è¡¨ç»“æ„")
    public List<Map<String, Object>> getTableSchema(String database, String tableName) {
        String sql = """
                SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE, COLUMN_KEY
                FROM information_schema.COLUMNS
                WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ?
                ORDER BY ORDINAL_POSITION
                """;
        return targetJdbcTemplate.queryForList(sql, database, tableName);
    }

    // ... å…¶ä»–åŸºç¡€å·¥å…· ...

    // === æ–°å¢çš„"ä¸“å®¶"å·¥å…· ===

    @Tool("ã€ä¸“å®¶ä¼šè¯Šã€‘å½“é—®é¢˜å¤æ‚ã€åŸå› ä¸æ˜ç¡®æ—¶è°ƒç”¨")
    public String consultExpert(
            @P("é—®é¢˜èƒŒæ™¯") String context,
            @P("å·²æ”¶é›†è¯æ®") String evidence
    ) {
        log.info("è°ƒç”¨æ¨ç†ä¸“å®¶è¿›è¡Œæ·±åº¦åˆ†æ");

        // å°†è¯æ®æ ¼å¼åŒ–ä¸ºç»“æ„åŒ–æ–‡æœ¬
        String evidenceText = formatEvidence(evidence);

        // è°ƒç”¨æ¨ç†ä¸“å®¶
        String expertConclusion = reasoningAgent.deepAnalyze(
                extractDatabase(context),
                extractSqlTemplate(context),
                extractStatistics(context),
                evidenceText
        );

        return expertConclusion;
    }

    @Tool("ã€æ‰‹æœ¯å®æ–½ã€‘å½“è¯Šæ–­æ˜ç¡®ï¼Œéœ€è¦ç”Ÿæˆè§£å†³æ–¹æ¡ˆæ—¶è°ƒç”¨")
    public String performSurgery(
            @P("è¯Šæ–­ç»“è®º") String diagnosis,
            @P("åŸå§‹ SQL") String originalSql
    ) {
        log.info("è°ƒç”¨ç¼–ç ä¸“å®¶ç”Ÿæˆè§£å†³æ–¹æ¡ˆ");

        // è°ƒç”¨ç¼–ç ä¸“å®¶
        String solution = codingAgent.generateSolution(diagnosis, originalSql);

        return solution;
    }
}
```

---

## 6. é€šçŸ¥ç­–ç•¥ä¼˜åŒ–

### 6.1 å®šæœŸæ±‡æ€»æŠ¥å‘Šæ¨¡å¼

**æ ¸å¿ƒè®¾è®¡**:
1. **åˆ†æå®Œæˆ** â†’ æ ‡è®° `notificationStatus = WAITING`
2. **å®šæ—¶ä»»åŠ¡**ï¼ˆ30 åˆ†é’Ÿï¼‰â†’ æå–æ‰€æœ‰ WAITING è®°å½•
3. **æ‰“åŒ…å‘é€** â†’ ç”Ÿæˆ HTML é‚®ä»¶ï¼Œæ‰¹é‡æ›´æ–°çŠ¶æ€ä¸º SENT

**é…ç½®æ–‡ä»¶**:

```yaml
db-doctor:
  notify:
    # æ‰¹é‡é€šçŸ¥é…ç½®
    batch-enabled: true              # æ˜¯å¦å¯ç”¨æ‰¹é‡é€šçŸ¥æ¨¡å¼
    batch-cron: "0 0/30 * * * ?"    # å®šæ—¶ä»»åŠ¡ Cron è¡¨è¾¾å¼ï¼ˆæ¯ 30 åˆ†é’Ÿï¼‰
    batch-size: 50                  # å•æ¬¡æ‰¹é‡å‘é€çš„æœ€å¤§è®°å½•æ•°

    # é‚®ä»¶é…ç½®
    email:
      enabled: true
      from: DB-Doctor <noreply@example.com>
      to:
        - dba@example.com
      subject-template: "[DB-Doctor] æ•°æ®åº“è¯Šç–—æŠ¥å‘Š - {date}"
```

### 6.2 é‚®ä»¶æ¨¡æ¿è®¾è®¡

**HTML æ¨¡æ¿**:

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .header { background: #f8f9fa; padding: 20px; border-bottom: 3px solid #007bff; }
        .content { padding: 20px; }
        .issue { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .issue.critical { border-left: 5px solid #dc3545; }
        .issue.high { border-left: 5px solid #fd7e14; }
        .issue.medium { border-left: 5px solid #ffc107; }
        .issue.low { border-left: 5px solid #28a745; }
        .stats { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .sql-code { background: #f4f4f4; padding: 10px; border-radius: 3px; font-family: monospace; color: #c7254e; }
        .ai-report { background: #f9f9f9; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
        .footer { text-align: center; padding: 20px; color: #6c757d; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ©º DB-Doctor æ•°æ®åº“è¯Šç–—å®šæœŸæŠ¥å‘Š</h1>
        <p>æŠ¥å‘Šå‘¨æœŸ: {period}</p>
        <p>æœ¬å‘¨æœŸå…±åˆ†æå®Œæˆ <b>{totalCount}</b> ç±»æ…¢æŸ¥è¯¢</p>
    </div>

    <div class="content">
        <!-- å¾ªç¯æ¯ä¸ªé—®é¢˜ -->
        {issues}
    </div>

    <div class="footer">
        <p>DB-Doctor è‡ªåŠ¨ç”Ÿæˆ | {generationTime}</p>
        <p>å¦‚éœ€åœæ­¢æ¥æ”¶æ­¤ç±»é‚®ä»¶ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜</p>
    </div>
</body>
</html>
```

---

## 7. å®æ–½è®¡åˆ’

### 7.1 é˜¶æ®µåˆ’åˆ†

#### é˜¶æ®µä¸€ï¼šè¡¥å…¨ç¼ºå¤±åŠŸèƒ½ï¼ˆ1-2 å°æ—¶ï¼‰

**ç›®æ ‡**: è®©å•ä¸ª AI Agent èƒ½è·‘èµ·æ¥

**ä»»åŠ¡æ¸…å•**:

1. **é…ç½® DBAgent Bean** (10 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/config/AiConfig.java`
   - æ“ä½œ: æ·»åŠ  `DBAgent` Bean é…ç½®æ–¹æ³•
   - éªŒè¯: åº”ç”¨å¯åŠ¨æˆåŠŸï¼ŒBean è¢«æ­£ç¡®åˆ›å»º

2. **é›†æˆ AI åˆ†æåˆ°æŠ¥å‘Šç”Ÿæˆ** (30 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/service/AnalysisService.java`
   - æ“ä½œ:
     - æ³¨å…¥ `DBAgent`
     - åœ¨ `generateReportAndNotify()` æ–¹æ³•ä¸­è°ƒç”¨ `dbAgent.analyzeSlowLog()`
     - ä¿å­˜ AI ç”Ÿæˆçš„æŠ¥å‘Š
   - éªŒè¯: æ…¢æŸ¥è¯¢èƒ½è§¦å‘ AI åˆ†æï¼Œç”ŸæˆæŠ¥å‘Š

3. **æµ‹è¯• AI åˆ†ææµç¨‹** (30 åˆ†é’Ÿ)
   - æ“ä½œ:
     - å¯åŠ¨åº”ç”¨
     - è§¦å‘ä¸€æ¡æ…¢æŸ¥è¯¢
     - æŸ¥çœ‹ H2 æ•°æ®åº“ä¸­çš„æŠ¥å‘Šå†…å®¹
   - éªŒè¯: AI æŠ¥å‘Šå†…å®¹å®Œæ•´ï¼ŒåŒ…å«è¯Šæ–­å»ºè®®

---

#### é˜¶æ®µäºŒï¼šå¼•å…¥å¤š Agent åè°ƒå™¨ï¼ˆ2-3 å°æ—¶ï¼‰

**ç›®æ ‡**: å®ç°å¤š Agent åä½œ

**ä»»åŠ¡æ¸…å•**:

1. **åˆ›å»º 3 ä¸ª Agent æ¥å£** (30 åˆ†é’Ÿ)
   - æ–‡ä»¶:
     - `src/main/java/com/dbdoctor/agent/DiagnosisAgent.java`
     - `src/main/java/com/dbdoctor/agent/ReasoningAgent.java`
     - `src/main/java/com/dbdoctor/agent/CodingAgent.java`
   - æ“ä½œ: å®šä¹‰æ¥å£å’Œ System Message

2. **åˆ›å»º AnalysisContext DTO** (20 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/model/AnalysisContext.java`
   - æ“ä½œ: å®šä¹‰ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒåŒ…å«æ—¶é—´å…ƒæ•°æ®å’Œæ•°æ®å¿«ç…§

3. **å‡çº§ SqlDiagnosticsTools** (30 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/agent/SqlDiagnosticsTools.java`
   - æ“ä½œ:
     - æ³¨å…¥ `ReasoningAgent` å’Œ `CodingAgent`
     - æ–°å¢ `consultExpert()` å’Œ `performSurgery()` æ–¹æ³•

4. **åˆ›å»º MultiAgentCoordinator** (40 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/service/MultiAgentCoordinator.java`
   - æ“ä½œ: å®ç°å¤š Agent åä½œæµç¨‹

5. **é…ç½® 3 ä¸ª Agent Bean** (20 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/config/AiConfig.java`
   - æ“ä½œ: é…ç½® 3 ä¸ª Agentï¼Œåˆ†åˆ«ç»‘å®šä¸åŒæ¨¡å‹

6. **æ”¹é€  AnalysisService** (30 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/service/AnalysisService.java`
   - æ“ä½œ:
     - åˆ›å»º `AnalysisContext` å¿«ç…§
     - è°ƒç”¨ `multiAgentCoordinator.analyze(context)`

---

#### é˜¶æ®µä¸‰ï¼šä¼˜åŒ–é€šçŸ¥ç­–ç•¥ï¼ˆ1-2 å°æ—¶ï¼‰

**ç›®æ ‡**: å®ç°å®šæœŸæ±‡æ€»æŠ¥å‘Š

**ä»»åŠ¡æ¸…å•**:

1. **æ–°å¢ NotificationStatus æšä¸¾** (10 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/common/enums/NotificationStatus.java`

2. **ä¿®æ”¹ SlowQueryTemplate å®ä½“** (15 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/entity/SlowQueryTemplate.java`
   - æ“ä½œ: æ–°å¢ `notificationStatus`ã€`lastNotifiedTime` å­—æ®µ

3. **åˆ›å»º NotificationScheduler** (40 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/service/NotificationScheduler.java`
   - æ“ä½œ: å®ç°å®šæ—¶æ‰¹é‡å‘é€é€»è¾‘

4. **ä¿®æ”¹ MultiAgentCoordinator** (15 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/java/com/dbdoctor/service/MultiAgentCoordinator.java`
   - æ“ä½œ: åˆ†æå®Œæˆåæ ‡è®° `notificationStatus = WAITING`

5. **é…ç½®å®šæ—¶ä»»åŠ¡** (10 åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/main/resources/application.yml`
   - æ“ä½œ: æ·»åŠ  `batch-cron` é…ç½®

---

#### é˜¶æ®µå››ï¼šæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ1-2 å°æ—¶ï¼‰

**ç›®æ ‡**: éªŒè¯åŠŸèƒ½ï¼Œä¼˜åŒ–æ€§èƒ½

**ä»»åŠ¡æ¸…å•**:

1. **å•å…ƒæµ‹è¯•** (30 åˆ†é’Ÿ)
   - æµ‹è¯•å„ä¸ª Agent çš„åŠŸèƒ½
   - æµ‹è¯•å·¥å…·ç®±æ–¹æ³•

2. **é›†æˆæµ‹è¯•** (30 åˆ†é’Ÿ)
   - ç«¯åˆ°ç«¯æµ‹è¯•ï¼šä»æ…¢æŸ¥è¯¢äº§ç”Ÿåˆ°æŠ¥å‘Šå‘é€
   - æµ‹è¯•æ•°æ®ä¸€è‡´æ€§

3. **æ€§èƒ½æµ‹è¯•** (30 åˆ†é’Ÿ)
   - å‹åŠ›æµ‹è¯•ï¼šæ¨¡æ‹Ÿ 1000 æ¡æ…¢æŸ¥è¯¢
   - ç›‘æ§çº¿ç¨‹æ± ã€é˜Ÿåˆ—ã€H2 æ€§èƒ½

4. **æ–‡æ¡£æ›´æ–°** (30 åˆ†é’Ÿ)
   - æ›´æ–° README.md
   - æ›´æ–°é…ç½®è¯´æ˜

---

### 7.2 æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | éš¾åº¦ |
|------|------|---------|------|
| é˜¶æ®µä¸€ | è¡¥å…¨ç¼ºå¤±åŠŸèƒ½ | 1-2 å°æ—¶ | â­ |
| é˜¶æ®µäºŒ | å¤š Agent åè°ƒå™¨ | 2-3 å°æ—¶ | â­â­â­ |
| é˜¶æ®µä¸‰ | ä¼˜åŒ–é€šçŸ¥ç­–ç•¥ | 1-2 å°æ—¶ | â­â­ |
| é˜¶æ®µå›› | æµ‹è¯•ä¸ä¼˜åŒ– | 1-2 å°æ—¶ | â­â­ |
| **æ€»è®¡** | **å…¨éƒ¨ä»»åŠ¡** | **5-9 å°æ—¶** | - |

---

### 7.3 é£é™©ä¸åº”å¯¹

| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|---------|
| LLM API è°ƒç”¨å¤±è´¥ | AI åˆ†æå¤±è´¥ | 1. é‡è¯•æœºåˆ¶<br>2. é™çº§ä¸ºåŸºç¡€æŠ¥å‘Š<br>3. è®°å½•é”™è¯¯æ—¥å¿— |
| LLM å“åº”æ—¶é—´è¿‡é•¿ | é˜Ÿåˆ—å †ç§¯ | 1. è®¾ç½®è¶…æ—¶æ—¶é—´<br>2. é™åˆ¶å¹¶å‘æ•°é‡<br>3. ç›‘æ§é˜Ÿåˆ—é•¿åº¦ |
| å¤š Agent åä½œå¤æ‚ | è°ƒè¯•å›°éš¾ | 1. è¯¦ç»†æ—¥å¿—<br>2. å•å…ƒæµ‹è¯•<br>3. åˆ†é˜¶æ®µå®æ–½ |
| H2 æ•°æ®åº“æ€§èƒ½ | ç“¶é¢ˆ | 1. ç´¢å¼•ä¼˜åŒ–<br>2. å®šæœŸæ¸…ç†<br>3. è€ƒè™‘å‡çº§åˆ° MySQL |

---

## 8. éªŒæ”¶æ ‡å‡†

### 8.1 åŠŸèƒ½éªŒæ”¶

#### 8.1.1 åŸºç¡€åŠŸèƒ½

- [ ] æ…¢æŸ¥è¯¢èƒ½è¢«æ­£ç¡®æ•è·å¹¶å…¥åº“
- [ ] SQL æŒ‡çº¹å»é‡æ­£å¸¸å·¥ä½œ
- [ ] ç»Ÿè®¡ä¿¡æ¯é¢„èšåˆæ­£ç¡®æ›´æ–°
- [ ] æ¸¸æ ‡æœºåˆ¶æ­£å¸¸è¿è¡Œï¼Œæ— æ•°æ®ä¸¢å¤±

#### 8.1.2 AI åˆ†æåŠŸèƒ½

- [ ] AI èƒ½æ­£ç¡®åˆ†ææ…¢æŸ¥è¯¢å¹¶ç”ŸæˆæŠ¥å‘Š
- [ ] æŠ¥å‘ŠåŒ…å«æ—¶é—´çª—å£è¯´æ˜
- [ ] æŠ¥å‘ŠåŒ…å«ç»Ÿè®¡æ•°æ®å’Œæ ·æœ¬ SQL
- [ ] æŠ¥å‘ŠåŒ…å«è¯Šæ–­ç»“è®ºå’Œä¼˜åŒ–å»ºè®®

#### 8.1.3 å¤š Agent åä½œ

- [ ] DiagnosisAgent èƒ½æ­£ç¡®è°ƒç”¨å·¥å…·æ”¶é›†è¯æ®
- [ ] å¤æ‚é—®é¢˜èƒ½å‡çº§åˆ° ReasoningAgent
- [ ] CodingAgent èƒ½ç”Ÿæˆä¼˜åŒ– SQL
- [ ] æœ€ç»ˆæŠ¥å‘ŠåŒ…å«ä¸“å®¶æ„è§å’Œæ‰‹æœ¯æ–¹æ¡ˆ

#### 8.1.4 é€šçŸ¥åŠŸèƒ½

- [ ] åˆ†æå®Œæˆåæ ‡è®°ä¸º WAITING
- [ ] å®šæ—¶ä»»åŠ¡èƒ½æ­£ç¡®æå– WAITING è®°å½•
- [ ] é‚®ä»¶å†…å®¹æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦ä¿¡æ¯
- [ ] å‘é€æˆåŠŸåçŠ¶æ€æ›´æ–°ä¸º SENT

### 8.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | éªŒè¯æ–¹æ³• |
|------|--------|---------|
| ç›‘æ§å»¶è¿Ÿ | < 60 ç§’ | æŸ¥çœ‹æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³ |
| æ•°æ®æŒä¹…åŒ–è€—æ—¶ | < 100ms | ç›‘æ§ AnalysisService æ–¹æ³•è€—æ—¶ |
| AI åˆ†æè€—æ—¶ | 30-60 ç§’ | æŸ¥çœ‹ AI åˆ†ææ—¥å¿— |
| é‚®ä»¶å‘é€è€—æ—¶ | < 10 ç§’ | æŸ¥çœ‹é‚®ä»¶å‘é€æ—¥å¿— |
| H2 æŸ¥è¯¢è€—æ—¶ | < 50ms | ç›‘æ§ SQL æŸ¥è¯¢æ—¥å¿— |

### 8.3 ç¨³å®šæ€§éªŒæ”¶

- [ ] åº”ç”¨é‡å¯åï¼Œæ¸¸æ ‡æ­£å¸¸æ¢å¤ï¼Œæ— æ•°æ®é‡å¤å¤„ç†
- [ ] AI åˆ†æå¤±è´¥æ—¶ï¼Œä¸å½±å“åç»­ä»»åŠ¡å¤„ç†
- [ ] é‚®ä»¶å‘é€å¤±è´¥æ—¶ï¼ŒçŠ¶æ€ä¿æŒ WAITINGï¼Œä¸‹æ¬¡é‡è¯•
- [ ] çº¿ç¨‹æ± é˜Ÿåˆ—æ»¡æ—¶ï¼Œæ–°ä»»åŠ¡ç­‰å¾…è€Œéä¸¢å¤±

---

## 9. é™„å½•

### 9.1 æœ¬åœ° Ollama éƒ¨ç½²å®Œæ•´æŒ‡å—

#### 9.1.1 å‰ç½®æ¡ä»¶

**ç¡¬ä»¶è¦æ±‚**:
- GPU: NVIDIA RTX 4060 Ti (8GB VRAM) æˆ–æ›´å¥½
- å†…å­˜: 16GB RAM
- ç¡¬ç›˜: 20GB å¯ç”¨ç©ºé—´ï¼ˆç”¨äºå­˜å‚¨æ¨¡å‹æ–‡ä»¶ï¼‰

**è½¯ä»¶è¦æ±‚**:
- æ“ä½œç³»ç»Ÿ: Windows / Linux / macOS
- Ollama: >= 0.1.0
- Java: 17+
- Docker (å¯é€‰): ç”¨äºå®¹å™¨åŒ–éƒ¨ç½²

#### 9.1.2 å®‰è£… Ollama

**Windows**:
```powershell
# 1. ä¸‹è½½ Ollama
# è®¿é—® https://ollama.com/download
# ä¸‹è½½ Windows å®‰è£…åŒ…

# 2. å®‰è£… Ollama
# åŒå‡»è¿è¡Œå®‰è£…åŒ…ï¼ŒæŒ‰æç¤ºå®Œæˆå®‰è£…

# 3. éªŒè¯å®‰è£…
ollama --version
```

**Linux**:
```bash
# 1. å®‰è£… Ollama
curl -fsSL https://ollama.com/install.sh | sh

# 2. å¯åŠ¨ Ollama æœåŠ¡
ollama serve

# 3. éªŒè¯å®‰è£…
ollama --version
```

**macOS**:
```bash
# 1. ä½¿ç”¨ Homebrew å®‰è£…
brew install ollama

# 2. å¯åŠ¨ Ollama æœåŠ¡
ollama serve
```

#### 9.1.3 ä¸‹è½½æ¨¡å‹

```bash
# 1. ä¸‹è½½ä¸»æ²»åŒ»ç”Ÿæ¨¡å‹ (Qwen 2.5 7B)
ollama pull qwen2.5:7b

# 2. ä¸‹è½½æ¨ç†ä¸“å®¶æ¨¡å‹ (DeepSeek R1 7B)
ollama pull deepseek-r1:7b

# 3. ä¸‹è½½ç¼–ç ä¸“å®¶æ¨¡å‹ (DeepSeek Coder 6.7B)
ollama pull deepseek-coder:6.7b

# 4. æŸ¥çœ‹å·²å®‰è£…çš„æ¨¡å‹
ollama list

# è¾“å‡ºç¤ºä¾‹:
# NAME                  ID              SIZE      MODIFIED
# qwen2.5:7b            a6b45dd9a7a4    4.7 GB    2 hours ago
# deepseek-r1:7b        b6518646e244    4.7 GB    3 hours ago
# deepseek-coder:6.7b   c1d5f3e2a6b3    4.1 GB    4 hours ago
```

#### 9.1.4 é…ç½®ç¯å¢ƒå˜é‡

**Windows (PowerShell)**:
```powershell
# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå½“å‰ä¼šè¯ï¼‰
$env:OLLAMA_NUM_PARALLEL=1
$env:OLLAMA_MAX_LOADED_MODELS=1

# æ°¸ä¹…è®¾ç½®ï¼ˆç³»ç»Ÿç¯å¢ƒå˜é‡ï¼‰
# 1. å³é”®"æ­¤ç”µè„‘" -> "å±æ€§" -> "é«˜çº§ç³»ç»Ÿè®¾ç½®" -> "ç¯å¢ƒå˜é‡"
# 2. æ–°å»ºç³»ç»Ÿå˜é‡:
#    OLLAMA_NUM_PARALLEL = 1
#    OLLAMA_MAX_LOADED_MODELS = 1
```

**Linux / macOS**:
```bash
# ä¸´æ—¶è®¾ç½®ï¼ˆå½“å‰ä¼šè¯ï¼‰
export OLLAMA_NUM_PARALLEL=1
export OLLAMA_MAX_LOADED_MODELS=1

# æ°¸ä¹…è®¾ç½®ï¼ˆå†™å…¥ ~/.bashrc æˆ– ~/.zshrcï¼‰
echo 'export OLLAMA_NUM_PARALLEL=1' >> ~/.bashrc
echo 'export OLLAMA_MAX_LOADED_MODELS=1' >> ~/.bashrc
source ~/.bashrc
```

#### 9.1.5 æµ‹è¯• Ollama æœåŠ¡

```bash
# 1. å¯åŠ¨ Ollama æœåŠ¡ï¼ˆé»˜è®¤ç«¯å£ 11434ï¼‰
ollama serve

# 2. æµ‹è¯•æ¨¡å‹ï¼ˆå¦å¼€ä¸€ä¸ªç»ˆç«¯ï¼‰
curl http://localhost:11434/api/generate -d '{
  "model": "qwen2.5:7b",
  "prompt": "ä½ å¥½",
  "stream": false
}'

# 3. æµ‹è¯•å¤šæ¨¡å‹å¹¶å‘ï¼ˆéªŒè¯ OLLAMA_NUM_PARALLEL=1ï¼‰
# å¼€å¯ 3 ä¸ªç»ˆç«¯ï¼ŒåŒæ—¶æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤
# åº”è¯¥çœ‹åˆ°è¯·æ±‚ä¸²è¡Œå¤„ç†ï¼Œè€Œéå¹¶è¡Œ
```

#### 9.1.6 é…ç½® DB-Doctor

**application-local.yml** (æœ¬åœ°é…ç½®):

```yaml
db-doctor:
  ai:
    enabled: true

    models:
      diagnosis:
        provider: ollama
        base-url: http://localhost:11434
        api-key: ollama
        model-name: qwen2.5:7b
        temperature: 0.1
        timeout-seconds: 60

      reasoning:
        provider: ollama
        base-url: http://localhost:11434
        api-key: ollama
        model-name: deepseek-r1:7b
        temperature: 0.6
        timeout-seconds: 120

      coding:
        provider: ollama
        base-url: http://localhost:11434
        api-key: ollama
        model-name: deepseek-coder:6.7b
        temperature: 0.0
        timeout-seconds: 60

    # è°ƒè¯•æ¨¡å¼ï¼šæ‰“å° AI äº¤äº’æ—¥å¿—
    debug: true
```

#### 9.1.7 è¿œç¨‹è°ƒç”¨ï¼ˆé€šè¿‡ Tailscale VPNï¼‰

**åœºæ™¯**: DB-Doctor éƒ¨ç½²åœ¨å…¬å¸æœåŠ¡å™¨ï¼ŒOllama è¿è¡Œåœ¨å®¶é‡Œç”µè„‘

**æ­¥éª¤**:

1. **å®‰è£… Tailscale** (ä¸¤å°ç”µè„‘éƒ½å®‰è£…)
   - è®¿é—® https://tailscale.com/download
   - ä¸‹è½½å¹¶å®‰è£… Tailscale
   - ä½¿ç”¨åŒä¸€ä¸ªè´¦å·ç™»å½•

2. **è·å– Tailscale IP**
   ```bash
   # åœ¨å®¶é‡Œçš„ Ollama ç”µè„‘ä¸Š
   tailscale ip -4
   # è¾“å‡ºç¤ºä¾‹: 100.x.x.x
   ```

3. **é…ç½® DB-Doctor** (å…¬å¸æœåŠ¡å™¨)
   ```yaml
   db-doctor:
     ai:
       models:
         diagnosis:
           provider: ollama
           base-url: http://100.x.x.x:11434  # Tailscale IP
           api-key: ollama
           model-name: qwen2.5:7b
   ```

4. **æµ‹è¯•è¿é€šæ€§**
   ```bash
   # åœ¨å…¬å¸æœåŠ¡å™¨ä¸Š
   curl http://100.x.x.x:11434/api/tags
   ```

#### 9.1.8 æ€§èƒ½ä¼˜åŒ–å»ºè®®

**æ˜¾å­˜ä¼˜åŒ–**:
```bash
# 1. ä½¿ç”¨é‡åŒ–ç‰ˆæœ¬æ¨¡å‹ï¼ˆèŠ‚çœ 50% æ˜¾å­˜ï¼‰
ollama pull qwen2.5:7b-q4_0  # 4-bit é‡åŒ–

# 2. è°ƒæ•´ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆé»˜è®¤ 2048ï¼Œå¯é™ä½åˆ° 512ï¼‰
ollama run qwen2.5:7b --num-ctx 512
```

**å¹¶å‘æ§åˆ¶**:
```bash
# å¦‚æœæ˜¾å­˜å……è¶³ï¼ˆ16GB+ï¼‰ï¼Œå¯ä»¥å¢åŠ å¹¶å‘
export OLLAMA_NUM_PARALLEL=2
```

**ç›‘æ§æ˜¾å­˜ä½¿ç”¨**:
```bash
# å®æ—¶ç›‘æ§ GPU ä½¿ç”¨
watch -n 1 nvidia-smi

# è¾“å‡ºç¤ºä¾‹:
# +-----------------------------------------------------------------------------+
# | NVIDIA-SMI 535.86.01    Driver Version: 555.42.02    CUDA Version: 12.4     |
# |-------------------------------+----------------------+----------------------+
# | GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
# |   0   NVIDIA ...   Off        | 00000000:01:00.0 Off   |                  N/A |
# +-----------------------------------------------------------------------------+
# |   0%   48C    P8    24W / 150W |  4700MiB /  8192MiB     |     0%      Default |
# +-------------------------------+----------------------+----------------------+
```

---

### 9.2 äº‘ç«¯ API é…ç½®æŒ‡å—

#### 9.2.1 DeepSeek APIï¼ˆæ¨èï¼‰

**æ³¨å†Œè´¦å·**:
1. è®¿é—® https://platform.deepseek.com/
2. æ³¨å†Œå¹¶ç™»å½•
3. è¿›å…¥ "API Keys" é¡µé¢
4. åˆ›å»º API Keyï¼ˆ`sk-xxxxx`ï¼‰

**é…ç½®æ–‡ä»¶**:
```yaml
db-doctor:
  ai:
    models:
      diagnosis:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-chat
        temperature: 0.1
        timeout-seconds: 60

      reasoning:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-reasoner
        temperature: 0.6
        timeout-seconds: 120

      coding:
        provider: openai
        base-url: https://api.deepseek.com
        api-key: sk-your-deepseek-key
        model-name: deepseek-coder
        temperature: 0.0
        timeout-seconds: 60
```

**ä»·æ ¼å‚è€ƒ** (2026-01):
- DeepSeek-Chat: Â¥1 / 1M tokens
- DeepSeek-Reasoner: Â¥1 / 1M tokens
- DeepSeek-Coder: Â¥1 / 1M tokens

#### 9.2.2 é˜¿é‡Œäº‘é€šä¹‰åƒé—®

**æ³¨å†Œè´¦å·**:
1. è®¿é—® https://dashscope.aliyuncs.com/
2. æ³¨å†Œå¹¶ç™»å½•
3. åˆ›å»º API Key

**é…ç½®æ–‡ä»¶**:
```yaml
db-doctor:
  ai:
    models:
      diagnosis:
        provider: openai
        base-url: https://dashscope.aliyuncs.com/compatible-mode/v1
        api-key: sk-your-aliyun-key
        model-name: qwen-plus
        temperature: 0.1
        timeout-seconds: 60

      reasoning:
        provider: openai
        base-url: https://dashscope.aliyuncs.com/compatible-mode/v1
        api-key: sk-your-aliyun-key
        model-name: qwen-plus  # é€šä¹‰åƒé—®æš‚æ— æ¨ç†æ¨¡å‹
        temperature: 0.6
        timeout-seconds: 120

      coding:
        provider: openai
        base-url: https://dashscope.aliyuncs.com/compatible-mode/v1
        api-key: sk-your-aliyun-key
        model-name: qwen-plus
        temperature: 0.0
        timeout-seconds: 60
```

#### 9.2.3 OpenAI å®˜æ–¹

**æ³¨å†Œè´¦å·**:
1. è®¿é—® https://platform.openai.com/
2. æ³¨å†Œå¹¶å……å€¼ï¼ˆæœ€ä½ $5ï¼‰
3. åˆ›å»º API Key

**é…ç½®æ–‡ä»¶**:
```yaml
db-doctor:
  ai:
    models:
      diagnosis:
        provider: openai
        base-url: https://api.openai.com/v1
        api-key: sk-your-openai-key
        model-name: gpt-4-turbo
        temperature: 0.1
        timeout-seconds: 60

      reasoning:
        provider: openai
        base-url: https://api.openai.com/v1
        api-key: sk-your-openai-key
        model-name: o1-mini  # OpenAI æ¨ç†æ¨¡å‹
        temperature: 0.6
        timeout-seconds: 120

      coding:
        provider: openai
        base-url: https://api.openai.com/v1
        api-key: sk-your-openai-key
        model-name: gpt-4-turbo
        temperature: 0.0
        timeout-seconds: 60
```

---

### 9.3 å®Œæ•´é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
# application.yml

server:
  port: 8080

spring:
  application:
    name: db-doctor
  profiles:
    active: local

  # H2 ä¸»æ•°æ®æº
  datasource:
    url: jdbc:h2:file:./data/db-doctor-internal;DB_CLOSE_DELAY=-1;MODE=MySQL
    driver-class-name: org.h2.Driver

  # JPA é…ç½®
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    database-platform: org.hibernate.dialect.H2Dialect

  # é‚®ä»¶é…ç½®
  mail:
    host: smtp.qq.com
    port: 587
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true

# DB-Doctor é…ç½®
db-doctor:
  name: DB-Doctor
  version: 2.2.0

  # ç›®æ ‡æ•°æ®æºï¼ˆMySQLï¼‰
  target-db:
    url: jdbc:mysql://localhost:3306/information_schema
    driver-class-name: com.mysql.cj.jdbc.Driver
    # username/password åœ¨ application-local.yml

  # ç¯å¢ƒæ£€æŸ¥
  env-check:
    enabled: true
    fail-on-error: false

  # AI é…ç½®
  ai:
    enabled: true
    max-concurrent-analysis: 4

    # å¤š Agent æ¨¡å‹é…ç½®
    models:
      # ä¸»æ²»åŒ»ç”Ÿ
      diagnosis:
        provider: qwen
        model-name: qwen-plus
        base-url: https://dashscope.aliyuncs.com/compatible-mode/v1
        temperature: 0.0
        timeout: 60s

      # æ¨ç†ä¸“å®¶
      reasoning:
        provider: deepseek
        model-name: deepseek-reasoner
        base-url: https://api.deepseek.com
        temperature: 0.0
        timeout: 120s

      # ç¼–ç ä¸“å®¶
      coding:
        provider: deepseek
        model-name: deepseek-coder
        base-url: https://api.deepseek.com
        temperature: 0.0
        timeout: 30s

  # ç›‘æ§é…ç½®
  slow-log-monitor:
    max-records-per-poll: 100

  # é€šçŸ¥é…ç½®
  notify:
    # æ‰¹é‡é€šçŸ¥æ¨¡å¼
    batch-enabled: true
    batch-cron: "0 0/30 * * * ?"  # æ¯ 30 åˆ†é’Ÿ
    batch-size: 50

    email:
      enabled: true
      from: DB-Doctor <noreply@example.com>
      to:
        - dba@example.com

  # çº¿ç¨‹æ± é…ç½®
  thread-pool:
    ai-analysis:
      core-size: 4
      max-size: 16
      queue-capacity: 200

# LangChain4j é…ç½®ï¼ˆå…¼å®¹å¤šä¸ª API Keyï¼‰
langchain4j:
  open-ai:
    chat-model:
      # é»˜è®¤ API Keyï¼ˆå¯ä»¥è¦†ç›–ï¼‰
      api-key: ${DEFAULT_API_KEY}
```

### 9.2 å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|
| `src/main/java/com/dbdoctor/config/AiConfig.java` | AI é…ç½®ç±» | éœ€è¦ä¿®æ”¹ |
| `src/main/java/com/dbdoctor/service/AnalysisService.java` | åˆ†ææœåŠ¡ | éœ€è¦ä¿®æ”¹ |
| `src/main/java/com/dbdoctor/service/MultiAgentCoordinator.java` | å¤š Agent åè°ƒå™¨ | æ–°å¢ |
| `src/main/java/com/dbdoctor/service/NotificationScheduler.java` | é€šçŸ¥è°ƒåº¦å™¨ | æ–°å¢ |
| `src/main/java/com/dbdoctor/agent/DiagnosisAgent.java` | ä¸»æ²»åŒ»ç”Ÿæ¥å£ | æ–°å¢ |
| `src/main/java/com/dbdoctor/agent/ReasoningAgent.java` | æ¨ç†ä¸“å®¶æ¥å£ | æ–°å¢ |
| `src/main/java/com/dbdoctor/agent/CodingAgent.java` | ç¼–ç ä¸“å®¶æ¥å£ | æ–°å¢ |
| `src/main/java/com/dbdoctor/agent/SqlDiagnosticsTools.java` | è¯Šæ–­å·¥å…·ç®± | éœ€è¦ä¿®æ”¹ |
| `src/main/java/com/dbdoctor/model/AnalysisContext.java` | åˆ†æä¸Šä¸‹æ–‡ | æ–°å¢ |
| `src/main/java/com/dbdoctor/common/enums/NotificationStatus.java` | é€šçŸ¥çŠ¶æ€æšä¸¾ | æ–°å¢ |
| `src/main/java/com/dbdoctor/entity/SlowQueryTemplate.java` | æ¨¡æ¿å®ä½“ | éœ€è¦ä¿®æ”¹ |

---

## 10. æ€»ç»“

æœ¬å®æ–½è®¡åˆ’åŸºäº DB-Doctor v2.1.0ï¼ˆ90% å®Œæˆåº¦ï¼‰çš„åšå®åŸºç¡€ä¸Šï¼Œé€šè¿‡å¼•å…¥**å¤š Agent åä½œ**ã€**æ•°æ®å¿«ç…§**ã€**å®šæœŸæ±‡æ€»æŠ¥å‘Š**ã€**é€šç”¨æ¨¡å‹å·¥å‚**å››å¤§æ ¸å¿ƒä¼˜åŒ–ï¼Œæ‰“é€ ä¸€ä¸ª**ä¸“ä¸šã€ç¨³å®šã€é«˜æ•ˆã€å…¼å®¹**çš„æ•°æ®åº“æ…¢ query æ™ºèƒ½è¯Šç–—ç³»ç»Ÿã€‚

### æ ¸å¿ƒåˆ›æ–°ç‚¹

1. **é‡‡é›†ä¸å¤„ç†å½»åº•åˆ†ç¦»**: æ¸¸æ ‡ç«‹å³æ›´æ–°ï¼Œç›‘æ§å»¶è¿Ÿ < 1 ç§’
2. **æ•°æ®å¿«ç…§æœºåˆ¶**: ä¿è¯åˆ†æè¿‡ç¨‹ä¸­æ•°æ®ä¸€è‡´æ€§
3. **æ—¶é—´çª—å£é€æ˜åŒ–**: ç”¨æˆ·æ¸…æ¥šçŸ¥é“æŠ¥å‘Šçš„æ•°æ®èŒƒå›´
4. **å¤š Agent åä½œ**: ä¸»æ²»åŒ»ç”Ÿ + æ¨ç†ä¸“å®¶ + ç¼–ç ä¸“å®¶
5. **å®šæœŸæ±‡æ€»æŠ¥å‘Š**: é«˜ä¿¡æ¯å¯†åº¦ï¼Œé¿å…é‚®ä»¶è½°ç‚¸
6. **é€šç”¨æ¨¡å‹å·¥å‚**: å…¼å®¹æœ¬åœ° Ollama å’Œäº‘ç«¯ API
7. **æ˜¾å­˜ä¿æŠ¤ç­–ç•¥**: æœ¬åœ°éƒ¨ç½²é˜² OOM å´©æºƒ

### æŠ€æœ¯æ¶æ„äº®ç‚¹

#### å…¼å®¹æ€§è®¾è®¡ â­â­â­â­â­

**ä¸€å¤„ä»£ç ï¼Œå¤šç§éƒ¨ç½²**:
- âœ… æœ¬åœ° Ollamaï¼ˆå…è´¹ï¼Œæ•°æ®ä¸å‡ºåŸŸï¼‰
- âœ… äº‘ç«¯ DeepSeekï¼ˆä¾¿å®œï¼Œé«˜æ€§èƒ½ï¼‰
- âœ… äº‘ç«¯ OpenAIï¼ˆæœ€å¼ºç®—åŠ›ï¼‰
- âœ… æ··åˆéƒ¨ç½²ï¼ˆçµæ´»ç»„åˆï¼‰

**ä»£ç é›¶ä¿®æ”¹**:
- Java ä»£ç ï¼ˆAgent é€»è¾‘ã€Promptã€å·¥å…·ï¼‰å®Œå…¨ä¸éœ€è¦æ”¹åŠ¨
- åªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œåº•å±‚è¿æ¥è‡ªåŠ¨åˆ‡æ¢

#### æ€§èƒ½ä¼˜åŒ– â­â­â­â­â­

**æœ¬åœ°éƒ¨ç½²æ€§èƒ½**:
- RTX 4060 Ti (8GB): å¯è¿è¡Œä¸‰ä¸ª 7B æ¨¡å‹
- é€šè¿‡ `OLLAMA_NUM_PARALLEL=1` é˜²æ­¢æ˜¾å­˜æº¢å‡º
- æ¨¡å‹ä¸²è¡ŒåŠ è½½ï¼Œæ¨ç†é€Ÿåº¦çº¦ 10-20 tokens/s

**äº‘ç«¯éƒ¨ç½²æ€§èƒ½**:
- DeepSeek-R1: æ¨ç†é€Ÿåº¦å¿«ï¼Œä»·æ ¼ä¾¿å®œï¼ˆÂ¥1/M tokensï¼‰
- OpenAI GPT-4: æ¨ç†è´¨é‡æœ€é«˜ï¼Œä»·æ ¼è¾ƒè´µ
- å¯æ ¹æ®é¢„ç®—çµæ´»é€‰æ‹©

### é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ç°çŠ¶ | ä¼˜åŒ–å | æå‡ |
|------|------|--------|------|
| ç›‘æ§å»¶è¿Ÿ | 5-10 åˆ†é’Ÿ | < 1 åˆ†é’Ÿ | **99%** |
| AI åˆ†æè´¨é‡ | å• Agent | å¤šä¸“å®¶åä½œ | **æ˜¾è‘—æå‡** |
| é‚®ä»¶æ•°é‡ | æ¯æ¡ 1 å° | æ¯ 30 åˆ†é’Ÿ 1 å°æ±‡æ€» | **å‡å°‘ 95%** |
| éƒ¨ç½²æˆæœ¬ | äº‘ç«¯ API | æœ¬åœ°å…è´¹ / äº‘ç«¯å¯é€‰ | **çµæ´»å¯æ§** |
| å¼€å‘æ—¶é—´ | - | 5-9 å°æ—¶ | **å¯æ§** |

### é€‚ç”¨åœºæ™¯

#### ä¸ªäººå¼€å‘è€… / å°å›¢é˜Ÿ
- **æ¨èé…ç½®**: æœ¬åœ° Ollama (å…è´¹)
- **ä¼˜åŠ¿**: é›¶æˆæœ¬ã€æ•°æ®éšç§ã€å¿«é€Ÿè¿­ä»£
- **ç¡¬ä»¶è¦æ±‚**: RTX 4060 Ti (8GB) æˆ–æ›´å¥½

#### ä¸­å°å‹ä¼ä¸š
- **æ¨èé…ç½®**: æ··åˆéƒ¨ç½²ï¼ˆæœ¬åœ° + äº‘ç«¯ï¼‰
- **ä¼˜åŠ¿**: æˆæœ¬å¯æ§ã€æ€§èƒ½ä¿éšœ
- **ç¤ºä¾‹**: ä¸»æ²»åŒ»ç”Ÿç”¨æœ¬åœ°ï¼Œæ¨ç†ä¸“å®¶ç”¨äº‘ç«¯

#### å¤§å‹ä¼ä¸š
- **æ¨èé…ç½®**: äº‘ç«¯ API (DeepSeek / OpenAI)
- **ä¼˜åŠ¿**: é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€å¯æ‰©å±•
- **é¢„ç®—**: æœˆæˆæœ¬çº¦ Â¥100-500

---

## 11. å¸¸è§é—®é¢˜ FAQ

### Q1: æœ¬åœ°æ˜¾å­˜ä¸è¶³ï¼Œæ€ä¹ˆåŠï¼Ÿ

**A**: æœ‰ä¸‰ç§è§£å†³æ–¹æ¡ˆï¼š
1. **ä½¿ç”¨é‡åŒ–æ¨¡å‹**: `ollama pull qwen2.5:7b-q4_0`ï¼ˆèŠ‚çœ 50% æ˜¾å­˜ï¼‰
2. **æ··åˆéƒ¨ç½²**: ä¸»æ²»åŒ»ç”Ÿå’Œç¼–ç ä¸“å®¶ç”¨æœ¬åœ°ï¼Œæ¨ç†ä¸“å®¶ç”¨äº‘ç«¯
3. **çº¯äº‘ç«¯éƒ¨ç½²**: å…¨éƒ¨ä½¿ç”¨ DeepSeek APIï¼ˆä»·æ ¼ä¾¿å®œï¼‰

### Q2: å¦‚ä½•éªŒè¯æ¨¡å‹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ

**A**: ä¸‰æ­¥éªŒè¯æ³•ï¼š
1. **æµ‹è¯• Ollama æœåŠ¡**: `curl http://localhost:11434/api/tags`
2. **æµ‹è¯•å•ä¸ªæ¨¡å‹**: `ollama run qwen2.5:7b "ä½ å¥½"`
3. **æµ‹è¯• Java é›†æˆ**: æŸ¥çœ‹ DB-Doctor æ—¥å¿—ï¼Œç¡®è®¤æ¨¡å‹åŠ è½½æˆåŠŸ

### Q3: å¤š Agent åä½œä¼šå¢åŠ å¤šå°‘æˆæœ¬ï¼Ÿ

**A**: å–å†³äºéƒ¨ç½²æ–¹å¼ï¼š
- **æœ¬åœ° Ollama**: é›¶æˆæœ¬ï¼ˆåªæ¶ˆè€—ç”µè´¹ï¼‰
- **DeepSeek API**: çº¦ Â¥2-5 / 1000 æ¬¡åˆ†æ
- **OpenAI API**: çº¦ Â¥20-50 / 1000 æ¬¡åˆ†æ

### Q4: èƒ½å¦åªç”¨ä¸€ä¸ª Agentï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†ä¸æ¨èï¼š
- ç®€åŒ–é…ç½®ï¼šåªé…ç½® `diagnosis` Agent
- åŠŸèƒ½æŸå¤±ï¼šç¼ºå°‘æ·±åº¦æ¨ç†å’Œä»£ç ç”Ÿæˆèƒ½åŠ›
- å»ºè®®ï¼šè‡³å°‘ä½¿ç”¨ä¸¤ä¸ª Agentï¼ˆDiagnosisAgent + CodingAgentï¼‰

### Q5: å¦‚ä½•åˆ‡æ¢æ¨¡å‹ä¾›åº”å•†ï¼Ÿ

**A**: åªéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š
1. ä¿®æ”¹ `application-local.yml`
2. ä¿®æ”¹ `provider`ã€`base-url`ã€`api-key`ã€`model-name`
3. é‡å¯åº”ç”¨
4. **æ— éœ€ä¿®æ”¹ä»»ä½• Java ä»£ç **

---

**æ–‡æ¡£ç»“æŸ**

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**: è¯·æŒ‰ç…§ç¬¬ 7 èŠ‚"å®æ–½è®¡åˆ’"ï¼Œä»é˜¶æ®µä¸€å¼€å§‹é€æ­¥å®æ–½ã€‚å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒèŠå¤©è®°å½•æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v2.2.0
**æœ€åæ›´æ–°**: 2026-01-30
**æœ€åæ›´æ–°**: 2026-01-30
