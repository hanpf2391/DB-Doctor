# DB-Doctor æ—¥å¿—ç›‘æ§åŠŸèƒ½å¼€å‘ï¼ˆè¡¨è½®è¯¢æ¨¡å¼ï¼‰

## ä¸€ã€å¼€å‘ç›®æ ‡

å®ç°åŸºäº MySQL æ…¢æŸ¥è¯¢æ—¥å¿—è¡¨ï¼ˆ`mysql.slow_log`ï¼‰çš„å®šæ—¶è½®è¯¢ç›‘æ§åŠŸèƒ½ï¼Œæ›¿ä»£åŸæœ‰çš„æ–‡ä»¶ç›‘å¬æ¨¡å¼ã€‚

## äºŒã€åŠŸèƒ½æè¿°

### ä¸ºä»€ä¹ˆé€‰æ‹©è¡¨è½®è¯¢æ¨¡å¼ï¼Ÿ

#### æ–‡ä»¶ç›‘å¬æ¨¡å¼çš„é—®é¢˜ï¼ˆå·²åºŸå¼ƒï¼‰
âŒ éœ€è¦ä½¿ç”¨ Apache Commons IO çš„ Tailer ç›‘å¬æ–‡ä»¶
âŒ éœ€è¦å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼è§£æå¤šç§æ—¥å¿—æ ¼å¼
âŒ æ•°æ®åº“åè¯†åˆ«å›°éš¾ï¼ˆUSE è¯­å¥ã€Schema å­—æ®µã€SQL æå–ï¼‰
âŒ åŒåè¡¨éš¾ä»¥è¯†åˆ«
âŒ BLOB ç±»å‹ SQL æ–‡æœ¬ä¹±ç é—®é¢˜

#### è¡¨è½®è¯¢æ¨¡å¼çš„ä¼˜åŠ¿ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰
âœ… **æ•°æ®åº“åç›´æ¥æä¾›**ï¼š`mysql.slow_log` è¡¨çš„ `db` å­—æ®µç›´æ¥åŒ…å«æ•°æ®åº“å
âœ… **å®ç°ç®€å•**ï¼šåªéœ€è¦å®šæ—¶æŸ¥è¯¢ SQL
âœ… **å‡†ç¡®æ€§é«˜**ï¼šMySQL å®˜æ–¹è®°å½•ï¼Œ100% å‡†ç¡®
âœ… **è§£å†³åŒåè¡¨é—®é¢˜**ï¼šæ¯æ¡è®°å½•éƒ½æ˜ç¡®æ ‡æ³¨äº†æ•°æ®åº“å
âœ… **æ— éœ€è§£æ**ï¼šä¸éœ€è¦æ­£åˆ™è¡¨è¾¾å¼å’ŒçŠ¶æ€æœº

---

## ä¸‰ã€è¯¦ç»†å¼€å‘ä»»åŠ¡

### 3.1 æ ¸å¿ƒå®ç° (SlowLogTableMonitor)

**ä½ç½®**: `src/main/java/com/dbdoctor/service/SlowLogTableMonitor.java`

#### 3.1.1 æ ¸å¿ƒæœºåˆ¶ï¼šæ¸¸æ ‡ï¼ˆCursorï¼‰

**é—®é¢˜**ï¼šå¦‚ä½•å®ç°"åªè¯»å–æ–°æ•°æ®"ï¼Ÿ

æ•°æ®åº“è¡¨å’Œæ–‡ä»¶ä¸ä¸€æ ·ï¼Œæ–‡ä»¶æœ‰æ–‡ä»¶æŒ‡é’ˆï¼Œè¡¨éœ€è¦è‡ªå·±ç»´æŠ¤æ¸¸æ ‡ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `lastCheckTime` ä½œä¸ºæ¸¸æ ‡ï¼Œè®°å½•ä¸Šä¸€æ¬¡è¯»å–åˆ°çš„æœ€åä¸€æ¡æ—¥å¿—çš„æ—¶é—´
- å¯åŠ¨æ—¶åˆå§‹åŒ–ä¸ºå½“å‰æ—¶é—´ï¼Œé¿å…å¤„ç†å†å²æ—§æ•°æ®
- æ¯æ¬¡è½®è¯¢æŸ¥è¯¢ `start_time > lastCheckTime` çš„è®°å½•
- å¤„ç†å®Œæ›´æ–° `lastCheckTime` ä¸ºæœ€æ–°è®°å½•çš„æ—¶é—´

#### 3.1.2 å®šæ—¶ä»»åŠ¡é…ç½®

```java
@Scheduled(fixedDelay = 60000)
public void pollSlowLog() {
    // æ¯ ä¸€åˆ†é’Ÿ æ‰§è¡Œä¸€æ¬¡
}
```

#### 3.1.3 SQL æŸ¥è¯¢è®¾è®¡

**å…³é”®ä¼˜åŒ–**ï¼š

1. **TIME_TO_SEC()**ï¼šç›´æ¥å°†æ—¶é—´è½¬æ¢ä¸ºç§’æ•°ï¼ˆDoubleï¼‰
   ```sql
   TIME_TO_SEC(query_time) as query_time_sec
   ```

2. **CONVERT(sql_text USING utf8)**ï¼šè§£å†³ BLOB ä¹±ç é—®é¢˜
   ```sql
   CONVERT(sql_text USING utf8) AS sql_content
   ```

3. **WHERE start_time > ?**ï¼šåªæŸ¥æ–°æ•°æ®ï¼ˆä½¿ç”¨æ¸¸æ ‡ï¼‰
   ```sql
   WHERE start_time > ?
   ```

4. **ORDER BY start_time ASC**ï¼šæŒ‰æ—¶é—´å‡åº
   ```sql
   ORDER BY start_time ASC
   ```

5. **LIMIT 100**ï¼šé˜²æ­¢ä¸€æ¬¡æŸ¥å¤ªå¤šå¯¼è‡´å†…å­˜æº¢å‡º
   ```sql
   LIMIT 100
   ```

**å®Œæ•´ SQL**ï¼š

```sql
SELECT
    start_time,
    user_host,
    TIME_TO_SEC(query_time) as query_time_sec,
    TIME_TO_SEC(lock_time) as lock_time_sec,
    rows_sent,
    rows_examined,
    db,
    CONVERT(sql_text USING utf8) AS sql_content
FROM mysql.slow_log
WHERE start_time > ?
ORDER BY start_time ASC
LIMIT 100
```

#### 3.1.4 æ¸¸æ ‡æ›´æ–°é€»è¾‘

```java
// æ¯å¤„ç†ä¸€æ¡è®°å½•ï¼Œæ›´æ–°æ¸¸æ ‡
if (startTime.after(lastCheckTime)) {
    this.lastCheckTime = startTime;
}
```

**å…³é”®**ï¼šå¿…é¡»æŒ‰æ—¶é—´å‡åºï¼ˆASCï¼‰å¤„ç†ï¼Œä¿è¯æ¸¸æ ‡æ­£ç¡®æ›´æ–°ï¼

---

### 3.2 æ•°æ®æ¨¡å‹è®¾è®¡

#### 3.2.1 SlowQueryLog å®ä½“ç±»

```java
@Data
@Builder
public class SlowQueryLog {
    private LocalDateTime startTime;
    private String userHost;
    private String dbName;        // ğŸ‘ˆ æ•°æ®åº“åï¼ˆç›´æ¥æä¾›ï¼‰
    private String sqlText;
    private Double queryTime;
    private Double lockTime;
    private Long rowsSent;
    private Long rowsExamined;
}
```

#### 3.2.2 å·¥å…·æ–¹æ³•

```java
// åˆ¤æ–­æ˜¯å¦ä¸ºä¸¥é‡æ…¢æŸ¥è¯¢
public boolean isSevere(double threshold);

// åˆ¤æ–­æ˜¯å¦ä¸ºå…¨è¡¨æ‰«æ
public boolean isFullTableScan();

// åˆ¤æ–­æ˜¯å¦é”ç­‰å¾…ä¸¥é‡
public boolean isLockHeavy();
```

---

### 3.3 è‡ªåŠ¨æ¸…ç†æœºåˆ¶

#### 3.3.1 ä¸ºä»€ä¹ˆéœ€è¦æ¸…ç†ï¼Ÿ

`mysql.slow_log` è¡¨ä¼šæ— é™å¢é•¿ï¼Œç›´åˆ°æŠŠç£ç›˜å†™æ»¡ã€‚ä½œä¸ºä¸€ä¸ªåˆæ ¼çš„ä¸­é—´ä»¶ï¼Œå¿…é¡»è€ƒè™‘è‡ªåŠ¨æ¸…ç†ã€‚

#### 3.3.2 æ¸…ç†ç­–ç•¥

```java
@Scheduled(cron = "0 0 3 * * ?")
public void cleanUpSlowLogTable() {
    // æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ¸…ç†
    jdbcTemplate.execute("TRUNCATE TABLE mysql.slow_log");
    this.lastCheckTime = Timestamp.valueOf(LocalDateTime.now());
}
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ TRUNCATE è€Œä¸æ˜¯ DELETEï¼Ÿ**
- `mysql.slow_log` çš„å¼•æ“æ˜¯ CSVï¼Œä¸æ”¯æŒ `DELETE WHERE`
- `TRUNCATE` æ˜¯å®˜æ–¹æ¨èåšæ³•

---

### 3.4 é…ç½®é¡¹

#### 3.4.1 MySQL é…ç½®

```sql
-- 1. å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';

-- 2. è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆç§’ï¼‰
SET GLOBAL long_query_time = 2;

-- 3. **å…³é”®**ï¼šè®¾ç½®ä¸º TABLE æ¨¡å¼
SET GLOBAL log_output = 'TABLE';

-- 4. éªŒè¯é…ç½®
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'log_output';
```

#### 3.4.2 Spring Boot é…ç½®

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/information_schema?...
    username: db_doctor
    password: your_password

db-doctor:
  thread-pool:
    ai-analysis:
      core-size: 2
      max-size: 4
      queue-capacity: 50
```

---

## å››ã€éªŒæ”¶æ ‡å‡†

1. âœ“ èƒ½å¤Ÿå®šæ—¶è½®è¯¢ `mysql.slow_log` è¡¨
2. âœ“ èƒ½å¤Ÿæ­£ç¡®è¯»å–æ–°çš„æ…¢æŸ¥è¯¢æ•°æ®ï¼ˆä½¿ç”¨æ¸¸æ ‡ï¼‰
3. âœ“ æ•°æ®åº“åå‡†ç¡®è·å–ï¼ˆä» `db` å­—æ®µï¼‰
4. âœ“ SQL æ–‡æœ¬æ­£ç¡®è¯»å–ï¼ˆCONVERT è§£å†³ BLOB ä¹±ç ï¼‰
5. âœ“ æ—¶é—´å­—æ®µæ­£ç¡®è½¬æ¢ï¼ˆTIME_TO_SECï¼‰
6. âœ“ æ”¯æŒå¼‚æ­¥å¤„ç†ï¼ˆçº¿ç¨‹æ± ï¼‰
7. âœ“ è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®ï¼ˆTRUNCATEï¼‰
8. âœ“ å¼‚å¸¸æƒ…å†µæœ‰åˆç†çš„æ—¥å¿—è¾“å‡º

---

## äº”ã€æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•åœºæ™¯ 1ï¼šåŸºç¡€åŠŸèƒ½

```sql
-- 1. åœ¨ MySQL ä¸­æ‰§è¡Œæ…¢æŸ¥è¯¢
USE shop;
SELECT * FROM orders WHERE SLEEP(3);

-- 2. éªŒè¯æ—¥å¿—å†™å…¥
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 1;

-- 3. éªŒè¯ DB-Doctor æ•è·
-- æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼šğŸ” æ•è·åˆ° 1 æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—
```

### æµ‹è¯•åœºæ™¯ 2ï¼šå¤šæ•°æ®åº“

```sql
-- shop åº“
USE shop;
SELECT * FROM orders WHERE SLEEP(2);

-- product åº“
USE product;
SELECT * FROM items WHERE SLEEP(2);

-- éªŒè¯ï¼šæ¯æ¡æ—¥å¿—çš„ db å­—æ®µéƒ½æ­£ç¡®
```

### æµ‹è¯•åœºæ™¯ 3ï¼šæ¸¸æ ‡æœºåˆ¶

```sql
-- 1. å¯åŠ¨ DB-Doctorï¼ˆè®°å½•å¯åŠ¨æ—¶é—´ï¼‰
-- 2. æ‰§è¡Œæ…¢æŸ¥è¯¢
-- 3. éªŒè¯ï¼šåªè¯»å–å¯åŠ¨åçš„æ…¢æŸ¥è¯¢
```

### æµ‹è¯•åœºæ™¯ 4ï¼šè‡ªåŠ¨æ¸…ç†

```sql
-- 1. ç­‰å¾…å‡Œæ™¨ 3 ç‚¹ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘æ¸…ç†
-- 2. éªŒè¯è¡¨è¢«æ¸…ç©º
SELECT COUNT(*) FROM mysql.slow_log;

-- 3. éªŒè¯æ¸¸æ ‡é‡ç½®
```

---

## å…­ã€ä¸æ–‡ä»¶ç›‘å¬æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | æ–‡ä»¶ç›‘å¬ | è¡¨è½®è¯¢ |
|------|---------|--------|
| å®ç°æ–¹å¼ | Apache Commons IO Tailer | Spring @Scheduled |
| å¤æ‚åº¦ | âŒ é«˜ï¼ˆæ­£åˆ™ã€çŠ¶æ€æœºï¼‰ | âœ… ä½ï¼ˆSQL æŸ¥è¯¢ï¼‰ |
| æ•°æ®åº“åè·å– | âŒ éœ€è¦è§£æ | âœ… ç›´æ¥ä» db å­—æ®µ |
| åŒåè¡¨é—®é¢˜ | âŒ éš¾ä»¥è¯†åˆ« | âœ… å‡†ç¡®è¯†åˆ« |
| BLOB ä¹±ç  | âŒ éœ€è¦ç‰¹æ®Šå¤„ç† | âœ… CONVERT è§£å†³ |
| å¯é æ€§ | âŒ ä¾èµ–æ—¥å¿—æ ¼å¼ | âœ… å®˜æ–¹è¡¨ç»“æ„ |
| ç»´æŠ¤æˆæœ¬ | âŒ é«˜ | âœ… ä½ |

---

## ä¸ƒã€æ³¨æ„äº‹é¡¹

1. âœ… ç¡®ä¿ MySQL é…ç½®äº† `log_output = 'TABLE'`
2. âœ… ç¡®ä¿æ•°æ®æºæœ‰è®¿é—® `mysql.slow_log` è¡¨çš„æƒé™
3. âœ… æ¸¸æ ‡å¿…é¡»æŒ‰æ—¶é—´å‡åºæ›´æ–°
4. âœ… å®šæœŸæ¸…ç†æ—§æ•°æ®ï¼Œé˜²æ­¢è¡¨è¿‡å¤§
5. âœ… ä½¿ç”¨ `CONVERT(sql_text USING utf8)` è§£å†³ BLOB ä¹±ç 
6. âœ… ä½¿ç”¨ `TIME_TO_SEC()` ç®€åŒ–æ—¶é—´å¤„ç†

---

## å…«ã€ç›¸å…³æ–‡ä»¶

- `SlowLogTableMonitor.java` - æ ¸å¿ƒç›‘æ§ç±»
- `SlowQueryLog.java` - æ•°æ®æ¨¡å‹
- `AnalysisService.java` - åˆ†ææœåŠ¡
- `ThreadPoolConfig.java` - çº¿ç¨‹æ± é…ç½®

---

## ä¹ã€SQL æŒ‡çº¹å»é‡æœºåˆ¶ï¼ˆæ–°å¢ï¼‰

### ä¸ºä»€ä¹ˆéœ€è¦å»é‡ï¼Ÿ

#### é—®é¢˜åœºæ™¯
```
æ…¢æŸ¥è¯¢æ—¥å¿—ï¼š
10:00:00 SELECT * FROM orders WHERE user_id = 1;  -- è€—æ—¶ 3s
10:00:01 SELECT * FROM orders WHERE user_id = 2;  -- è€—æ—¶ 3s
10:00:02 SELECT * FROM orders WHERE user_id = 3;  -- è€—æ—¶ 3s
...ï¼ˆé‡å¤ 1000 æ¬¡ï¼‰
```

**æ²¡æœ‰å»é‡çš„é—®é¢˜**ï¼š
- âŒ AI åˆ†æ 1000 æ¬¡
- âŒ æ¶ˆè€—å¤§é‡ Token
- âŒ ç”Ÿæˆ 1000 ä»½ç›¸åŒçš„æŠ¥å‘Š

**å»é‡åçš„æ•ˆæœ**ï¼š
- âœ… AI åˆ†æ 1 æ¬¡
- âœ… ç”Ÿæˆ 1 ä»½æŠ¥å‘Š
- âœ… å…¶ä»– 999 æ¬¡åªå¢åŠ è®¡æ•°

### å»é‡åŸç†

**SQL æŒ‡çº¹ï¼ˆFingerprintï¼‰**ï¼š
- å°†å‚æ•°åŒ–åçš„ SQL ç”Ÿæˆ MD5 å“ˆå¸Œå€¼
- ç›¸åŒç»“æ„çš„ SQLï¼ˆåªæ˜¯å‚æ•°ä¸åŒï¼‰æŒ‡çº¹ç›¸åŒ

**ç¤ºä¾‹**ï¼š
```sql
åŸå§‹ SQL 1: SELECT * FROM orders WHERE user_id = 1
åŸå§‹ SQL 2: SELECT * FROM orders WHERE user_id = 2
åŸå§‹ SQL 3: SELECT * FROM orders WHERE user_id = 999

å‚æ•°åŒ–å:    SELECT * FROM orders WHERE user_id = ?
æŒ‡çº¹ MD5:    a1b2c3d4e5f6g7h8i9j0...
```

**è¿™ä¸‰æ¡ SQL çš„æŒ‡çº¹ç›¸åŒï¼Œè§†ä¸ºåŒä¸€ç±» SQLï¼**

### å®ç°æ­¥éª¤

#### 1. ä½¿ç”¨ Druid è®¡ç®—æŒ‡çº¹

```java
import com.alibaba.druid.sql.SQLUtils;
import com.alibaba.druid.util.JdbcConstants;
import cn.hutool.core.util.SecureUtil;

public String calculateFingerprint(String rawSql) {
    // 1. Druid æ ¼å¼åŒ–ï¼šæŠŠå‚æ•°å˜æˆé—®å·
    String sqlTemplate = SQLUtils.format(
        rawSql,
        JdbcConstants.MYSQL,
        SQLUtils.DEFAULT_FORMAT_OPTION
    );

    // 2. è®¡ç®— MD5 ä½œä¸ºæŒ‡çº¹
    return SecureUtil.md5(sqlTemplate);
}
```

#### 2. æŸ¥è¯¢å†å²åˆ¤æ–­æ˜¯å¦é‡å¤

```java
@Service
public class AnalysisService {

    @Autowired
    private SlowQueryHistoryRepository historyRepo; // JPA Repositoryï¼ˆè¿æ¥ H2ï¼‰

    public void processSlowQuery(SlowQueryLog slowLog) {
        String rawSql = slowLog.getSqlText();
        String dbName = slowLog.getDbName();

        // 1. è®¡ç®— SQL æŒ‡çº¹
        String fingerprint = calculateFingerprint(rawSql);

        // 2. æŸ¥è¯¢ H2ï¼šæ˜¯å¦å·²å­˜åœ¨ï¼Ÿ
        SlowQueryHistory history = historyRepo.findBySqlFingerprint(fingerprint);

        if (history != null) {
            // === æƒ…å†µ Aï¼šè€é¢å­”ï¼ˆå·²åˆ†æè¿‡ï¼‰ ===
            handleExistingQuery(history, slowLog);
        } else {
            // === æƒ…å†µ Bï¼šæ–°é¢å­”ï¼ˆé¦–æ¬¡å‘ç°ï¼‰ ===
            handleNewQuery(fingerprint, rawSql, dbName, slowLog);
        }
    }

    private void handleExistingQuery(SlowQueryHistory history, SlowQueryLog slowLog) {
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        history.setOccurrenceCount(history.getOccurrenceCount() + 1);
        history.setLastSeenTime(LocalDateTime.now());
        history.setExampleSql(slowLog.getSqlText()); // æ›´æ–°æœ€æ–°æ ·æœ¬

        // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ†æ
        if (shouldReAnalyze(history)) {
            // è§¦å‘ AI åˆ†æ
            runAiAnalysis(history);
        } else {
            log.info("é‡å¤ SQLï¼Œè·³è¿‡ AI åˆ†æ: fingerprint={}, count={}",
                history.getSqlFingerprint(), history.getOccurrenceCount());
        }

        historyRepo.save(history); // ä¿å­˜åˆ° H2
    }

    private void handleNewQuery(String fingerprint, String rawSql, String dbName, SlowQueryLog slowLog) {
        // åˆ›å»ºæ–°è®°å½•
        SlowQueryHistory history = new SlowQueryHistory();
        history.setSqlFingerprint(fingerprint);
        history.setSqlTemplate(extractSqlTemplate(rawSql));
        history.setExampleSql(rawSql);
        history.setDbName(dbName);
        history.setFirstSeenTime(LocalDateTime.now());
        history.setLastSeenTime(LocalDateTime.now());
        history.setStatus("PENDING");
        history.setOccurrenceCount(1L);

        // ä¿å­˜åˆ° H2ï¼ˆæœ¬åœ°æ•°æ®åº“ï¼‰
        history = historyRepo.save(history);

        // è§¦å‘ AI åˆ†æ
        runAiAnalysis(history);
    }

    private boolean shouldReAnalyze(SlowQueryHistory history) {
        // é‡æ–°åˆ†ææ¡ä»¶ï¼š
        // 1. ä¸Šæ¬¡åˆ†æå¤±è´¥
        if ("ERROR".equals(history.getStatus())) {
            return true;
        }

        // 2. è·ç¦»ä¸Šæ¬¡åˆ†æè¶…è¿‡ 7 å¤©
        if (history.getLastSeenTime().isAfter(
            history.getFirstSeenTime().plusDays(7)
        )) {
            return true;
        }

        return false;
    }
}
```

---

## åã€åŒæ•°æ®æºæ¶æ„ï¼ˆé‡è¦ï¼‰

### æ¶æ„è®¾è®¡

**"ä¸Šå¸çš„å½’ä¸Šå¸ï¼Œå‡¯æ’’çš„å½’å‡¯æ’’"**

- **H2 æ•°æ®åº“**ï¼ˆä¸»æ•°æ®æºï¼‰ï¼šå­˜å‚¨ DB-Doctor è‡ªå·±çš„æ•°æ®ï¼ˆåˆ†æå†å²ã€SQL æŒ‡çº¹ç­‰ï¼‰
- **ç”¨æˆ· MySQL**ï¼ˆç›®æ ‡æ•°æ®æºï¼‰ï¼šåªè¯»è®¿é—®ï¼ˆæŸ¥è¯¢ slow_logã€æ‰§è¡Œ EXPLAINï¼‰

### ä¸ºä»€ä¹ˆéœ€è¦åŒæ•°æ®æºï¼Ÿ

1. **é›¶ä¾µå…¥åŸåˆ™**ï¼šä¸èƒ½åœ¨ç”¨æˆ·çš„ MySQL ä¸­åˆ›å»ºè¡¨å­˜å‚¨æˆ‘ä»¬çš„æ•°æ®
2. **å»é‡éœ€æ±‚**ï¼šéœ€è¦ä¿å­˜ SQL æŒ‡çº¹å’Œåˆ†æå†å²
3. **å†å²è®°å½•**ï¼šéœ€è¦ä¿å­˜ AI åˆ†ææŠ¥å‘Š
4. **ç»¿è‰²ä¸­é—´ä»¶**ï¼šæ‰€æœ‰æ•°æ®å­˜åœ¨æœ¬åœ°æ–‡ä»¶ï¼Œåˆ é™¤å³å¯å¸è½½

### H2 æ•°æ®æºé…ç½®

**é…ç½®**ï¼ˆapplication.ymlï¼‰ï¼š
```yaml
spring:
  datasource:
    # H2 å­˜æ–‡ä»¶åˆ°å½“å‰ç›®å½•ä¸‹çš„ data æ–‡ä»¶å¤¹
    url: jdbc:h2:file:./data/db-doctor-internal;DB_CLOSE_DELAY=-1;MODE=MySQL
    driver-class-name: org.h2.Driver
    username: sa
    password:

  jpa:
    hibernate:
      ddl-auto: update  # è‡ªåŠ¨å»ºè¡¨
    show-sql: false
```

**ç‰¹ç‚¹**ï¼š
- Spring Boot é»˜è®¤æ•°æ®æº
- JPA / Hibernate è‡ªåŠ¨è¯†åˆ«
- è‡ªåŠ¨å»ºè¡¨ï¼ˆddl-auto: updateï¼‰
- æ•°æ®å­˜å‚¨ä¸ºæœ¬åœ°æ–‡ä»¶

### MySQL ç›®æ ‡æ•°æ®æºé…ç½®

**é…ç½®**ï¼ˆapplication.ymlï¼‰ï¼š
```yaml
target-db:
  url: jdbc:mysql://localhost:3306/information_schema?...
  username: db_doctor
  password: your_password
  driver-class-name: com.mysql.cj.jdbc.Driver
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```java
@Service
public class SlowLogTableMonitor {

    @Autowired
    @Qualifier("targetJdbcTemplate")  // âš ï¸ è¿ç”¨æˆ· MySQL
    private JdbcTemplate targetJdbcTemplate;

    public void pollSlowLog() {
        // æŸ¥è¯¢ç”¨æˆ·çš„ MySQL
        targetJdbcTemplate.queryForList("SELECT * FROM mysql.slow_log...");
    }
}
```

### æ•°æ®æµå‘

```
ç”¨æˆ·çš„ MySQL (åªè¯»)
    â†“
targetJdbcTemplate
    â†“
SlowLogTableMonitor (è½®è¯¢)
    â†“
AnalysisService (å»é‡ + åˆ†æ)
    â†“
JPA Repository
    â†“
H2 æœ¬åœ°æ•°æ®åº“ (å­˜å‚¨)
```

---

## åä¸€ã€ä¾èµ–æ¸…å•

æ–°å¢ä¾èµ–ï¼š

```xml
<!-- H2 æœ¬åœ°æ•°æ®åº“ -->
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope>
</dependency>

<!-- Druid (SQL è§£æå’ŒæŒ‡çº¹è®¡ç®—) -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid</artifactId>
    <version>1.2.20</version>
</dependency>

<!-- Hutool (MD5 è®¡ç®—) -->
<dependency>
    <groupId>cn.hutool</groupId>
    <artifactId>hutool-all</artifactId>
    <version>5.8.20</version>
</dependency>
```

---

## åäºŒã€å®Œæ•´çš„æ•°æ®æµ

```
1. è½®è¯¢ mysql.slow_log (targetJdbcTemplate)
   â†“
2. æå–æ…¢æŸ¥è¯¢æ•°æ® (SlowQueryLog)
   â†“
3. è®¡ç®— SQL æŒ‡çº¹ (Druid + MD5)
   â†“
4. æŸ¥è¯¢ H2 æ•°æ®åº“ (JPA Repository)
   â†“
5. åˆ¤æ–­æ˜¯å¦é‡å¤ï¼Ÿ
   â”œâ”€ æ–° SQL â†’ è§¦å‘ AI åˆ†æ â†’ ä¿å­˜æŠ¥å‘Šåˆ° H2
   â””â”€ è€ SQL â†’ æ›´æ–°è®¡æ•° â†’ è·³è¿‡åˆ†æ
   â†“
6. å‘é€é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
```

---

## åä¸‰ã€é¢è¯•è¯æœ¯

**é¢è¯•å®˜é—®**ï¼š"ä½ çš„ä¸­é—´ä»¶éœ€è¦ä¾µå…¥ç”¨æˆ·æ•°æ®åº“å»ºè¡¨å—ï¼Ÿ"

**ä½ çš„å›ç­”**ï¼š
```
å®Œå…¨ä¸éœ€è¦ï¼Œè¿™æ˜¯æˆ‘æ¶æ„è®¾è®¡çš„åº•çº¿ã€‚

æˆ‘é‡‡ç”¨äº†åŒæ•°æ®æºéš”ç¦»æ¶æ„ï¼š

1. ä¸šåŠ¡æ¢é’ˆï¼šä½¿ç”¨åªè¯»æƒé™çš„ JDBC è¿æ¥ç”¨æˆ·çš„ MySQLï¼Œ
   ä»…ç”¨äºæ‰§è¡Œ EXPLAIN å’Œè¯»å– slow_log ç³»ç»Ÿè¡¨ï¼Œ
   åšåˆ°äº†é›¶ä¾µå…¥ã€é›¶æ±¡æŸ“ã€‚

2. è‡ªèº«çŠ¶æ€ï¼šå†…åµŒäº†ä¸€ä¸ª H2 æ•°æ®åº“ï¼ˆFile Modeï¼‰ã€‚
   æ‰€æœ‰ç»è¿‡ AI åˆ†æç”Ÿæˆçš„è¯Šæ–­æŠ¥å‘Šã€æŒ‡çº¹å»é‡æ•°æ®ï¼Œ
   éƒ½ä¿å­˜åœ¨ä¸­é—´ä»¶éƒ¨ç½²ç›®å½•ä¸‹çš„æœ¬åœ°æ–‡ä»¶ä¸­ã€‚

è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œç”¨æˆ·åˆ æ‰æˆ‘çš„ä¸­é—´ä»¶æ–‡ä»¶å¤¹ï¼Œ
å°±åƒä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿè¿‡ä¸€æ ·ï¼Œä¸ä¼šåœ¨ä»–ä»¬çš„ç”Ÿäº§åº“é‡Œç•™ä¸‹ä»»ä½•åƒåœ¾è¡¨ã€‚
```
