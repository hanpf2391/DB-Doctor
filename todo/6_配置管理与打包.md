# DB-Doctor 配置管理与打包

## 一、开发目标

实现配置文件外部化、Maven Assembly 打包配置、跨平台启动脚本，实现"代码与配置分离"的 Nacos 式发布结构。

## 二、功能描述

使用 Maven Assembly Plugin 将项目打包成可发布的目录结构，配置文件独立放置，支持 Linux 和 Windows 平台启动。

## 三、详细开发任务

### 3.1 配置文件模板

#### 3.1.1 application.yml (完整配置)

**位置**: `src/main/resources/application.yml`

```yaml
server:
  port: 8080

spring:
  application:
    name: db-doctor

  # 数据源配置（只读）
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/information_schema?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: db_doctor
    password: your_password
    druid:
      read-only: true
      initial-size: 2
      min-idle: 2
      max-active: 10
      max-wait: 60000
      validation-query: SELECT 1
      test-while-idle: true

  # 邮件配置
  mail:
    host: smtp.example.com
    port: 465
    username: noreply@example.com
    password: your_password
    protocol: smtps
    properties:
      mail.smtp.ssl.enable: true

# DB-Doctor 自定义配置
db-doctor:
  # 日志监听配置
  log:
    slow-log-path: /var/log/mysql/slow-query.log
    check-interval: 1000
    tail-from-end: true
    # 日志编码
    encoding: UTF-8

  # AI 配置
  ai:
    enabled: true
    # 一次分析的最大日志数量（防止过载）
    max-concurrent-analysis: 4

  # 通知配置
  notify:
    # 启用的通知渠道（email, webhook）
    enabled-notifiers: email,webhook
    # 通知间隔（秒），防止同一问题频繁通知
    notify-interval: 3600
    # 严重程度阈值（低于此值不通知）
    severity-threshold: 3.0

    email:
      enabled: true
      from: DB-Doctor <noreply@example.com>
      to:
        - dba@example.com
        - dev-team@example.com
      cc:
        - manager@example.com

    webhook:
      dingtalk:
        enabled: false
        webhook-url: https://oapi.dingtalk.com/robot/send?access_token=xxx
        secret: SEC***
      feishu:
        enabled: false
        webhook-url: https://open.feishu.cn/open-apis/bot/v2/hook/xxx
      wecom:
        enabled: false
        webhook-url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx

# LangChain4j 配置
langchain4j:
  open-ai:
    api-key: ${OPENAI_API_KEY:sk-xxx}
    model-name: ${OPENAI_MODEL:gpt-4}
    base-url: ${OPENAI_BASE_URL:https://api.openai.com/v1}
    temperature: 0.0
    timeout: 60s
    max-tokens: 2000

# 日志配置
logging:
  level:
    com.dbdoctor: INFO
    org.springframework.jdbc: WARN
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n'
  file:
    name: logs/db-doctor.log
    max-size: 100MB
    max-history: 30

# 线程池配置
db-doctor:
  thread-pool:
    # 日志解析线程池
    log-parser:
      core-size: 4
      max-size: 8
      queue-capacity: 100
    # AI 分析线程池
    ai-analysis:
      core-size: 2
      max-size: 4
      queue-capacity: 50
```

### 3.2 Maven Assembly 配置

#### 3.2.1 pom.xml 配置

**位置**: `pom.xml`

```xml
<project>
    <!-- ... 其他配置 ... -->

    <build>
        <plugins>
            <!-- Spring Boot Maven Plugin -->
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <executable>true</executable>
                </configuration>
            </plugin>

            <!-- Maven Assembly Plugin -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-assembly-plugin</artifactId>
                <version>3.6.0</version>
                <configuration>
                    <descriptors>
                        <descriptor>src/main/assembly/package.xml</descriptor>
                    </descriptors>
                    <finalName>db-doctor-${project.version}</finalName>
                </configuration>
                <executions>
                    <execution>
                        <id>make-assembly</id>
                        <phase>package</phase>
                        <goals>
                            <goal>single</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
```

#### 3.2.2 Assembly 描述文件

**位置**: `src/main/assembly/package.xml`

```xml
<assembly xmlns="http://maven.apache.org/ASSEMBLY/2.2.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/ASSEMBLY/2.2.0
          https://maven.apache.org/xsd/assembly-2.2.0.xsd">

    <id>bin</id>

    <!-- 打包格式 -->
    <formats>
        <format>tar.gz</format>  <!-- Linux -->
        <format>zip</format>     <!-- Windows -->
    </formats>

    <includeBaseDirectory>true</includeBaseDirectory>
    <baseDirectory>db-doctor-${project.version}</baseDirectory>

    <fileSets>
        <!-- 启动脚本 -->
        <fileSet>
            <directory>bin</directory>
            <outputDirectory>bin</outputDirectory>
            <fileMode>0755</fileMode>  <!-- 可执行权限 -->
        </fileSet>

        <!-- 配置文件 -->
        <fileSet>
            <directory>src/main/resources</directory>
            <outputDirectory>config</outputDirectory>
            <includes>
                <include>application.yml</include>
            </includes>
        </fileSet>

        <!-- README -->
        <fileSet>
            <directory>${project.basedir}</directory>
            <outputDirectory></outputDirectory>
            <includes>
                <include>README.md</include>
                <include>LICENSE</include>
            </includes>
        </fileSet>
    </fileSets>

    <dependencySets>
        <!-- 依赖 JAR -->
        <dependencySet>
            <outputDirectory>lib</outputDirectory>
            <scope>runtime</scope>
        </dependencySet>

        <!-- 应用主 JAR -->
        <dependencySet>
            <outputDirectory>lib</outputDirectory>
            <includes>
                <include>${project.groupId}:${project.artifactId}</include>
            </includes>
        </dependencySet>
    </dependencySets>

</assembly>
```

### 3.3 启动脚本

#### 3.3.1 Linux 启动脚本 (startup.sh)

**位置**: `bin/startup.sh`

```bash
#!/bin/bash

###############################################################################
# DB-Doctor 启动脚本 (Linux)
###############################################################################

# 设置 JAVA_HOME（如果未设置）
if [ -z "$JAVA_HOME" ]; then
    JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
    echo "检测到 JAVA_HOME: $JAVA_HOME"
fi

# 应用名称
APP_NAME="db-doctor"
APP_VERSION="1.0.0"

# 获取脚本所在目录
APP_HOME=$(cd $(dirname $0); cd ..; pwd)

echo "======================================"
echo "DB-Doctor 启动中..."
echo "应用目录: $APP_HOME"
echo "======================================"

# JVM 参数
JVM_OPTS="-Xms512m -Xmx1024m"
JVM_OPTS="$JVM_OPTS -XX:+UseG1GC"
JVM_OPTS="$JVM_OPTS -XX:MaxGCPauseMillis=200"
JVM_OPTS="$JVM_OPTS -XX:+HeapDumpOnOutOfMemoryError"
JVM_OPTS="$JVM_OPTS -XX:HeapDumpPath=$APP_HOME/logs/heap_dump.hprof"

# 应用参数
APP_OPTS="--spring.config.location=$APP_HOME/config/application.yml"
APP_OPTS="$APP_OPTS --logging.file.path=$APP_HOME/logs"

# CLASSPATH
CLASSPATH="$APP_HOME/lib/*"
CLASSPATH="$APP_HOME/config:$CLASSPATH"

# PID 文件
PID_FILE="$APP_HOME/db-doctor.pid"

# 检查是否已经运行
if [ -f "$PID_FILE" ]; then
    PID=$(cat $PID_FILE)
    if ps -p $PID > /dev/null 2>&1; then
        echo "DB-Doctor 已经在运行 (PID: $PID)"
        exit 1
    else
        echo "清理旧的 PID 文件"
        rm -f $PID_FILE
    fi
fi

# 创建日志目录
mkdir -p $APP_HOME/logs

# 启动应用
echo "启动命令: $JAVA_HOME/bin/java $JVM_OPTS -cp $CLASSPATH com.dbdoctor.DbDoctorApplication $APP_OPTS"
echo ""

nohup $JAVA_HOME/bin/java $JVM_OPTS -cp $CLASSPATH com.dbdoctor.DbDoctorApplication $APP_OPTS > $APP_HOME/logs/stdout.log 2>&1 &

# 记录 PID
PID=$!
echo $PID > $PID_FILE

echo "DB-Doctor 启动成功 (PID: $PID)"
echo "日志文件: $APP_HOME/logs/db-doctor.log"
echo "标准输出: $APP_HOME/logs/stdout.log"
echo ""
echo "查看日志: tail -f $APP_HOME/logs/db-doctor.log"
echo "停止应用: kill $PID 或 bin/shutdown.sh"
```

#### 3.3.2 Windows 启动脚本 (startup.cmd)

**位置**: `bin/startup.cmd`

```batch
@echo off
REM #############################################################################
REM DB-Doctor 启动脚本 (Windows)
REM #############################################################################

setlocal enabledelayedexpansion

REM 应用名称
set APP_NAME=db-doctor
set APP_VERSION=1.0.0

REM 获取脚本所在目录
set APP_HOME=%~dp0..
set APP_HOME=%APP_HOME:\=/%

echo ======================================
echo DB-Doctor 启动中...
echo 应用目录: %APP_HOME%
echo ======================================

REM JVM 参数
set JVM_OPTS=-Xms512m -Xmx1024m
set JVM_OPTS=%JVM_OPTS% -XX:+UseG1GC
set JVM_OPTS=%JVM_OPTS% -XX:MaxGCPauseMillis=200
set JVM_OPTS=%JVM_OPTS% -XX:+HeapDumpOnOutOfMemoryError
set JVM_OPTS=%JVM_OPTS% -XX:HeapDumpPath=%APP_HOME%/logs/heap_dump.hprof

REM 应用参数
set APP_OPTS=--spring.config.location=%APP_HOME%/config/application.yml
set APP_OPTS=%APP_OPTS% --logging.file.path=%APP_HOME%/logs

REM CLASSPATH
set CLASSPATH=%APP_HOME%/lib/*
set CLASSPATH=%APP_HOME%/config;%CLASSPATH%

REM 创建日志目录
if not exist "%APP_HOME%\logs" mkdir "%APP_HOME%\logs"

REM 启动应用
echo 启动命令: java %JVM_OPTS% -cp %CLASSPATH% com.dbdoctor.DbDoctorApplication %APP_OPTS%
echo.

start "DB-Doctor" java %JVM_OPTS% -cp %CLASSPATH% com.dbdoctor.DbDoctorApplication %APP_OPTS%

echo DB-Doctor 启动成功
echo 日志文件: %APP_HOME%\logs\db-doctor.log
echo.
pause
```

#### 3.3.3 Linux 停止脚本 (shutdown.sh)

**位置**: `bin/shutdown.sh`

```bash
#!/bin/bash

APP_HOME=$(cd $(dirname $0); cd ..; pwd)
PID_FILE="$APP_HOME/db-doctor.pid"

if [ -f "$PID_FILE" ]; then
    PID=$(cat $PID_FILE)
    echo "正在停止 DB-Doctor (PID: $PID)..."
    kill $PID

    # 等待进程结束
    for i in {1..30}; do
        if ! ps -p $PID > /dev/null 2>&1; then
            echo "DB-Doctor 已停止"
            rm -f $PID_FILE
            exit 0
        fi
        sleep 1
    done

    # 强制结束
    echo "强制停止 DB-Doctor"
    kill -9 $PID
    rm -f $PID_FILE
else
    echo "PID 文件不存在，DB-Doctor 可能未运行"
fi
```

### 3.4 最终打包目录结构

执行 `mvn clean package` 后生成的目录结构：

```
db-doctor-1.0.0/
├── bin/
│   ├── startup.sh        # Linux 启动脚本（可执行）
│   ├── startup.cmd       # Windows 启动脚本
│   └── shutdown.sh       # Linux 停止脚本
├── config/
│   └── application.yml   # 配置文件（可修改）
├── lib/
│   ├── db-doctor-1.0.0.jar        # 应用主 JAR
│   ├── spring-boot-starter-*.jar  # Spring Boot 依赖
│   ├── langchain4j-*.jar          # LangChain4j 依赖
│   ├── druid-*.jar                # Druid 依赖
│   └── ...                        # 其他依赖
├── logs/                    # 日志目录（运行时生成）
├── README.md
└── LICENSE
```

### 3.5 配置文件外部化

确保应用启动时从外部配置文件读取：

#### 3.5.1 方式 1：启动参数指定

```bash
java -jar db-doctor.jar --spring.config.location=/path/to/config/application.yml
```

#### 3.5.2 方式 2：环境变量

```bash
export SPRING_CONFIG_LOCATION=/path/to/config/application.yml
java -jar db-doctor.jar
```

#### 3.5.3 方式 3：默认查找路径

Spring Boot 会自动按以下顺序查找配置文件：
1. 当前目录的 `config/` 子目录
2. 当前目录
3. classpath 根目录
4. classpath 的 `config/` 目录

**推荐**: 将配置文件放在 `<APP_HOME>/config/` 目录下

### 3.6 配置校验

启动时校验必填配置项：

```java
@Component
public class ConfigValidator implements ApplicationRunner {

    @Value("${db-doctor.log.slow-log-path}")
    private String slowLogPath;

    @Value("${langchain4j.open-ai.api-key}")
    private String apiKey;

    @Override
    public void run(ApplicationArguments args) {
        // 校验配置
        List<String> errors = new ArrayList<>();

        if (StringUtils.isEmpty(slowLogPath)) {
            errors.add("配置项缺失: db-doctor.log.slow-log-path");
        }

        if (StringUtils.isEmpty(apiKey) || "sk-xxx".equals(apiKey)) {
            errors.add("配置项缺失或无效: langchain4j.open-ai.api-key");
        }

        if (!errors.isEmpty()) {
            System.err.println("配置校验失败:");
            errors.forEach(System.err::println);
            System.exit(1);
        }

        log.info("配置校验通过");
    }
}
```

## 四、验收标准

1. ✓ `mvn clean package` 能够成功打包
2. ✓ 生成的 tar.gz 和 zip 包结构正确
3. ✓ Linux 启动脚本能够正常启动应用
4. ✓ Windows 启动脚本能够正常启动应用
5. ✓ 修改外部配置文件后重启生效
6. ✓ 日志文件正确输出到 logs 目录

## 五、部署步骤

### 5.1 打包

```bash
mvn clean package
```

生成文件：
- `target/db-doctor-1.0.0-bin.tar.gz` (Linux)
- `target/db-doctor-1.0.0-bin.zip` (Windows)

### 5.2 Linux 部署

```bash
# 1. 解压
tar -xzf db-doctor-1.0.0-bin.tar.gz
cd db-doctor-1.0.0

# 2. 修改配置
vi config/application.yml

# 3. 启动
chmod +x bin/*.sh
./bin/startup.sh

# 4. 查看日志
tail -f logs/db-doctor.log
```

### 5.3 Windows 部署

```cmd
REM 1. 解压
unzip db-doctor-1.0.0-bin.zip
cd db-doctor-1.0.0

REM 2. 修改配置
notepad config\application.yml

REM 3. 启动
bin\startup.cmd
```

## 六、注意事项

1. **路径分隔符**: Windows 使用 `\`，Linux 使用 `/`
2. **文件权限**: Linux 脚本需添加可执行权限 (`chmod +x`)
3. **JAVA_HOME**: 确保系统已安装 Java 17+
4. **文件编码**: 配置文件使用 UTF-8 编码
5. **日志轮转**: 配置日志文件大小和保留天数
