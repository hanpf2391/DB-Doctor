# DB-Doctor é€šçŸ¥æ¨¡å—å¼€å‘

## ä¸€ã€å¼€å‘ç›®æ ‡

å®ç°é€šçŸ¥æœåŠ¡ï¼Œå°† AI ç”Ÿæˆçš„è¯Šæ–­æŠ¥å‘Šé€šè¿‡é‚®ä»¶æˆ– Webhookï¼ˆé’‰é’‰/é£ä¹¦ï¼‰å‘é€ç»™ç”¨æˆ·ã€‚

## äºŒã€åŠŸèƒ½æè¿°

å®šä¹‰ Notifier æ¥å£ï¼Œæ”¯æŒ Email å’Œ Webhook ä¸¤ç§å®ç°æ–¹å¼ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶çµæ´»åˆ‡æ¢ï¼Œæ”¯æŒå¤šç§é€šçŸ¥æ¸ é“åŒæ—¶å¯ç”¨ã€‚

## ä¸‰ã€è¯¦ç»†å¼€å‘ä»»åŠ¡

### 3.1 Notifier æ¥å£å®šä¹‰

**ä½ç½®**: `src/main/java/com/dbdoctor/notifier/Notifier.java`

```java
public interface Notifier {

    /**
     * å‘é€é€šçŸ¥
     * @param entry æ…¢æŸ¥è¯¢æ—¥å¿—å¯¹è±¡
     * @param report AI ç”Ÿæˆçš„è¯Šæ–­æŠ¥å‘Šï¼ˆMarkdown æ ¼å¼ï¼‰
     * @return æ˜¯å¦å‘é€æˆåŠŸ
     */
    boolean sendNotification(SlowLogEntry entry, String report);

    /**
     * è·å–é€šçŸ¥å™¨åç§°
     */
    String getName();
}
```

### 3.2 Email é€šçŸ¥å®ç°

**ä½ç½®**: `src/main/java/com/dbdoctor/notifier/EmailNotifier.java`

#### 3.2.1 é‚®ä»¶é…ç½® (application.yml)

```yaml
db-doctor:
  notify:
    email:
      enabled: true
      # SMTP æœåŠ¡å™¨é…ç½®
      host: smtp.example.com
      port: 465
      username: noreply@example.com
      password: your_password
      protocol: smtps
      # å‘ä»¶äººä¿¡æ¯
      from: DB-Doctor <noreply@example.com>
      # æ”¶ä»¶äººåˆ—è¡¨ï¼ˆæ”¯æŒå¤šä¸ªï¼‰
      to:
        - dba@example.com
        - dev-team@example.com
      # æ˜¯å¦æŠ„é€
      cc:
        - manager@example.com
      # é‚®ä»¶ä¸»é¢˜æ¨¡æ¿
      subject: "DB-Doctor æ…¢æŸ¥è¯¢å‘Šè­¦ - {database}"
```

#### 3.2.2 é‚®ä»¶å†…å®¹æ¨¡æ¿

```java
@Component
public class EmailNotifier implements Notifier {

    @Autowired
    private JavaMailSender mailSender;

    @Value("${db-doctor.notify.email.from}")
    private String from;

    @Value("${db-doctor.notify.email.to}")
    private List<String> toList;

    @Override
    public boolean sendNotification(SlowLogEntry entry, String report) {
        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");

            // å‘ä»¶äºº
            helper.setFrom(from);

            // æ”¶ä»¶äºº
            helper.setTo(toList.toArray(new String[0]));

            // ä¸»é¢˜
            String subject = String.format(
                "DB-Doctor æ…¢æŸ¥è¯¢å‘Šè­¦ - %s (è€—æ—¶ %.2fs)",
                entry.getDatabase(),
                entry.getQueryTime()
            );
            helper.setSubject(subject);

            // æ­£æ–‡ï¼ˆHTML æ ¼å¼ï¼‰
            String content = buildEmailContent(entry, report);
            helper.setText(content, true);

            // å‘é€
            mailSender.send(message);

            log.info("é‚®ä»¶é€šçŸ¥å‘é€æˆåŠŸ: {}", toList);
            return true;

        } catch (Exception e) {
            log.error("é‚®ä»¶é€šçŸ¥å‘é€å¤±è´¥: {}", e.getMessage(), e);
            return false;
        }
    }

    /**
     * æ„å»ºé‚®ä»¶å†…å®¹
     */
    private String buildEmailContent(SlowLogEntry entry, String report) {
        return String.format("""
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <style>
                    body { font-family: Arial, sans-serif; font-size: 14px; }
                    .header { background-color: #f44336; color: white; padding: 15px; }
                    .content { padding: 20px; }
                    .sql-box { background-color: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; }
                    .report { background-color: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin-top: 20px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h2>ğŸš¨ DB-Doctor æ…¢æŸ¥è¯¢å‘Šè­¦</h2>
                </div>
                <div class="content">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <p><strong>æ•°æ®åº“ï¼š</strong>%s</p>
                    <p><strong>å‘ç”Ÿæ—¶é—´ï¼š</strong>%s</p>
                    <p><strong>æŸ¥è¯¢è€—æ—¶ï¼š</strong>%.2f ç§’</p>
                    <p><strong>é”ç­‰å¾…æ—¶é—´ï¼š</strong>%.3f ç§’</p>
                    <p><strong>æ‰«æè¡Œæ•°ï¼š</strong>%,d è¡Œ</p>

                    <h3>SQL è¯­å¥</h3>
                    <div class="sql-box">%s</div>

                    <div class="report">
                        <h3>AI è¯Šæ–­æŠ¥å‘Š</h3>
                        %s
                    </div>

                    <hr>
                    <p style="color: #999; font-size: 12px;">
                        æœ¬é‚®ä»¶ç”± DB-Doctor è‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚<br>
                        DB-Doctor v1.0 - MySQL æ…¢æŸ¥è¯¢æ™ºèƒ½è¯Šç–—ç³»ç»Ÿ
                    </p>
                </div>
            </body>
            </html>
            """,
            entry.getDatabase(),
            entry.getTime(),
            entry.getQueryTime(),
            entry.getLockTime(),
            entry.getRowsExamined(),
            escapeHtml(entry.getSql()),
            report
        );
    }

    private String escapeHtml(String sql) {
        return sql.replace("<", "&lt;")
                  .replace(">", "&gt;");
    }
}
```

### 3.3 Webhook é€šçŸ¥å®ç°

**ä½ç½®**: `src/main/java/com/dbdoctor/notifier/WebhookNotifier.java`

#### 3.3.1 Webhook é…ç½® (application.yml)

```yaml
db-doctor:
  notify:
    webhook:
      # é’‰é’‰é…ç½®
      dingtalk:
        enabled: false
        webhook-url: https://oapi.dingtalk.com/robot/send?access_token=xxx
        secret: SEC***  # å¯é€‰ï¼ŒåŠ ç­¾éªŒè¯

      # é£ä¹¦é…ç½®
      feishu:
        enabled: true
        webhook-url: https://open.feishu.cn/open-apis/bot/v2/hook/xxx

      # ä¼ä¸šå¾®ä¿¡é…ç½®
      wecom:
        enabled: false
        webhook-url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx
```

#### 3.3.2 é’‰é’‰æ¶ˆæ¯æ ¼å¼

```java
private String buildDingTalkMessage(SlowLogEntry entry, String report) {
    Map<String, Object> message = new HashMap<>();
    message.put("msgtype", "markdown");

    Map<String, String> markdown = new HashMap<>();
    markdown.put("title", "DB-Doctor æ…¢æŸ¥è¯¢å‘Šè­¦");
    markdown.put("text", String.format("""
        ### ğŸš¨ DB-Doctor æ…¢æŸ¥è¯¢å‘Šè­¦

        **æ•°æ®åº“**ï¼š%s
        **å‘ç”Ÿæ—¶é—´**ï¼š%s
        **æŸ¥è¯¢è€—æ—¶**ï¼š%.2f ç§’
        **é”ç­‰å¾…æ—¶é—´**ï¼š%.3f ç§’
        **æ‰«æè¡Œæ•°**ï¼š%,d è¡Œ

        #### SQL è¯­å¥
        ```sql
        %s
        ```

        #### AI è¯Šæ–­æŠ¥å‘Š
        %s

        ---
        *DB-Doctor v1.0 - MySQL æ…¢æŸ¥è¯¢æ™ºèƒ½è¯Šç–—ç³»ç»Ÿ*
        """,
        entry.getDatabase(),
        entry.getTime(),
        entry.getQueryTime(),
        entry.getLockTime(),
        entry.getRowsExamined(),
        entry.getSql(),
        report
    ));

    message.put("markdown", markdown);
    return JSON.toJSONString(message);
}
```

#### 3.3.3 é£ä¹¦æ¶ˆæ¯æ ¼å¼

```java
private String buildFeishuMessage(SlowLogEntry entry, String report) {
    Map<String, Object> message = new HashMap<>();
    message.put("msg_type", "interactive");

    Map<String, Object> card = new HashMap<>();
    card.put("title", String.format("ğŸš¨ DB-Doctor æ…¢æŸ¥è¯¢å‘Šè­¦ - %s", entry.getDatabase()));

    // æ„å»ºå¡ç‰‡å†…å®¹
    Map<String, Object> content = new HashMap<>();
    // ... é£ä¹¦å¡ç‰‡æ ¼å¼

    message.put("card", card);
    return JSON.toJSONString(message);
}
```

#### 3.3.4 Webhook å‘é€é€»è¾‘

```java
@Override
public boolean sendNotification(SlowLogEntry entry, String report) {
    try {
        // 1. ç¡®å®šå‘é€ç›®æ ‡ï¼ˆé’‰é’‰/é£ä¹¦/ä¼ä¸šå¾®ä¿¡ï¼‰
        String webhookUrl = getWebhookUrl();
        String payload = buildMessage(entry, report);

        // 2. å‘é€ HTTP POST è¯·æ±‚
        String response = HttpUtil.post(webhookUrl, payload);

        // 3. éªŒè¯å“åº”
        JSONObject json = JSON.parseObject(response);
        if (json.getInteger("errcode") == 0) {
            log.info("Webhook é€šçŸ¥å‘é€æˆåŠŸ");
            return true;
        } else {
            log.error("Webhook é€šçŸ¥å‘é€å¤±è´¥: {}", json.getString("errmsg"));
            return false;
        }

    } catch (Exception e) {
        log.error("Webhook é€šçŸ¥å‘é€å¼‚å¸¸: {}", e.getMessage(), e);
        return false;
    }
}
```

### 3.4 NotifyService å®ç°

**ä½ç½®**: `src/main/java/com/dbdoctor/service/NotifyService.java`

```java
@Service
public class NotifyService {

    @Autowired
    private List<Notifier> notifiers;  // è‡ªåŠ¨æ³¨å…¥æ‰€æœ‰ Notifier å®ç°

    @Value("${db-doctor.notify.enabled-notifiers:email}")
    private List<String> enabledNotifiers;

    /**
     * å‘é€é€šçŸ¥åˆ°æ‰€æœ‰å¯ç”¨çš„æ¸ é“
     */
    public void sendNotification(SlowLogEntry entry, String report) {
        if (notifiers == null || notifiers.isEmpty()) {
            log.warn("æ²¡æœ‰é…ç½®ä»»ä½•é€šçŸ¥å™¨");
            return;
        }

        // è¿‡æ»¤å‡ºå¯ç”¨çš„é€šçŸ¥å™¨
        List<Notifier> activeNotifiers = notifiers.stream()
            .filter(n -> enabledNotifiers.contains(n.getName()))
            .toList();

        if (activeNotifiers.isEmpty()) {
            log.warn("æ²¡æœ‰å¯ç”¨çš„é€šçŸ¥å™¨ï¼Œé…ç½®é¡¹: {}", enabledNotifiers);
            return;
        }

        // å¹¶å‘å‘é€é€šçŸ¥
        activeNotifiers.parallelStream().forEach(notifier -> {
            boolean success = notifier.sendNotification(entry, report);
            if (!success) {
                log.error("é€šçŸ¥å‘é€å¤±è´¥: {}", notifier.getName());
            }
        });
    }
}
```

### 3.5 é€šçŸ¥å™¨è‡ªåŠ¨æ³¨å†Œ

```java
@Component
public class EmailNotifier implements Notifier {

    @Override
    public String getName() {
        return "email";
    }
}

@Component
public class WebhookNotifier implements Notifier {

    @Override
    public String getName() {
        return "webhook";
    }
}
```

### 3.6 é€šçŸ¥é¢‘ç‡æ§åˆ¶

é˜²æ­¢åŒä¸€é—®é¢˜é¢‘ç¹é€šçŸ¥ï¼š

```java
@Service
public class NotifyService {

    // æœ€è¿‘é€šçŸ¥çš„ SQL æŒ‡çº¹ï¼ˆMD5ï¼‰
    private final ConcurrentHashMap<String, Long> recentNotifiedSql = new ConcurrentHashMap<>();

    @Value("${db-doctor.notify.notify-interval:3600}")  // é»˜è®¤ 1 å°æ—¶
    private long notifyInterval;

    public void sendNotification(SlowLogEntry entry, String report) {
        // 1. è®¡ç®— SQL æŒ‡çº¹ï¼ˆå»é™¤å‚æ•°ï¼‰
        String sqlFingerprint = generateSqlFingerprint(entry.getSql());
        String key = entry.getDatabase() + ":" + sqlFingerprint;

        // 2. æ£€æŸ¥æ˜¯å¦åœ¨é€šçŸ¥é—´éš”å†…
        Long lastNotifyTime = recentNotifiedSql.get(key);
        long now = System.currentTimeMillis();

        if (lastNotifyTime != null && (now - lastNotifyTime) < notifyInterval * 1000) {
            log.debug("è·³è¿‡é‡å¤é€šçŸ¥: {}", key);
            return;
        }

        // 3. å‘é€é€šçŸ¥
        // ... å‘é€é€»è¾‘

        // 4. è®°å½•é€šçŸ¥æ—¶é—´
        recentNotifiedSql.put(key, now);
    }

    /**
     * ç”Ÿæˆ SQL æŒ‡çº¹ï¼ˆå»é™¤å‚æ•°ï¼‰
     */
    private String generateSqlFingerprint(String sql) {
        // ç®€å•å®ç°ï¼šå°†æ•°å­—å’Œå­—ç¬¦ä¸²æ›¿æ¢ä¸º ?
        return sql.replaceAll("\\d+", "?")
                  .replaceAll("'[^']*'", "'?'");
    }
}
```

### 3.7 é€šçŸ¥ä¼˜å…ˆçº§

æ ¹æ®æ…¢æŸ¥è¯¢ä¸¥é‡ç¨‹åº¦åˆ†çº§ï¼š

```java
public enum Severity {
    LOW(3.0),      // 3 ç§’ä»¥ä¸‹
    MEDIUM(5.0),   // 3-5 ç§’
    HIGH(10.0),    // 5-10 ç§’
    CRITICAL(999.0); // 10 ç§’ä»¥ä¸Š

    private final double threshold;

    public static Severity fromQueryTime(double queryTime) {
        if (queryTime < LOW.threshold) return LOW;
        if (queryTime < MEDIUM.threshold) return MEDIUM;
        if (queryTime < HIGH.threshold) return HIGH;
        return CRITICAL;
    }
}

// åœ¨å‘é€é€šçŸ¥æ—¶
if (severity == Severity.LOW) {
    // ä½çº§åˆ«ï¼šä¸å‘é€é€šçŸ¥ï¼Œåªè®°å½•æ—¥å¿—
    log.info("ä½çº§åˆ«æ…¢æŸ¥è¯¢ï¼Œè·³è¿‡é€šçŸ¥");
    return;
}
```

## å››ã€éªŒæ”¶æ ‡å‡†

1. âœ“ Email é€šçŸ¥èƒ½å¤Ÿæ­£å¸¸å‘é€
2. âœ“ Webhookï¼ˆé’‰é’‰/é£ä¹¦ï¼‰é€šçŸ¥èƒ½å¤Ÿæ­£å¸¸å‘é€
3. âœ“ é€šçŸ¥å†…å®¹æ ¼å¼æ­£ç¡®ï¼ˆHTML/Markdownï¼‰
4. âœ“ æ”¯æŒå¤šä¸ªé€šçŸ¥æ¸ é“åŒæ—¶å¯ç”¨
5. âœ“ é€šçŸ¥é¢‘ç‡æ§åˆ¶ç”Ÿæ•ˆ
6. âœ“ é€šçŸ¥å¤±è´¥æœ‰é”™è¯¯æ—¥å¿—

## äº”ã€æµ‹è¯•æ–¹æ³•

### 5.1 Email æµ‹è¯•

1. é…ç½®æµ‹è¯•é‚®ç®±ï¼ˆå¦‚ QQ é‚®ç®± SMTPï¼‰
2. è§¦å‘ä¸€æ¬¡æ…¢æŸ¥è¯¢åˆ†æ
3. æ£€æŸ¥é‚®ç®±æ˜¯å¦æ”¶åˆ°é‚®ä»¶

### 5.2 Webhook æµ‹è¯•

1. é…ç½®é’‰é’‰æœºå™¨äºº Webhook
2. è§¦å‘ä¸€æ¬¡æ…¢æŸ¥è¯¢åˆ†æ
3. æ£€æŸ¥é’‰é’‰ç¾¤æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯

## å…­ã€æ³¨æ„äº‹é¡¹

1. **æ•æ„Ÿä¿¡æ¯**: SQL å¯èƒ½åŒ…å«æ•æ„Ÿæ•°æ®ï¼Œé€šçŸ¥æ—¶éœ€è„±æ•
2. **HTML è½¬ä¹‰**: é‚®ä»¶å†…å®¹éœ€è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦
3. **æ¶ˆæ¯é•¿åº¦**: Webhook æœ‰æ¶ˆæ¯é•¿åº¦é™åˆ¶ï¼ˆé’‰é’‰ 4096 å­—ç¬¦ï¼‰
4. **é‡è¯•æœºåˆ¶**: é€šçŸ¥å¤±è´¥åº”æ”¯æŒé‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
5. **å¼‚æ­¥å‘é€**: é€šçŸ¥å‘é€ä¸åº”é˜»å¡ä¸»æµç¨‹
