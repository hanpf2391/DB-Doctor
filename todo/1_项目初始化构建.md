# DB-Doctor 项目初始化构建

## 一、开发目标

搭建 DB-Doctor 项目的基础架构，包括项目结构、依赖配置和基础配置文件。

## 二、技术要求

- **JDK 版本**: Java 17+
- **构建工具**: Maven 3.8+
- **核心框架**: Spring Boot 3.x
- **打包方式**: Maven Assembly Plugin

## 三、详细开发任务

### 3.1 创建项目结构

按照以下标准 Maven 项目结构创建目录：

```
db-doctor/
├── pom.xml                                          # Maven 配置文件
├── src/
│   ├── main/
│   │   ├── java/com/dbdoctor/
│   │   │   ├── DbDoctorApplication.java             # 启动类
│   │   │   ├── config/
│   │   │   │   ├── AiConfig.java                    # LangChain4j 配置
│   │   │   │   └── ThreadPoolConfig.java            # 线程池配置
│   │   │   ├── service/
│   │   │   │   ├── LogMonitorService.java           # 日志监听服务
│   │   │   │   ├── AnalysisService.java             # 分析服务
│   │   │   │   └── NotifyService.java               # 通知服务
│   │   │   ├── agent/
│   │   │   │   ├── DBAgent.java                     # AI Agent 接口
│   │   │   │   └── tools/
│   │   │   │       └── SqlDiagnosticsTools.java     # SQL 诊断工具
│   │   │   └── model/
│   │   │       └── SlowLogEntry.java                # 慢查询实体类
│   │   └── resources/
│   │       └── application.yml                      # 配置文件
│   └── assembly/
│       └── package.xml                              # Assembly 打包配置
└── bin/
    ├── startup.sh                                   # Linux 启动脚本
    └── startup.cmd                                  # Windows 启动脚本
```

### 3.2 配置 pom.xml 依赖

需要在 `pom.xml` 中引入以下依赖：

1. **Spring Boot 相关**
   - spring-boot-starter (核心)
   - spring-boot-starter-web (可选，用于健康检查)
   - spring-boot-starter-mail (邮件通知)

2. **LangChain4j 相关**
   - langchain4j (核心)
   - langchain4j-open-ai (OpenAI 接口)

3. **文件 IO**
   - commons-io (Apache Commons IO，用于 Tailer 文件监听)

4. **数据库相关**
   - druid-spring-boot-starter (连接池)
   - mysql-connector-java (MySQL 驱动)
   - spring-jdbc (JdbcTemplate)

5. **工具类**
   - hutool-all (工具类库)
   - fastjson2 (JSON 处理)

6. **打包插件**
   - maven-assembly-plugin (代码与配置分离打包)

### 3.3 创建基础 Java 类

#### 3.3.1 DbDoctorApplication.java
- 位置: `src/main/java/com/dbdoctor/DbDoctorApplication.java`
- 功能: Spring Boot 启动类
- 注解: `@SpringBootApplication`

#### 3.3.2 SlowLogEntry.java
- 位置: `src/main/java/com/dbdoctor/model/SlowLogEntry.java`
- 功能: 慢查询日志实体类
- 字段:
  - `String time` - 慢查询发生时间
  - `Double queryTime` - 查询耗时（秒）
  - `Long rowsExamined` - 扫描行数
  - `Double lockTime` - 锁等待时间（秒）
  - `String sql` - SQL 语句
  - `String database` - 数据库名

#### 3.3.3 配置类占位符
创建以下配置类的空骨架（后续步骤实现）：
- `AiConfig.java` - LangChain4j 配置
- `ThreadPoolConfig.java` - 线程池配置

### 3.4 创建配置文件

#### 3.4.1 application.yml
位置: `src/main/resources/application.yml`

需包含以下配置项：
- 服务端口
- MySQL 数据源配置（只读模式）
- LangChain4j AI 配置（API Key、模型）
- 日志文件路径配置
- 线程池配置
- 通知配置（邮件/Webhook）

#### 3.4.2 Assembly 打包配置
位置: `src/main/assembly/package.xml`

功能：
- 实现代码与配置分离
- 生成 Nacos 式发布结构
- 将可执行 jar 和配置文件分离放置

### 3.5 创建启动脚本

#### 3.5.1 startup.sh (Linux)
位置: `bin/startup.sh`
- 设置 JAVA_HOME
- 配置 JVM 参数
- 启动应用
- 日志重定向

#### 3.5.2 startup.cmd (Windows)
位置: `bin/startup.cmd`
- 设置 Java 环境变量
- 启动应用
- 日志输出

## 四、验收标准

1. ✓ 项目能够正常编译打包
2. ✓ 执行 `DbDoctorApplication` 能够正常启动
3. ✓ Maven Assembly 能够生成分离的目录结构
4. ✓ 启动脚本能够正常启动应用

## 五、注意事项

1. 确保所有依赖版本兼容 Spring Boot 3.x
2. Assembly 配置要确保配置文件可外部化修改
3. 启动脚本需支持跨平台（Linux/Windows）
