server:
  port: 8080
  # 优雅停机配置
  shutdown: graceful

spring:
  application:
    name: db-doctor
  # 激活的配置文件（local、dev、prod）
  profiles:
    active: local

  # 优雅停机等待时间
  lifecycle:
    timeout-per-shutdown-phase: 60s

  # === H2 主数据源配置 ===
  # 用途：存储 DB-Doctor 自己的数据（分析历史、SQL 指纹等）
  datasource:
    # H2 存文件到当前目录下的 data 文件夹
    url: jdbc:h2:file:./data/db-doctor-internal;DB_CLOSE_DELAY=-1;MODE=MySQL
    driver-class-name: org.h2.Driver
    # 明确指定使用 H2（防止 Spring Boot 自动选择 MySQL）
    type: com.zaxxer.hikari.HikariDataSource

  # JPA 配置 (只针对 H2)
  jpa:
    hibernate:
      ddl-auto: update  # 自动建表
    show-sql: false
    database-platform: org.hibernate.dialect.H2Dialect
    defer-datasource-initialization: true  # 延迟数据源初始化，避免启动失败

  # 邮件配置
  # 注意：邮箱账号密码等敏感信息请在 application-local.yml 中配置
  mail:
    host: smtp.qq.com
    port: 587
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
          ssl:
            enable: false
          connectiontimeout: 5000
          timeout: 3000
          writetimeout: 5000
    default-encoding: UTF-8

# DB-Doctor 项目配置
db-doctor:
  # 项目基本信息
  name: DB-Doctor
  version: 1.0.0
  description: MySQL 慢查询智能诊疗系统

  # === 用户目标数据源配置（MySQL） ===
  # 用途：只读访问用户的 MySQL（查询 slow_log、执行 EXPLAIN）
  # 注意：用户名、密码等敏感信息请在 application-local.yml 中配置
  target-db:
    url: jdbc:mysql://localhost:3306/information_schema?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    driver-class-name: com.mysql.cj.jdbc.Driver
    # username 和 password 在 application-local.yml 中配置

  # === 环境检查配置 ===
  # 用途：项目启动时检查目标 MySQL 的慢查询配置是否符合要求
  env-check:
    # 是否启用环境检查（推荐启用）
    enabled: false
    # 检查失败时是否阻止应用启动（false=只记录警告，true=启动失败）
    fail-on-error: false
    # 是否尝试自动修复问题（需要 SUPER 权限，不推荐）
    auto-fix: false

  # AI 配置
  ai:
    enabled: false  # 设置为 true 启用 AI 功能
    mock-enabled: false  # 【测试模式】启用 Mock AI 模拟耗时
    mock-delay-seconds: 30  # 【测试模式】模拟耗时（秒）
    # 一次分析的最大日志数量（防止过载）
    max-concurrent-analysis: 4

  # 慢查询监控配置
  slow-log-monitor:
    # 轮询间隔（毫秒），默认 60 秒
    poll-interval-ms: 60000
    # 每次最多读取 100 条（分批拉取保护）
    max-records-per-poll: 100
    # 注意：不补发历史数据，游标始终从"当前时间"开始

    # 自动清理配置
    auto-cleanup:
      # 是否启用自动清理（生产环境建议启用）
      enabled: true
      # 清理任务的 cron 表达式（默认每天凌晨 3 点）
      cron-expression: "0 0 3 * * ?"

  # 通知配置
  notify:
    # 启用的通知渠道（email, webhook）
    enabled-notifiers: email,webhook
    # 通知间隔（秒），防止同一问题频繁通知
    notify-interval: 3600
    # 严重程度阈值（低于此值不通知）
    severity-threshold: 3.0

    # 智能通知策略配置
    # 冷却期时间（小时）- 防止频繁通知
    cool-down-hours: 1
    # 性能恶化倍率 - 触发二次唤醒通知（默认 1.5，即耗时增加 50%）
    degradation-multiplier: 1.5
    # 高频异常阈值 - 24小时内的出现次数（默认 100 次）
    high-frequency-threshold: 2

    email:
      enabled: true
      from: DB-Doctor <noreply@example.com>
      to:
        - dba@example.com
        - dev-team@example.com
      cc:
        - manager@example.com

    webhook:
      dingtalk:
        enabled: false
        webhook-url: https://oapi.dingtalk.com/robot/send?access_token=xxx
        secret: SEC***
      feishu:
        enabled: false
        webhook-url: https://open.feishu.cn/open-apis/bot/v2/hook/xxx
      wecom:
        enabled: false
        webhook-url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx

  # PENDING 任务重试配置
  retry:
    # 是否启用 PENDING 补扫
    enabled: true
    # 最大重试次数
    max-attempts: 3
    # 补扫间隔（毫秒），默认 10 分钟
    pending-interval-ms: 600000

  # 优雅停机配置
  shutdown:
    # 等待任务完成的最长时间（秒）
    await-termination-seconds: 50
    # 停机时是否清空队列
    clear-queue-on-shutdown: true

  # 线程池配置
  thread-pool:
    # AI 分析线程池
    ai-analysis:
      core-size: 2
      max-size: 4
      queue-capacity: 50

  # 性能测试配置
  test:
    enabled: false  # 设置为 true 启用性能测试模式
    scenario: all  # 测试场景：single, batch, duplicate, concurrent, shutdown, all

# LangChain4j 配置
# 注意：API Key 等敏感信息请在 application-local.yml 中配置
langchain4j:
  open-ai:
    chat-model:
      model-name: gpt-4
      base-url: https://api.openai.com/v1
      temperature: 0.0
      timeout: 60s
      max-tokens: 2000
      # api-key 在 application-local.yml 中配置

# 日志配置
logging:
  level:
    com.dbdoctor: INFO
    org.springframework.jdbc: WARN
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n'
  file:
    name: logs/db-doctor.log
    max-size: 100MB
    max-history: 30
