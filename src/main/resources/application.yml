server:
  port: 8080
  # 优雅停机配置
  shutdown: graceful

spring:
  application:
    name: db-doctor
  # 激活的配置文件（local、dev、prod）
  profiles:
    active: local

  # 优雅停机等待时间
  lifecycle:
    timeout-per-shutdown-phase: 60s

  # === 缓存配置（支持配置热加载） ===
  cache:
    type: simple  # 使用简单内存缓存（生产环境建议使用 Redis）
    cache-names: system_config  # 配置缓存名称

  # === H2 主数据源配置 ===
  # 用途：存储 DB-Doctor 自己的数据（分析历史、SQL 指纹等）
  datasource:
    # H2 存文件到当前目录下的 data 文件夹
    url: jdbc:h2:file:./data/db-doctor-internal;DB_CLOSE_DELAY=-1;MODE=MySQL
    driver-class-name: org.h2.Driver
    # 明确指定使用 H2（防止 Spring Boot 自动选择 MySQL）
    type: com.zaxxer.hikari.HikariDataSource

  # H2 控制台配置（开发环境）
  h2:
    console:
      enabled: true
      path: /h2-console
      settings:
        web-allow-others: true  # 允许远程访问

  # JPA 配置 (只针对 H2)
  jpa:
    hibernate:
      ddl-auto: update  # 自动建表
    show-sql: false
    database-platform: org.hibernate.dialect.H2Dialect
    defer-datasource-initialization: true  # 延迟数据源初始化，避免启动失败

  # 邮件配置
  # 注意：邮箱账号密码等敏感信息请在 application-local.yml 中配置
  mail:
    host: smtp.qq.com
    port: 587
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
          ssl:
            enable: false
          connectiontimeout: 5000
          timeout: 3000
          writetimeout: 5000
    default-encoding: UTF-8

# DB-Doctor 项目配置
db-doctor:
  # 项目基本信息
  name: DB-Doctor
  version: 3.0.0
  build-time: @maven.build.timestamp@
  description: MySQL 慢查询智能诊疗系统（企业级异常处理）

  # === 认证配置 ===
  auth:
    # 默认用户名（首次登录使用，登录后可在设置中修改）
    default-username: dbdoctor
    # 默认密码（首次登录使用，登录后可在设置中修改）
    default-password: dbdoctor

# Git 信息由 git-commit-id-plugin 自动生成，无需手动配置

  # === 用户目标数据源配置（MySQL） ===
  # 用途：只读访问用户的 MySQL（查询 slow_log、执行 EXPLAIN）
  # 注意：用户名、密码等敏感信息请在 application-local.yml 中配置
  target-db:
    url: jdbc:mysql://localhost:3306/information_schema?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    driver-class-name: com.mysql.cj.jdbc.Driver
    # username 和 password 在 application-local.yml 中配置



  # 慢查询监控配置
  slow-log-monitor:
    # ⚠️ 轮询间隔：自适应调整（不可配置），根据慢查询负载自动调整：
    # - 高负载（>100条/10分钟）: 5秒轮询
    # - 中负载（10-100条/10分钟）: 15秒轮询
    # - 低负载（<10条/10分钟）: 60秒轮询
    # 每次最多读取 100 条（分批拉取保护）
    max-records-per-poll: 100
    # 注意：不补发历史数据，游标始终从"当前时间"开始

    # 自动清理配置
    auto-cleanup:
      # 是否启用自动清理（默认关闭，需手动启用）
      # ⚠️ 注意：默认关闭，避免误操作导致数据丢失
      enabled: false

      # 清理任务的 cron 表达式（默认每天凌晨 3 点）
      # 常用示例：
      # - "0 0 3 * * ?"     每天凌晨 3 点（默认）
      # - "0 0 */6 * * ?"   每 6 小时执行一次
      # - "0 0 4 * * MON"   每周一凌晨 4 点
      # - "0 0 2 1 * ?"     每月 1 号凌晨 2 点
      cron-expression: "0 0 3 * * ?"

      # 是否允许回退到 TRUNCATE 模式（默认禁止）
      # ⚠️ 警告：TRUNCATE 会清空整个表，包括未处理的数据，可能导致数据丢失
      # ✅ 推荐：将 mysql.slow_log 表改为 InnoDB 引擎以支持安全清理
      #
      # 如何改为 InnoDB 引擎（推荐）：
      # SET GLOBAL slow_query_log = 'OFF';
      # ALTER TABLE mysql.slow_log ENGINE = InnoDB;
      # SET GLOBAL slow_query_log = 'ON';
      #
      # 注意事项：
      # 1. 如果 slow_log 表是 InnoDB 引擎，会使用安全的 DELETE WHERE（基于游标）
      # 2. 如果 slow_log 表是 CSV 引擎（MySQL 默认），且 allow-truncate=false，则跳过清理
      # 3. 如果 slow_log 表是 CSV 引擎，且 allow-truncate=true，会使用 TRUNCATE（⚠️ 有数据丢失风险）
      allow-truncate: false

  # 通知配置
  notify:
    # 启用的通知渠道（email, webhook）
    enabled-notifiers: email,webhook
    # 通知间隔（秒），防止同一问题频繁通知
    # 验证范围：60-86400（1分钟-1天）
    notify-interval: 3600
    # 严重程度阈值（低于此值不通知）
    # 验证范围：1.0-10.0
    severity-threshold: 3.0

    # 智能通知策略配置
    # 冷却期时间（小时）- 防止频繁通知
    # 验证范围：1-168（1小时-1周）
    cool-down-hours: 1
    # 性能恶化倍率 - 触发二次唤醒通知（默认 1.5，即耗时增加 50%）
    # 验证范围：1.1-10.0
    degradation-multiplier: 1.5
    # 高频异常阈值 - 24小时内的出现次数（默认 100 次）
    # 验证范围：1-10000
    high-frequency-threshold: 2

    # 定时批量通知配置
    # Cron 表达式：默认每小时执行一次
    # 常用示例：
    # - "0 0 * * * ?"     每小时（默认）
    # - "0 0 */2 * * ?"   每 2 小时
    # - "0 0 9,18 * * ?"  每天 9 点和 18 点
    # - "0 0 9 * * MON"   每周一早上 9 点
    batch-cron: "0 0 * * * ?"

    email:
      enabled: true
      from: DB-Doctor <noreply@example.com>
      to:
        - dba@example.com
        - dev-team@example.com
      cc:
        - manager@example.com

    webhook:
      dingtalk:
        enabled: false
        webhook-url: https://oapi.dingtalk.com/robot/send?access_token=xxx
        secret: SEC***
      feishu:
        enabled: false
        webhook-url: https://open.feishu.cn/open-apis/bot/v2/hook/xxx
      wecom:
        enabled: false
        webhook-url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx

  # PENDING 任务重试配置
  retry:
    # 是否启用 PENDING 补扫
    enabled: true
    # 最大重试次数
    # 验证范围：1-10
    max-attempts: 3
    # 补扫间隔（毫秒），默认 10 分钟
    # 验证范围：1000-3600000（1秒-1小时）
    pending-interval-ms: 600000

  # 优雅停机配置
  shutdown:
    # 等待任务完成的最长时间（秒）
    # 验证范围：1-300（1秒-5分钟）
    await-termination-seconds: 50
    # 停机时是否清空队列
    clear-queue-on-shutdown: true

  # 线程池配置
  thread-pool:
    # AI 分析线程池（IO 密集型任务推荐配置）
    ai-analysis:
      # 核心线程数：保持常驻线程（建议值为 CPU 核心数）
      # 验证范围：1-64
      core-size: 4
      # 最大线程数：峰值时可扩展（建议值为 CPU 核心数 * 4）
      # 验证范围：1-256
      max-size: 16
      # 队列容量：缓冲突发任务（建议值 100-200）
      # 验证范围：10-10000
      queue-capacity: 200

  # === v2.3.0 AI 监控配置 ===
  # 监控配置
  monitoring:
    # 是否启用 AI 监控
    # 验证范围：true/false
    enabled: true

    # 是否存储提示词和响应（调试用，会占用大量存储空间）
    # 验证范围：true/false
    # ⚠️ 警告：启用后会产生大量数据，建议仅在调试时开启
    save-prompt-response: false

    # 数据保留天数（默认 90 天）
    # 验证范围：1-365
    retention-days: 90

    # 成本计算配置
    cost-calculation:
      # 是否启用成本计算
      # 验证范围：true/false
      enabled: false

      # 各模型的 Token 单价（元/1K tokens）- 旧配置（保留兼容性）
      prices:
        qwen2.5:7b: 0.0      # 本地模型，免费
        qwen2.5:14b: 0.0     # 本地模型，免费
        deepseek-r1: 0.001   # DeepSeek 价格
        gpt-4: 0.03          # GPT-4 价格
        gpt-3.5-turbo: 0.002 # GPT-3.5 价格

  # === v3.0 企业级异常处理配置 ===
  # 熔断器配置
  circuit-breaker:
    # 连续失败多少次触发熔断
    # 验证范围：1-10
    failure-threshold: 3
    # 熔断持续时间（秒）
    # 验证范围：10-600
    timeout-seconds: 60
    # 半开状态最多允许的调用次数（用于试探性调用）
    # 验证范围：1-5
    half-open-max-calls: 1
    # 无错误后多久重置计数器（秒）
    # 验证范围：60-3600
    reset-timeout-seconds: 300

  # 性能测试配置
  test:
    enabled: false  # 设置为 true 启用性能测试模式
    scenario: all  # 测试场景：single, batch, duplicate, concurrent, shutdown, all

# LangChain4j 配置
# 注意：API Key 等敏感信息请在 application-local.yml 中配置
langchain4j:
  open-ai:
    chat-model:
      model-name: gpt-4
      base-url: https://api.openai.com/v1
      temperature: 0.0
      timeout: 60s
      max-tokens: 2000
      # api-key 在 application-local.yml 中配置

# 日志配置
logging:
  level:
    com.dbdoctor: INFO
    org.springframework.jdbc: WARN
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n'
  file:
    name: logs/db-doctor.log
    max-size: 100MB
    max-history: 30
